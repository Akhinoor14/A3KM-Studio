<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="description" content="Browse SOLIDWORKS Files by Md Akhinoor Islam - Portfolio presented by A3KM Studio" />
  <title>Browse Files - Md Akhinoor Islam | SOLIDWORKS Portfolio</title>
  <link rel="icon" href="../images/favicon.svg" type="image/svg+xml" />
  
  <link rel="stylesheet" href="../Optimization /styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/github-dark.min.css">
  <link rel="stylesheet" href="../Optimization /mobile-clean.css" />
  <link rel="stylesheet" href="../shared/model-viewer.css" />
  <link rel="stylesheet" href="browse-git-files-mobile.css" />
  <!-- Backend removed - using direct token system -->
  
  <style>
    /* Performance optimizations for Browse Files */
    body {
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }
    
    .browse-header {
      will-change: transform;
      transform: translateZ(0);
    }
    
    .browse-content {
      contain: layout style paint;
    }
    
    /* 3D Preview optimizations */
    .browse-3d-preview-container,
    .lazy-3d-browse {
      will-change: transform;
      transform: translateZ(0);
      contain: layout style paint;
    }
    
    .browse-item {
      contain: layout style;
    }
    
    /* Smooth transitions */
    .browse-3d-overlay {
      transition: opacity 0.3s ease;
    }
    
    /* Touch optimization */
    .browse-back-btn,
    .browse-action-btn,
    .browse-3d-btn {
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    
    /* Prevent layout shift during 3D load */
    .browse-3d-preview-wrapper {
      min-height: 200px;
    }
  </style>
</head>
<body>

  <!-- Backend Status Bar (Compact for browse view) -->
  <div class="browse-backend-status" id="browse-backend-status">
    <div class="status-compact">
      <i class="fas fa-key"></i>
      <span>Frontend Token System Active</span>
    </div>
  </div>

  <header class="browse-header">
    <button class="browse-back-btn" onclick="navigateBack()">
      <i class="fas fa-arrow-left"></i>
    </button>
    <div class="browse-header-info">
      <div class="browse-header-title">
        <span class="browse-icon">üìÅ</span>
        <span>Browse Files</span>
      </div>
      <div class="browse-header-subtitle" id="repo-subtitle">Akhinoor14/SOLIDWORKS-Projects</div>
    </div>
  </header>

  <main class="browse-content">
    
    <!-- Top Action Bar -->
    <div class="browse-action-bar">
      <button class="browse-action-btn" id="github-open-btn" onclick="window.open('https://github.com/Akhinoor14/SOLIDWORKS-Projects', '_blank')">
        <i class="fab fa-github"></i> Open in GitHub
      </button>
      <button class="browse-action-btn" onclick="location.reload()">
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
    </div>

    <!-- Backend Proxy Status -->
    <div class="browse-proxy-status">
      <i class="fas fa-shield-alt"></i>
      <span>Secure Connection</span>
    </div>

    <!-- Search Bar -->
    <div class="browse-search-bar">
      <i class="fas fa-search"></i>
      <input type="text" id="search-input" placeholder="Search files..." />
      <button id="clear-search" style="display: none;">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <!-- Breadcrumbs Navigation -->
    <div class="browse-breadcrumbs" id="breadcrumbs">
      <i class="fas fa-folder-open"></i>
      <span class="breadcrumb" data-path="">Repository Files</span>
    </div>
    
    <!-- Files Grid -->
    <div id="browse-files-grid">
      <div class="browse-loading">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Loading files...</p>
      </div>
      </div>
    </div>
    
  </main>

  <!-- Preview Modal (Full-Screen) -->
  <div id="preview-modal" class="browse-preview-modal" style="display: none;">
    <div class="preview-header" id="preview-header">
      <button class="preview-back-btn" onclick="closePreview()">
        <i class="fas fa-arrow-left"></i>
      </button>
      <div class="preview-filename" id="preview-filename">File Preview</div>
      <button class="preview-fullscreen-btn" onclick="toggleFullscreenMode()" title="Fullscreen Reading Mode">
        <i class="fas fa-expand"></i>
      </button>
      <button class="preview-menu-btn" onclick="togglePreviewMenu()">
        <i class="fas fa-ellipsis-v"></i>
      </button>
    </div>

    <div class="preview-content" id="preview-content">
      <div class="preview-loading">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Loading preview...</p>
      </div>
    </div>

    <div class="preview-footer" id="preview-footer">
      <button class="preview-action-btn" onclick="viewRawFile()">
        <i class="fas fa-file-code"></i> View Raw
      </button>
      <button class="preview-action-btn" onclick="downloadFile()">
        <i class="fas fa-download"></i> Download
      </button>
      <button class="preview-action-btn" onclick="shareFile()">
        <i class="fas fa-share-alt"></i> Share
      </button>
    </div>
  </div>

  <!-- External Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/marked@11.0.0/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script src="../Optimization /github-proxy-config.js"></script>
  <script src="../Optimization /github-fetch-patch.js"></script>
  <script src="../Optimization /realtime-github-sync.js"></script>
  <!-- Backend removed - using direct token system -->
  
  <script>
    console.log('üìÅ Browse Files Mobile - Page Loaded');
    
    // Verify Frontend Token System
    if (typeof getNextToken === 'function' && typeof GITHUB_DIRECT_TOKENS !== 'undefined') {
      console.log('‚úÖ Frontend Token System Active');
      console.log(`üîë Available Tokens: ${GITHUB_DIRECT_TOKENS.length}`);
      
      // Update status bar
      const statusBar = document.getElementById('browse-backend-status');
      if (statusBar) {
        statusBar.innerHTML = `
          <div class="status-compact" style="background: linear-gradient(135deg, rgba(0, 150, 136, 0.2), rgba(0, 100, 90, 0.15)); border-color: rgba(0, 150, 136, 0.4); color: #4db6ac;">
            <i class="fas fa-key" style="color: #4db6ac;"></i>
            <span>Token System: ${GITHUB_DIRECT_TOKENS.length} Active</span>
          </div>
        `;
      }
    } else {
      console.warn('‚ö†Ô∏è Frontend Token System Not Loaded');
      const statusBar = document.getElementById('browse-backend-status');
      if (statusBar) {
        statusBar.innerHTML = `
          <div class="status-compact" style="background: linear-gradient(135deg, rgba(255, 152, 0, 0.2), rgba(200, 120, 0, 0.15)); border-color: rgba(255, 152, 0, 0.4); color: #ffb74d;">
            <i class="fas fa-exclamation-triangle" style="color: #ffb74d;"></i>
            <span>Token System Loading...</span>
          </div>
        `;
      }
    }
    
    // Get repo and path from URL parameters (for Arduino support)
  const urlParams = new URLSearchParams(window.location.search);
  const repoParam = urlParams.get('repo') || 'SOLIDWORKS-Projects';
  const ownerParam = urlParams.get('owner') || 'Akhinoor14';
    const initialPath = urlParams.get('path') || '';
    const initialFile = urlParams.get('file') || '';
    
  const owner = ownerParam;
    const repo = repoParam;
    let currentPath = initialPath;
    let allItems = [];
    let pathHistory = initialPath ? initialPath.split('/').filter(p => p) : [''];
    if (pathHistory[0] !== '') pathHistory.unshift('');
    
    // Update UI for current repo
    console.log(`üîß Current repo: ${owner}/${repo}`);
    document.getElementById('repo-subtitle').textContent = `${owner}/${repo}`;
    document.getElementById('github-open-btn').setAttribute('onclick', `window.open('https://github.com/${owner}/${repo}', '_blank')`);
    
    // Restore state on page load
    function restoreState() {
      try {
        const savedState = sessionStorage.getItem('browseFilesState');
        if (savedState) {
          const state = JSON.parse(savedState);
          
          // Check if state is recent (within 1 hour)
          const timeDiff = Date.now() - state.timestamp;
          if (timeDiff < 3600000) { // 1 hour
            console.log('üîÑ Restoring preview state:', state.previewFile.name);
            
            // Show restoring indicator
            const grid = document.getElementById('browse-files-grid');
            grid.innerHTML = `
              <div class="browse-loading">
                <i class="fas fa-history"></i>
                <p>Restoring previous view...</p>
              </div>
            `;
            
            // Restore path
            currentPath = state.currentPath;
            pathHistory = state.currentPath.split('/').filter(p => p);
            pathHistory.unshift('');
            
            // Load contents then open preview
            loadRepoContents(state.currentPath).then(() => {
              setTimeout(() => {
                openPreviewModal(state.previewFile);
              }, 300);
            });
            
            return true;
          } else {
            // State too old, clear it
            sessionStorage.removeItem('browseFilesState');
          }
        }
      } catch (error) {
        console.error('Error restoring state:', error);
        sessionStorage.removeItem('browseFilesState');
      }
      return false;
    }
    
    function navigateBack() {
      if (pathHistory.length > 1) {
        pathHistory.pop();
        currentPath = pathHistory[pathHistory.length - 1];
        loadRepoContents(currentPath);
      } else {
        // Navigate back to appropriate portal page based on repo
        const portalMap = {
          'SOLIDWORKS-Projects': 'solidworks-mobile.html',
          'Tinkercad-basic-Projects-Using-Arduino-Uno': 'arduino-mobile.html',
          'TinkerCad-projects': 'arduino-mobile.html',
          'Electronic-Components-': 'electronics-mobile.html',
          'Interactive-Portfolio-Website': 'portfolio-mobile.html'
        };
        const portalPage = portalMap[repo] || 'projects.html';
        console.log(`‚¨ÖÔ∏è Navigating back to: ${portalPage}`);
        window.location.href = portalPage;
      }
    }
    
    async function loadRepoContents(path = '') {
      const grid = document.getElementById('browse-files-grid');
      currentPath = path;
      
      grid.innerHTML = `
        <div class="browse-loading">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Loading files...</p>
        </div>
      `;
      
      try {
        console.log(`üîç Loading: ${owner}/${repo}/${path}`);
        console.log(`üîß Frontend Token System: ${typeof getNextToken !== 'undefined' ? 'ACTIVE ‚úÖ' : 'MISSING ‚ùå'}`);
        
        // Ensure path doesn't have leading/trailing slashes
        const cleanPath = path.replace(/^\/+|\/+$/g, '');
        const url = `https://api.github.com/repos/${owner}/${repo}/contents/${cleanPath}`;
        
        console.log(`üåê Fetching: ${url}`);
        
        // Use frontend token system directly
        const token = typeof getNextToken === 'function' ? getNextToken() : null;
        const headers = {};
        if (token) {
          headers['Authorization'] = `token ${token}`;
          console.log(`üîë Using frontend token for authentication`);
        }
        
        const response = await fetch(url, { headers });
        
        console.log(`üì° Response status: ${response.status}`);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('‚ùå Response error:', errorText);
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!Array.isArray(data)) {
          console.error('‚ùå Unexpected response format:', data);
          throw new Error('Invalid response format from GitHub API');
        }
        
        console.log(`‚úÖ Loaded ${data.length} items from ${cleanPath || 'root'}`);
        
        allItems = data;
        displayFileTree(allItems);
        updateBreadcrumbs();
        
      } catch (error) {
        console.error('‚ùå Load error:', error);
        console.error('‚ùå Error details:', {
          owner,
          repo,
          path,
          message: error.message
        });
        
        grid.innerHTML = `
          <div class="browse-error">
            <i class="fas fa-exclamation-triangle"></i>
            <p>Failed to load files</p>
            <p class="error-details">Repo: ${owner}/${repo}<br>Path: ${path || 'root'}<br>Error: ${error.message}</p>
            <button class="browse-retry-btn" onclick="loadRepoContents('${path}')">
              <i class="fas fa-redo"></i> Retry
            </button>
          </div>
        `;
      }
    }
    
    function displayFileTree(items) {
      const grid = document.getElementById('browse-files-grid');
      
      const folders = items.filter(item => item.type === 'dir');
      const files = items.filter(item => item.type === 'file');
      
      let html = '<div class="browse-items-list">';
      
      folders.forEach(folder => {
        html += `
          <div class="browse-item browse-folder" data-path="${folder.path}">
            <div class="browse-item-icon folder">üìÅ</div>
            <div class="browse-item-info">
              <h3 class="browse-item-name">${folder.name}</h3>
              <p class="browse-item-type">Folder</p>
            </div>
            <i class="fas fa-chevron-right"></i>
          </div>
        `;
      });
      
      files.forEach(file => {
        const is3D = /\.(glb|gltf)$/i.test(file.name);
        const icon = getFileIcon(file.name);
        const size = formatSize(file.size);
        
        if (is3D) {
          // 3D File with embedded preview (Lazy Loading)
          const escapedName = file.name.replace(/'/g, "\\'");
          html += `
            <div class="browse-item browse-file browse-3d-file" 
                 data-name="${file.name}"
                 data-path="${file.path}"
                 data-url="${file.download_url}"
                 data-html-url="${file.html_url}"
                 data-size="${file.size}">
              <div class="browse-3d-preview-wrapper">
                <div class="browse-3d-preview-container lazy-3d-browse" 
                     data-model-src="${file.download_url}" 
                     data-model-title="${escapedName}"
                     style="position: relative; background: rgba(0,0,0,0.5); min-height: 200px; display: flex; align-items: center; justify-content: center; border-radius: 12px; overflow: hidden; cursor: pointer;">
                  <div class="preview-placeholder" style="position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; color: rgba(255,255,255,0.5);">
                    <i class="fas fa-cube" style="font-size: 3rem; margin-bottom: 12px; opacity: 0.5;"></i>
                    <span style="font-size: 0.9rem; font-weight: 600;">Tap to preview 3D model</span>
                  </div>
                </div>
              </div>
              <div class="browse-item-info">
                <span class="browse-3d-badge">üé® 3D MODEL</span>
                <h3 class="browse-item-name">${file.name}</h3>
                <p class="browse-item-type">${size}</p>
              </div>
              <div class="browse-3d-actions">
                <a href="${file.download_url}" download class="browse-3d-btn download" onclick="event.stopPropagation()">
                  <i class="fas fa-download"></i>
                </a>
                <a href="${file.html_url}" target="_blank" class="browse-3d-btn github" onclick="event.stopPropagation()">
                  <i class="fab fa-github"></i>
                </a>
              </div>
            </div>
          `;
        } else {
          // Regular file
          html += `
            <div class="browse-item browse-file" 
                 data-name="${file.name}"
                 data-path="${file.path}"
                 data-url="${file.download_url}"
                 data-html-url="${file.html_url}"
                 data-size="${file.size}">
              <div class="browse-item-icon file">${icon}</div>
              <div class="browse-item-info">
                <h3 class="browse-item-name">${file.name}</h3>
                <p class="browse-item-type">${size}</p>
              </div>
              <i class="fas fa-eye"></i>
            </div>
          `;
        }
      });
      
      html += '</div>';
      grid.innerHTML = html;
      
      document.querySelectorAll('.browse-folder').forEach(folder => {
        folder.addEventListener('click', () => {
          const path = folder.dataset.path;
          pathHistory.push(path);
          
          // Clear preview state when navigating to folder
          sessionStorage.removeItem('browseFilesState');
          
          loadRepoContents(path);
        });
      });
      
      document.querySelectorAll('.browse-file').forEach(file => {
        file.addEventListener('click', () => {
          const fileData = {
            name: file.dataset.name,
            path: file.dataset.path,
            url: file.dataset.url,
            htmlUrl: file.dataset.htmlUrl,
            size: file.dataset.size
          };
          openPreviewModal(fileData);
        });
      });
    }
    
    function updateBreadcrumbs() {
      const breadcrumbs = document.getElementById('breadcrumbs');
      const parts = currentPath ? currentPath.split('/') : [];
      
      let html = '<i class="fas fa-folder-open"></i> <span class="breadcrumb" data-path="">Repository Files</span>';
      
      let path = '';
      parts.forEach((part, index) => {
        path += (index > 0 ? '/' : '') + part;
        html += ` <i class="fas fa-chevron-right"></i> <span class="breadcrumb" data-path="${path}">${part}</span>`;
      });
      
      breadcrumbs.innerHTML = html;
      
      document.querySelectorAll('.breadcrumb').forEach(crumb => {
        crumb.addEventListener('click', () => {
          const path = crumb.dataset.path;
          const index = pathHistory.indexOf(path);
          if (index !== -1) {
            pathHistory = pathHistory.slice(0, index + 1);
          } else {
            pathHistory.push(path);
          }
          loadRepoContents(path);
        });
      });
    }
    
    function getFileIcon(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      if (['sldprt', 'sldasm', 'slddrw'].includes(ext)) return 'üîß';
      if (['pdf'].includes(ext)) return 'üìÑ';
      if (['jpg', 'jpeg', 'png', 'gif', 'svg'].includes(ext)) return 'üñºÔ∏è';
      if (['txt', 'md'].includes(ext)) return 'üìù';
      if (['zip', 'rar', '7z'].includes(ext)) return 'üì¶';
      return 'üìÑ';
    }
    
    function formatSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
    
    // Search functionality
    const searchInput = document.getElementById('search-input');
    const clearBtn = document.getElementById('clear-search');
    
    searchInput.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase().trim();
      clearBtn.style.display = query ? 'flex' : 'none';
      
      if (query) {
        const filtered = allItems.filter(item => 
          item.name.toLowerCase().includes(query)
        );
        displayFileTree(filtered);
      } else {
        displayFileTree(allItems);
      }
    });
    
    clearBtn.addEventListener('click', () => {
      searchInput.value = '';
      clearBtn.style.display = 'none';
      displayFileTree(allItems);
    });
    
    // ============================================
    // PREVIEW MODAL SYSTEM
    // ============================================
    
    let currentPreviewFile = null;
    let zoomLevel = 1;
    let touchStartDistance = 0;
    let initialPinchDistance = 0;
    
    function openPreviewModal(fileData) {
      currentPreviewFile = fileData;
      const modal = document.getElementById('preview-modal');
      const filenameEl = document.getElementById('preview-filename');
      const contentEl = document.getElementById('preview-content');
      
      // Safety check: ensure elements exist
      if (!modal || !filenameEl || !contentEl) {
        console.error('‚ùå Preview modal elements not found:', {
          modal: !!modal,
          filenameEl: !!filenameEl,
          contentEl: !!contentEl
        });
        return;
      }
      
      // Reset any previous transforms
      modal.style.transform = '';
      modal.style.opacity = '1';
      
      // Set filename
      filenameEl.textContent = fileData.name;
      
      // Update download button text for markdown files
      updateDownloadButtonText(fileData.name);
      
      // Save state to sessionStorage for reload persistence
      sessionStorage.setItem('browseFilesState', JSON.stringify({
        currentPath: currentPath,
        previewFile: fileData,
        timestamp: Date.now()
      }));
      
      // Prevent body scroll first
      document.body.style.overflow = 'hidden';
      
      // Show modal with smooth animation
      modal.style.display = 'flex';
      
      // Force reflow to ensure display:flex is applied
      modal.offsetHeight;
      
      // Add show class for animation (next frame)
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          modal.classList.add('show');
        });
      });
      
      // Load file content after modal is visible (smoother)
      setTimeout(() => {
        loadFilePreview(fileData, contentEl);
      }, 50);
    }
    
    function closePreview() {
      // Exit fullscreen mode if active
      if (isFullscreenMode) {
        exitFullscreenMode();
      }
      
      const modal = document.getElementById('preview-modal');
      const header = document.getElementById('preview-header');
      const footer = document.getElementById('preview-footer');
      const content = document.getElementById('preview-content');
      
      modal.classList.remove('show');
      
      // Clear saved state when manually closing
      sessionStorage.removeItem('browseFilesState');
      
      setTimeout(() => {
        modal.style.display = 'none';
        modal.style.transform = '';
        modal.style.opacity = '1';
        document.body.style.overflow = '';
        currentPreviewFile = null;
        zoomLevel = 1;
        
        // Reset header/footer visibility
        header.style.display = 'flex';
        footer.style.display = 'flex';
        header.style.transform = '';
        header.style.opacity = '1';
        footer.style.transform = '';
        footer.style.opacity = '1';
        
        // Reset content margins
        content.style.marginTop = '60px';
        content.style.marginBottom = '70px';
      }, 400); // Match CSS transition duration
    }
    
    async function loadFilePreview(fileData, contentEl) {
      const ext = fileData.name.split('.').pop().toLowerCase();
      
      contentEl.innerHTML = `
        <div class="preview-loading">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Loading preview...</p>
        </div>
      `;
      
      try {
        if (ext === 'pdf') {
          // PDF Preview with PDF.js
          renderPDFPreview(fileData, contentEl);
        } else if (['png', 'jpg', 'jpeg', 'gif', 'svg', 'webp'].includes(ext)) {
          // Image Preview
          renderImagePreview(fileData, contentEl);
        } else if (['md', 'markdown'].includes(ext)) {
          // Markdown Preview
          await renderMarkdownPreview(fileData, contentEl);
        } else if (['ino', 'js', 'html', 'css', 'json', 'py', 'java', 'cpp', 'c', 'h', 'txt', 'sh', 'yml', 'yaml', 'xml'].includes(ext)) {
          // Code Preview with Syntax Highlighting (including Arduino .ino files)
          await renderCodePreview(fileData, contentEl);
        } else if (['sldprt', 'sldasm', 'slddrw', 'step', 'stl'].includes(ext)) {
          // CAD File - Download Prompt
          renderCADPreview(fileData, contentEl);
        } else if (['glb', 'gltf'].includes(ext)) {
          // 3D Model - Embedded Preview
          render3DModelPreview(fileData, contentEl);
        } else {
          // Generic File - Download Option
          renderGenericPreview(fileData, contentEl);
        }
      } catch (error) {
        console.error('Preview error:', error);
        contentEl.innerHTML = `
          <div class="preview-error">
            <i class="fas fa-exclamation-triangle"></i>
            <p>Failed to load preview</p>
            <button class="preview-retry-btn" onclick="loadFilePreview(currentPreviewFile, document.getElementById('preview-content'))">
              <i class="fas fa-redo"></i> Retry
            </button>
          </div>
        `;
      }
    }
    
    // PDF Preview with Datasheet Detection
    function renderPDFPreview(fileData, contentEl) {
      const pdfUrl = encodeURIComponent(fileData.url);
      
      // Detect if PDF is a datasheet
      const isDatasheet = /datasheet|spec|specification|data[\s_-]?sheet/i.test(fileData.name);
      
      contentEl.innerHTML = `
        ${isDatasheet ? `
          <div class="datasheet-notice">
            <i class="fas fa-file-alt"></i>
            <span>Component Datasheet</span>
          </div>
        ` : ''}
        <div class="pdf-viewer-container">
          <iframe 
            src="https://mozilla.github.io/pdf.js/web/viewer.html?file=${pdfUrl}" 
            class="pdf-iframe"
            frameborder="0">
          </iframe>
        </div>
      `;
    }
    
    // Image Preview with Pinch Zoom + Circuit/Schematic Detection
    function renderImagePreview(fileData, contentEl) {
      // Detect if it's a circuit diagram (Arduino - green)
      const isCircuitDiagram = /circuit|diagram|wiring/i.test(fileData.name) && repo.includes('Arduino');
      
      // Detect if it's a schematic (Electronics - orange)
      const isSchematic = /schematic|breadboard|pcb|layout/i.test(fileData.name) && repo.includes('Electronic');
      
      contentEl.innerHTML = `
        ${isCircuitDiagram ? `
          <div class="circuit-diagram-notice">
            <i class="fas fa-microchip"></i>
            <span>Circuit Diagram</span>
          </div>
        ` : ''}
        ${isSchematic ? `
          <div class="schematic-notice">
            <i class="fas fa-project-diagram"></i>
            <span>Circuit Schematic</span>
          </div>
        ` : ''}
        <div class="image-viewer-container" id="image-container">
          <img src="${fileData.url}" alt="${fileData.name}" class="preview-image" id="preview-image">
          <div class="zoom-indicator" id="zoom-indicator">100%</div>
          <div class="image-controls">
            <button class="image-control-btn" onclick="zoomIn()" title="Zoom In">
              <i class="fas fa-search-plus"></i>
            </button>
            <button class="image-control-btn" onclick="zoomOut()" title="Zoom Out">
              <i class="fas fa-search-minus"></i>
            </button>
            <button class="image-control-btn" onclick="resetZoom()" title="Reset">
              <i class="fas fa-undo"></i>
            </button>
          </div>
        </div>
      `;
      
      // Setup pinch-to-zoom
      setupImageZoom();
    }
    
    // Zoom control functions
    let currentScale = 1;
    
    function updateZoomIndicator(zoom) {
      const indicator = document.getElementById('zoom-indicator');
      if (!indicator) return;
      indicator.textContent = Math.round(zoom * 100) + '%';
      indicator.style.opacity = '1';
      setTimeout(() => {
        if (indicator) indicator.style.opacity = '0';
      }, 1000);
    }
    
    function zoomIn() {
      currentScale = Math.min(5, currentScale + 0.5);
      applyZoom();
    }
    function zoomOut() {
      currentScale = Math.max(0.5, currentScale - 0.5);
      applyZoom();
    }
    function resetZoom() {
      currentScale = 1;
      const image = document.getElementById('preview-image');
      if (image) {
        image.style.transform = 'translate(0, 0) scale(1)';
      }
      updateZoomIndicator(1);
    }
    function applyZoom() {
      const image = document.getElementById('preview-image');
      if (image) {
        const currentTransform = image.style.transform;
        const translateMatch = currentTransform.match(/translate\(([^)]+)\)/);
        const translate = translateMatch ? translateMatch[1] : '0px, 0px';
        image.style.transform = `translate(${translate}) scale(${currentScale})`;
      }
      updateZoomIndicator(currentScale);
    }
    
    // Markdown Preview with Tinkercad Detection
    async function renderMarkdownPreview(fileData, contentEl) {
      try {
        // Use frontend token for authenticated request
        const token = typeof getNextToken === 'function' ? getNextToken() : null;
        const headers = {};
        if (token) {
          headers['Authorization'] = `token ${token}`;
        }
        
        const response = await fetch(fileData.url, { headers });
        const markdown = await response.text();
        
        // Detect Tinkercad link in markdown
        const tinkercadMatch = markdown.match(/(?:https?:\/\/)?(?:www\.)?tinkercad\.com\/things\/([a-zA-Z0-9]+)/i);
        const tinkercadProjectId = tinkercadMatch ? tinkercadMatch[1] : null;
        
        // Configure marked.js
        marked.setOptions({
          breaks: true,
          gfm: true,
          headerIds: true,
          mangle: false
        });
        
        const html = marked.parse(markdown);
        
        // Build Tinkercad action bar if link found
        let tinkercadBar = '';
        if (tinkercadProjectId) {
          tinkercadBar = `
            <div class="tinkercad-action-bar">
              <div class="tinkercad-info">
                <i class="fas fa-microchip"></i>
                <span>Tinkercad Project Available</span>
              </div>
              <a href="https://www.tinkercad.com/things/${tinkercadProjectId}" 
                 target="_blank" 
                 class="tinkercad-open-btn">
                <i class="fas fa-external-link-alt"></i> Open in Tinkercad
              </a>
            </div>
          `;
        }
        
        contentEl.innerHTML = `
          ${tinkercadBar}
          <div class="markdown-viewer">
            ${html}
          </div>
        `;
        
        // Apply syntax highlighting to code blocks
        contentEl.querySelectorAll('pre code').forEach((block) => {
          hljs.highlightElement(block);
        });
        
        // Make links open in new tab
        contentEl.querySelectorAll('a').forEach(link => {
          link.setAttribute('target', '_blank');
          link.setAttribute('rel', 'noopener noreferrer');
        });
        
      } catch (error) {
        throw new Error('Failed to load markdown: ' + error.message);
      }
    }
    
    // Code Preview with Syntax Highlighting + Arduino Enhancements
    async function renderCodePreview(fileData, contentEl) {
      try {
        // Use frontend token for authenticated request
        const token = typeof getNextToken === 'function' ? getNextToken() : null;
        const headers = {};
        if (token) {
          headers['Authorization'] = `token ${token}`;
        }
        
        const response = await fetch(fileData.url, { headers });
        const code = await response.text();
        
        const ext = fileData.name.split('.').pop().toLowerCase();
        const languageMap = {
          'ino': 'cpp', // Arduino files use C++ syntax
          'js': 'javascript',
          'py': 'python',
          'cpp': 'cpp',
          'c': 'c',
          'h': 'cpp', // Header files use C++ syntax
          'java': 'java',
          'html': 'html',
          'css': 'css',
          'json': 'json',
          'sh': 'bash',
          'yml': 'yaml',
          'yaml': 'yaml',
          'xml': 'xml',
          'txt': 'plaintext'
        };
        
        const language = languageMap[ext] || 'plaintext';
        const displayLanguage = ext === 'ino' ? 'Arduino' : language;
        const isArduino = ext === 'ino' || ext === 'cpp' || ext === 'h';
        
        // Add line numbers
        const lines = code.split('\n');
        const lineNumbers = lines.map((_, i) => `<span class="line-number">${i + 1}</span>`).join('');
        
        contentEl.innerHTML = `
          <div class="code-viewer ${isArduino ? 'arduino-code' : ''}">
            <div class="code-header">
              <div class="code-info">
                <span class="code-language">${ext === 'ino' ? '‚ö° Arduino' : displayLanguage}</span>
                <span class="code-lines">${lines.length} lines</span>
              </div>
              <div class="code-actions">
                <button class="code-action-btn" onclick="copyCodeToClipboard()" title="Copy code">
                  <i class="fas fa-copy"></i> Copy
                </button>
                <button class="code-action-btn" onclick="downloadFile()" title="Download file">
                  <i class="fas fa-download"></i>
                </button>
              </div>
            </div>
            <div class="code-content-wrapper">
              <div class="line-numbers">${lineNumbers}</div>
              <pre class="code-pre"><code class="language-${language}" id="code-content">${escapeHtml(code)}</code></pre>
            </div>
          </div>
        `;
        
        // Apply syntax highlighting
        contentEl.querySelectorAll('pre code').forEach((block) => {
          hljs.highlightElement(block);
        });
        
      } catch (error) {
        throw new Error('Failed to load code: ' + error.message);
      }
    }
    
    // Copy code to clipboard
    function copyCodeToClipboard() {
      const codeElement = document.getElementById('code-content');
      if (!codeElement) return;
      
      const code = codeElement.textContent;
      navigator.clipboard.writeText(code).then(() => {
        // Show success feedback
        const btn = event.target.closest('.code-action-btn');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
        btn.style.background = 'rgba(76, 175, 80, 0.3)';
        
        setTimeout(() => {
          btn.innerHTML = originalHTML;
          btn.style.background = '';
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy code');
      });
    }
    
    // CAD File Preview
    function renderCADPreview(fileData, contentEl) {
      const ext = fileData.name.split('.').pop().toUpperCase();
      contentEl.innerHTML = `
        <div class="cad-preview">
          <div class="cad-icon">üîß</div>
          <h3>${fileData.name}</h3>
          <p class="cad-type">${ext} File</p>
          <p class="cad-desc">CAD files cannot be previewed in browser</p>
          <button class="preview-download-btn" onclick="downloadFile()">
            <i class="fas fa-download"></i> Download to View in SOLIDWORKS
          </button>
          <p class="cad-size">${formatSize(parseInt(fileData.size))}</p>
        </div>
      `;
    }
    
    // Generic File Preview
    function renderGenericPreview(fileData, contentEl) {
      contentEl.innerHTML = `
        <div class="generic-preview">
          <div class="generic-icon">üìÑ</div>
          <h3>${fileData.name}</h3>
          <p class="generic-desc">Preview not available for this file type</p>
          <button class="preview-download-btn" onclick="downloadFile()">
            <i class="fas fa-download"></i> Download File
          </button>
          <p class="generic-size">${formatSize(parseInt(fileData.size))}</p>
        </div>
      `;
    }
    
    // 3D Model Preview
    function render3DModelPreview(fileData, contentEl) {
      contentEl.innerHTML = `
        <div class="model-preview">
          <model-viewer
            src="${fileData.url}"
            alt="${fileData.name}"
            camera-controls
            autoplay
            style="width:100%; height:400px;"
            loading="lazy"
            reveal="interaction">
          </model-viewer>
          <div class="model-info">
            <h3>${fileData.name}</h3>
            <p>${formatSize(fileData.size)}</p>
          </div>
        </div>
      `;
    }
    
    // Pinch-to-Zoom for Images
    function setupImageZoom() {
      const container = document.getElementById('image-container');
      const image = document.getElementById('preview-image');
      const indicator = document.getElementById('zoom-indicator');
      
      if (!container || !image) {
        console.warn('‚ö†Ô∏è Image zoom setup skipped: container or image not found');
        return;
      }
      
      let scale = 1;
      let posX = 0, posY = 0;
      let startX = 0, startY = 0;
      let isDragging = false;
      
      // Touch events for pinch zoom
      container.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
          // Pinch start
          const touch1 = e.touches[0];
          const touch2 = e.touches[1];
          initialPinchDistance = Math.hypot(
            touch2.clientX - touch1.clientX,
            touch2.clientY - touch1.clientY
          );
          touchStartDistance = initialPinchDistance;
        } else if (e.touches.length === 1 && scale > 1) {
          // Pan start
          isDragging = true;
          startX = e.touches[0].clientX - posX;
          startY = e.touches[0].clientY - posY;
        }
      });
      
      container.addEventListener('touchmove', (e) => {
        e.preventDefault();
        
        if (e.touches.length === 2) {
          // Pinch zoom
          const touch1 = e.touches[0];
          const touch2 = e.touches[1];
          const currentDistance = Math.hypot(
            touch2.clientX - touch1.clientX,
            touch2.clientY - touch1.clientY
          );
          
          const scaleChange = currentDistance / initialPinchDistance;
          scale = Math.max(0.5, Math.min(5, scale * scaleChange));
          initialPinchDistance = currentDistance;
          
          updateImageTransform();
          updateZoomIndicator(scale);
          
        } else if (e.touches.length === 1 && isDragging && scale > 1) {
          // Pan
          posX = e.touches[0].clientX - startX;
          posY = e.touches[0].clientY - startY;
          updateImageTransform();
        }
      });
      
      container.addEventListener('touchend', (e) => {
        if (e.touches.length < 2) {
          initialPinchDistance = 0;
        }
        if (e.touches.length === 0) {
          isDragging = false;
        }
      });
      
      // Double tap to toggle zoom
      let lastTap = 0;
      container.addEventListener('touchend', (e) => {
        const currentTime = new Date().getTime();
        const tapLength = currentTime - lastTap;
        if (tapLength < 300 && tapLength > 0) {
          // Double tap detected
          if (scale === 1) {
            scale = 2;
          } else {
            scale = 1;
            posX = 0;
            posY = 0;
          }
          updateImageTransform();
          updateZoomIndicator(scale);
        }
        lastTap = currentTime;
      });
      
      function updateImageTransform() {
        image.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
      }
      
      // updateZoomIndicator is now a global function (defined above)
    }
    
    // Swipe Down to Close (Only from top 20% of screen when in fullscreen)
    let swipeStartY = 0;
    let swipeCurrentY = 0;
    let canSwipeClose = false;
    
    document.addEventListener('touchstart', (e) => {
      const modal = document.getElementById('preview-modal');
      const previewContent = document.getElementById('preview-content');
      
      if (modal.style.display === 'flex') {
        const isFullscreen = modal.classList.contains('fullscreen-reading-mode');
        
        // If in fullscreen mode, only allow swipe from top 20% of screen
        if (isFullscreen) {
          const touchY = e.touches[0].clientY;
          const screenHeight = window.innerHeight;
          
          if (touchY < screenHeight * 0.2) {
            canSwipeClose = true;
            swipeStartY = touchY;
          }
        } else {
          // Normal mode: Allow swipe from header or when content is scrolled to top
          const isHeader = e.target.closest('.preview-header');
          const isContentTop = previewContent && previewContent.scrollTop === 0;
          
          if (isHeader || (isContentTop && e.touches[0].clientY < 100)) {
            canSwipeClose = true;
            swipeStartY = e.touches[0].clientY;
          }
        }
      }
    });
    
    document.addEventListener('touchmove', (e) => {
      const modal = document.getElementById('preview-modal');
      
      if (modal.style.display === 'flex' && canSwipeClose && swipeStartY > 0) {
        swipeCurrentY = e.touches[0].clientY;
        const diff = swipeCurrentY - swipeStartY;
        
        // Only allow downward swipe
        if (diff > 0 && diff < 200) {
          e.preventDefault(); // Prevent default scroll
          modal.style.transform = `translateY(${diff}px)`;
          modal.style.opacity = 1 - (diff / 400);
        }
      }
    });
    
    document.addEventListener('touchend', () => {
      const modal = document.getElementById('preview-modal');
      
      if (canSwipeClose && swipeStartY > 0) {
        const diff = swipeCurrentY - swipeStartY;
        
        if (diff > 100) {
          // Close modal
          closePreview();
        } else {
          // Reset position
          modal.style.transform = '';
          modal.style.opacity = '1';
        }
        
        canSwipeClose = false;
        swipeStartY = 0;
        swipeCurrentY = 0;
      }
    });
    
    // Footer Actions
    function viewRawFile() {
      if (currentPreviewFile) {
        window.open(currentPreviewFile.url, '_blank');
      }
    }
    
    function updateDownloadButtonText(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      const downloadBtn = document.querySelector('.preview-action-btn[onclick="downloadFile()"]');
      
      if (downloadBtn && (ext === 'md' || ext === 'markdown')) {
        downloadBtn.innerHTML = '<i class="fas fa-file-pdf"></i> Download PDF';
      } else if (downloadBtn) {
        downloadBtn.innerHTML = '<i class="fas fa-download"></i> Download';
      }
    }
    
    function downloadFile() {
      if (!currentPreviewFile) return;
      
      // Check if it's a markdown file
      const ext = currentPreviewFile.name.split('.').pop().toLowerCase();
      
      if (ext === 'md' || ext === 'markdown') {
        // Download as PDF for markdown files
        downloadMarkdownAsPDF();
      } else {
        // Regular download for other files
        const a = document.createElement('a');
        a.href = currentPreviewFile.url;
        a.download = currentPreviewFile.name;
        a.target = '_blank';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }
    }
    
    function downloadMarkdownAsPDF() {
      // Check if html2pdf library is loaded
      if (typeof html2pdf === 'undefined') {
        alert('PDF library not loaded. Please refresh the page and try again.');
        console.error('html2pdf library not found');
        return;
      }
      
      const markdownContent = document.querySelector('.markdown-preview');
      if (!markdownContent) {
        alert('Markdown content not loaded. Please wait...');
        return;
      }
      
      // Additional check: ensure content has text
      const contentText = markdownContent.textContent || '';
      if (contentText.trim().length < 50) {
        alert('Content is too short or not fully loaded. Please wait and try again.');
        console.error('[PDF] Content length:', contentText.length);
        return;
      }
      
      console.log('[PDF] Starting PDF generation, content length:', contentText.length);
      
      // Show loading on download button
      const downloadBtn = document.querySelector('.preview-action-btn');
      const originalHTML = downloadBtn ? downloadBtn.innerHTML : '';
      if (downloadBtn) {
        downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
        downloadBtn.disabled = true;
      }
      
      // Get PDF filename
      const pdfFilename = currentPreviewFile.name.replace(/\.md$/i, '.pdf');
      
      // PDF generation options
      const opt = {
        margin: [10, 10, 10, 10],
        filename: pdfFilename,
        image: { type: 'jpeg', quality: 0.95 },
        html2canvas: { 
          scale: 2,
          useCORS: true,
          letterRendering: true,
          logging: false,
          scrollY: 0,
          scrollX: 0,
          backgroundColor: '#ffffff',
          windowWidth: 800
        },
        jsPDF: { 
          unit: 'mm', 
          format: 'a4', 
          orientation: 'portrait',
          compress: true
        },
        pagebreak: { 
          mode: ['avoid-all', 'css', 'legacy'],
          before: 'h1, h2',
          after: '.page-break-after'
        }
      };
      
      // Clone content for PDF
      const clonedContent = markdownContent.cloneNode(true);
      console.log('[PDF] Content cloned successfully');
      
      // Force black text on white background for PDF
      clonedContent.style.cssText = `
        color: #000 !important;
        background: white !important;
        font-size: 11pt;
        line-height: 1.6;
        padding: 20px;
        visibility: visible !important;
        opacity: 1 !important;
      `;
      
      // Force all text to be visible and black
      clonedContent.querySelectorAll('*').forEach(el => {
        el.style.visibility = 'visible';
        el.style.opacity = '1';
        const currentColor = window.getComputedStyle(el).color;
        // If text is white/light colored, make it black
        if (currentColor === 'rgb(255, 255, 255)' || currentColor.includes('rgba(255, 255, 255') || 
            currentColor === 'rgb(224, 224, 224)' || el.style.color === 'white') {
          el.style.color = '#333 !important';
        }
      });
      
      // Style headings
      clonedContent.querySelectorAll('h1').forEach(h => {
        h.style.cssText = 'color: #ff0000 !important; font-size: 20pt; margin: 20px 0 12px; font-weight: 700;';
      });
      clonedContent.querySelectorAll('h2').forEach(h => {
        h.style.cssText = 'color: #333 !important; font-size: 16pt; margin: 18px 0 10px; font-weight: 700;';
      });
      clonedContent.querySelectorAll('h3, h4, h5, h6').forEach(h => {
        h.style.cssText = 'color: #555 !important; font-size: 13pt; margin: 15px 0 8px; font-weight: 600;';
      });
      
      // Style paragraphs
      clonedContent.querySelectorAll('p').forEach(p => {
        p.style.cssText = 'color: #333 !important; margin: 8px 0; line-height: 1.6;';
      });
      
      // Style code blocks
      clonedContent.querySelectorAll('pre').forEach(pre => {
        pre.style.cssText = 'background: #f5f5f5 !important; border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 4px;';
      });
      clonedContent.querySelectorAll('code').forEach(code => {
        if (!code.parentElement || code.parentElement.tagName !== 'PRE') {
          code.style.cssText = 'background: #f0f0f0 !important; color: #d63384 !important; padding: 2px 6px; border-radius: 3px; font-family: monospace;';
        } else {
          code.style.cssText = 'color: #000 !important; font-family: monospace; font-size: 9pt;';
        }
      });
      
      // Style lists
      clonedContent.querySelectorAll('li').forEach(li => {
        li.style.cssText = 'color: #333 !important; margin: 5px 0;';
      });
      
      console.log('[PDF] Content styled for PDF');
      
      // Add title page
      const titlePage = document.createElement('div');
      titlePage.style.cssText = 'page-break-after: always; text-align: center; padding: 80px 40px; background: white !important; color: #000 !important;';
      titlePage.innerHTML = `
        <h1 style="font-size: 28px; color: #ff0000 !important; margin-bottom: 20px; font-weight: 700;">${currentPreviewFile.name}</h1>
        <p style="font-size: 14px; color: #666 !important; margin-bottom: 10px;">From Repository: ${repo}</p>
        <p style="font-size: 12px; color: #666 !important;">Path: ${currentPreviewFile.path || '/'}</p>
        <p style="font-size: 12px; color: #999 !important; margin-top: 40px;">Generated: ${new Date().toLocaleDateString()}</p>
      `;
      clonedContent.insertBefore(titlePage, clonedContent.firstChild);
      
      console.log('[PDF] Final content structure:', {
        textLength: clonedContent.textContent.length,
        childrenCount: clonedContent.children.length
      });
      console.log('[PDF] Generating PDF...');
      
      // Generate PDF
      html2pdf().set(opt).from(clonedContent).save().then(() => {
        // Restore button
        if (downloadBtn) {
          downloadBtn.innerHTML = originalHTML;
          downloadBtn.disabled = false;
        }
        console.log('‚úÖ PDF downloaded:', pdfFilename);
      }).catch(error => {
        console.error('‚ùå PDF generation failed:', error);
        if (downloadBtn) {
          downloadBtn.innerHTML = originalHTML;
          downloadBtn.disabled = false;
        }
        alert('Failed to generate PDF. Please try again.');
      });
    }
    
    async function shareFile() {
      if (currentPreviewFile) {
        const shareUrl = currentPreviewFile.htmlUrl;
        
        if (navigator.share) {
          // Native share (mobile)
          try {
            await navigator.share({
              title: currentPreviewFile.name,
              text: `Check out ${currentPreviewFile.name}`,
              url: shareUrl
            });
          } catch (err) {
            console.log('Share cancelled');
          }
        } else {
          // Fallback - copy to clipboard
          try {
            await navigator.clipboard.writeText(shareUrl);
            alert('Link copied to clipboard!');
          } catch (err) {
            alert('Share URL: ' + shareUrl);
          }
        }
      }
    }
    
    function togglePreviewMenu() {
      // Optional: Show context menu with more options
      const options = ['View on GitHub', 'Copy Link', 'File Info'];
      // Implementation can be added if needed
    }
    
    // ============================================
    // FULLSCREEN READING MODE
    // ============================================
    
    let isFullscreenMode = false;
    
    function toggleFullscreenMode() {
      isFullscreenMode = !isFullscreenMode;
      
      const modal = document.getElementById('preview-modal');
      const header = document.getElementById('preview-header');
      const footer = document.getElementById('preview-footer');
      const content = document.getElementById('preview-content');
      
      if (isFullscreenMode) {
        // Enter fullscreen mode
        modal.classList.add('fullscreen-reading-mode');
        header.style.transform = 'translateY(-100%)';
        header.style.opacity = '0';
        footer.style.transform = 'translateY(100%)';
        footer.style.opacity = '0';
        
        setTimeout(() => {
          header.style.display = 'none';
          footer.style.display = 'none';
        }, 300);
        
        // Adjust content margins
        content.style.marginTop = '0';
        content.style.marginBottom = '0';
        
        // Show floating exit button
        showFloatingExitButton();
        
        // Add tap to show button listener
        content.addEventListener('click', showExitButtonOnTap);
        
      } else {
        // Exit fullscreen mode
        exitFullscreenMode();
      }
    }
    
    function exitFullscreenMode() {
      if (!isFullscreenMode) return;
      
      isFullscreenMode = false;
      
      const modal = document.getElementById('preview-modal');
      const header = document.getElementById('preview-header');
      const footer = document.getElementById('preview-footer');
      const content = document.getElementById('preview-content');
      
      modal.classList.remove('fullscreen-reading-mode');
      
      // Show header and footer
      header.style.display = 'flex';
      footer.style.display = 'flex';
      
      // Animate back
      setTimeout(() => {
        header.style.transform = 'translateY(0)';
        header.style.opacity = '1';
        footer.style.transform = 'translateY(0)';
        footer.style.opacity = '1';
      }, 10);
      
      // Restore content margins
      content.style.marginTop = '60px';
      content.style.marginBottom = '70px';
      
      // Remove tap listener
      content.removeEventListener('click', showExitButtonOnTap);
      
      // Remove floating button if exists
      const floatingBtn = document.getElementById('fullscreen-exit-btn');
      if (floatingBtn) {
        floatingBtn.remove();
      }
    }
    
    let buttonHideTimeout = null;
    
    function showFloatingExitButton() {
      const content = document.getElementById('preview-content');
      
      // Remove existing button if any
      const existingBtn = document.getElementById('fullscreen-exit-btn');
      if (existingBtn) {
        existingBtn.remove();
      }
      
      // Create floating exit button
      const button = document.createElement('button');
      button.id = 'fullscreen-exit-btn';
      button.className = 'fullscreen-exit-button';
      button.innerHTML = '<i class="fas fa-times"></i> Exit Fullscreen';
      button.onclick = exitFullscreenMode;
      
      content.appendChild(button);
      
      // Show button with slide-down animation
      setTimeout(() => {
        button.style.opacity = '1';
        button.style.transform = 'translateY(0)';
      }, 100);
      
      // Show hint about double-tap (only first time)
      if (!localStorage.getItem('fullscreen-hint-shown')) {
        showDoubleTapHint();
        localStorage.setItem('fullscreen-hint-shown', 'true');
      }
      
      // Auto-hide after 5 seconds
      if (buttonHideTimeout) {
        clearTimeout(buttonHideTimeout);
      }
      
      buttonHideTimeout = setTimeout(() => {
        button.style.opacity = '0';
        button.style.transform = 'translateY(-60px)';
      }, 5000);
    }
    
    function showDoubleTapHint() {
      const content = document.getElementById('preview-content');
      
      const hint = document.createElement('div');
      hint.className = 'double-tap-hint';
      hint.innerHTML = '<i class="fas fa-hand-pointer"></i> Double tap top area to show exit button';
      
      content.appendChild(hint);
      
      setTimeout(() => {
        hint.style.opacity = '1';
      }, 500);
      
      setTimeout(() => {
        hint.style.opacity = '0';
        setTimeout(() => hint.remove(), 300);
      }, 4000);
    }
    
    let lastTapTime = 0;
    
    function showExitButtonOnTap(e) {
      // Ignore if clicking on interactive elements
      if (e.target.tagName === 'A' || 
          e.target.tagName === 'BUTTON' ||
          e.target.tagName === 'INPUT' ||
          e.target.tagName === 'TEXTAREA' ||
          e.target.closest('a') ||
          e.target.closest('button') ||
          e.target.id === 'fullscreen-exit-btn') {
        return;
      }
      
      // Ignore if tapping on PDF viewer iframe
      if (e.target.tagName === 'IFRAME' || e.target.closest('.pdf-viewer-container')) {
        return;
      }
      
      // Ignore if currently zooming/panning an image
      if (e.target.tagName === 'IMG' && e.target.style.transform && e.target.style.transform.includes('scale')) {
        return;
      }
      
      // Only respond to DOUBLE TAP in top 30% of screen (more intentional)
      const currentTime = new Date().getTime();
      const tapDelay = currentTime - lastTapTime;
      const touchY = e.clientY || (e.touches && e.touches[0].clientY);
      const screenHeight = window.innerHeight;
      
      // Must be in top 30% AND double tap within 300ms
      if (touchY < screenHeight * 0.3 && tapDelay < 300 && tapDelay > 0) {
        const button = document.getElementById('fullscreen-exit-btn');
        if (button) {
          // Show button with slide animation
          button.style.opacity = '1';
          button.style.transform = 'translateY(0)';
          
          // Auto-hide after 4 seconds
          if (buttonHideTimeout) {
            clearTimeout(buttonHideTimeout);
          }
          
          buttonHideTimeout = setTimeout(() => {
            button.style.opacity = '0';
            button.style.transform = 'translateY(-60px)';
          }, 4000);
        }
      }
      
      lastTapTime = currentTime;
    }
    
    // Utility: Escape HTML
    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.replace(/[&<>"']/g, m => map[m]);
    }
    
    // ESC key to close preview or exit fullscreen
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const modal = document.getElementById('preview-modal');
        if (modal.style.display === 'flex') {
          if (isFullscreenMode) {
            // Exit fullscreen first
            exitFullscreenMode();
          } else {
            // Close preview
            closePreview();
          }
        }
      }
    });
    
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize compact backend status first
      initBrowseBackendStatus();
      
      // Try to restore previous state first
      const restored = restoreState();
      
      // If no state restored, load from URL params or root
      if (!restored) {
        loadRepoContents(currentPath).then(() => {
          // Auto-open file if specified in URL
          if (initialFile) {
            console.log(`üìÑ Auto-opening file: ${initialFile}`);
            setTimeout(() => {
              const fileCards = document.querySelectorAll('.browse-item.browse-file');
              fileCards.forEach(card => {
                const fileName = card.dataset.name;
                if (fileName === initialFile) {
                  console.log(`‚úÖ Found file card, opening...`);
                  card.click();
                }
              });
            }, 500);
          }
          
          // Initialize lazy 3D loading after content loads
          setTimeout(() => {
            initBrowseLazy3DPreviews();
          }, 100);
        });
      }
    });
    
    // Lazy load 3D previews for Browse Files using Intersection Observer
    function initBrowseLazy3DPreviews() {
      const lazy3DContainers = document.querySelectorAll('.lazy-3d-browse');
      
      if (!lazy3DContainers.length) {
        console.log('üîç No 3D models found in current folder');
        return;
      }
      
      console.log(`üéØ Found ${lazy3DContainers.length} 3D models to lazy load`);
      
      const observerOptions = {
        root: null,
        rootMargin: '150px', // Start loading earlier for smoother UX
        threshold: 0.1
      };
      
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const container = entry.target;
            const modelSrc = container.getAttribute('data-model-src');
            
            // Check if already loaded
            if (container.querySelector('model-viewer')) {
              return;
            }
            
            console.log('üì¶ Loading 3D model:', modelSrc);
            
            // Create model-viewer element
            const modelViewer = document.createElement('model-viewer');
            modelViewer.setAttribute('src', modelSrc);
            modelViewer.setAttribute('alt', '3D Model');
            modelViewer.setAttribute('camera-controls', '');
            modelViewer.setAttribute('disable-zoom', '');
            modelViewer.setAttribute('interaction-prompt', 'none');
            modelViewer.setAttribute('reveal', 'manual');
            modelViewer.style.cssText = 'width: 100%; height: 100%; position: absolute; top: 0; left: 0; --poster-color: transparent;';
            
            // Add overlay
            const overlay = document.createElement('div');
            overlay.className = 'browse-3d-overlay';
            overlay.innerHTML = `
              <i class="fas fa-expand"></i>
              <span>Tap to expand</span>
            `;
            overlay.style.cssText = 'position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; color: #fff; font-size: 0.9rem; font-weight: 600;';
            
            // Show overlay on interaction
            container.addEventListener('mouseenter', () => overlay.style.opacity = '1');
            container.addEventListener('mouseleave', () => overlay.style.opacity = '0');
            container.addEventListener('touchstart', () => overlay.style.opacity = '1', { passive: true });
            
            // Remove placeholder with fade
            const placeholder = container.querySelector('.preview-placeholder');
            if (placeholder) {
              placeholder.style.transition = 'opacity 0.3s ease';
              placeholder.style.opacity = '0';
              setTimeout(() => placeholder.remove(), 300);
            }
            
            // Add to DOM
            container.appendChild(modelViewer);
            container.appendChild(overlay);
            
            // Manually reveal after load
            modelViewer.addEventListener('load', () => {
              console.log('‚úÖ 3D model loaded successfully');
              modelViewer.dismissPoster();
            });
            
            modelViewer.addEventListener('error', (e) => {
              console.error('‚ùå 3D model load failed:', e);
              container.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: rgba(255,100,100,0.8);">
                  <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 8px;"></i>
                  <span style="font-size: 0.85rem;">Failed to load 3D model</span>
                </div>
              `;
            });
            
            // Stop observing this element
            observer.unobserve(container);
          }
        });
      }, observerOptions);
      
      // Observe all lazy 3D containers
      lazy3DContainers.forEach(container => observer.observe(container));
    }
    
    // Handle 3D model viewer clicks for browse files
    function setupBrowse3DHandlers() {
      // Remove old listener if exists
      if (window._browse3DClickHandler) {
        document.removeEventListener('click', window._browse3DClickHandler);
      }
      
      // Create new handler
      window._browse3DClickHandler = function(e) {
        // Check for 3D preview container click
        const container = e.target.closest('.browse-3d-preview-container[data-model-src]');
        if (container) {
          e.preventDefault();
          e.stopPropagation();
          const src = container.getAttribute('data-model-src');
          const title = container.getAttribute('data-model-title') || 'Browse 3D Model';
          if (src && typeof openModelViewer === 'function') {
            openModelViewer({ src, title, ar: true });
          }
          return;
        }
      };
      
      document.addEventListener('click', window._browse3DClickHandler);
      console.log('‚úÖ Browse 3D click handlers set up');
    }
    
    // Re-initialize lazy loading when navigating to different folders
    const originalLoadRepoContents = loadRepoContents;
    loadRepoContents = async function(path) {
      await originalLoadRepoContents(path);
      setTimeout(() => {
        initBrowseLazy3DPreviews();
        setupBrowse3DHandlers();
        console.log('üîÑ Browse 3D system re-initialized for new folder');
      }, 200);
    };
  </script>

  <!-- Add model-viewer library -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  
  <!-- Model viewer modal function -->
  <script src="../shared/model-viewer.js"></script>

</body>
</html>
