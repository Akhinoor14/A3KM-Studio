<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>SOLIDWORKS Projects - Mobile</title>
  <link rel="icon" href="favicon.svg" type="image/svg+xml" />
  
  <!-- Core Styles -->
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- Mobile Styles -->
  <link rel="stylesheet" href="mobile-clean.css" />
  <link rel="stylesheet" href="mobile-navbar.css" />
  
  <style>
    /* Mobile-only page structure */
    body {
      background: linear-gradient(135deg, #0a0a0a 0%, #1a0a0a 100%);
      overflow-x: hidden;
    }
    
    /* Hide desktop navbar */
    .navbar {
      display: none !important;
    }
    
    /* Mobile header */
    .mobile-header {
      position: fixed;
      top: 56px;
      left: 0;
      right: 0;
      height: 60px;
      background: rgba(40, 0, 0, 0.98);
      border-bottom: 2px solid rgba(255, 0, 0, 0.4);
      display: flex;
      align-items: center;
      padding: 0 12px;
      gap: 12px;
      z-index: 999;
      backdrop-filter: blur(15px);
    }
    
    .mobile-back-btn {
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      color: #fff;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .mobile-back-btn:active {
      transform: scale(0.95);
      background: rgba(255, 255, 255, 0.15);
    }
    
    .mobile-header-title {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.1rem;
      font-weight: 700;
      color: #fff;
    }
    
    .mobile-header-icon {
      font-size: 1.5rem;
    }
    
    /* Content area */
    .mobile-content {
      margin-top: 116px;
      padding: 16px;
      padding-bottom: 80px;
      min-height: calc(100vh - 116px);
    }
    
    /* Projects Container - Always Expanded */
    .mobile-projects-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    /* Project Card - Mobile Optimized */
    .mobile-project-card {
      background: linear-gradient(135deg, rgba(204, 0, 0, 0.12), rgba(139, 0, 0, 0.08));
      border: 1.5px solid rgba(204, 0, 0, 0.3);
      border-radius: 16px;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .mobile-project-header {
      padding: 16px;
      background: rgba(204, 0, 0, 0.15);
      border-bottom: 1px solid rgba(204, 0, 0, 0.25);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .mobile-project-icon {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #CC0000, #8B0000);
      border-radius: 12px;
      font-size: 1.5rem;
      box-shadow: 0 4px 12px rgba(204, 0, 0, 0.3);
    }
    
    .mobile-project-info {
      flex: 1;
    }
    
    .mobile-project-name {
      font-size: 1.15rem;
      font-weight: 700;
      color: #fff;
      margin: 0 0 4px 0;
    }
    
    .mobile-project-count {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.65);
    }
    
    /* Models Grid - Always Visible */
    .mobile-models-grid {
      padding: 12px;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    
    /* Model Card */
    .mobile-model-card {
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(204, 0, 0, 0.25);
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .mobile-model-card:active {
      transform: scale(0.97);
      border-color: rgba(204, 0, 0, 0.5);
      box-shadow: 0 4px 16px rgba(204, 0, 0, 0.3);
    }
    
    /* 3D Preview Container */
    .mobile-model-preview {
      position: relative;
      width: 100%;
      height: 140px;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    
    /* Lazy 3D Loader */
    .lazy-3d-mobile {
      width: 100%;
      height: 100%;
      position: relative;
    }
    
    .lazy-3d-mobile model-viewer {
      width: 100%;
      height: 100%;
      --poster-color: transparent;
    }
    
    .lazy-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 8px;
      color: rgba(255, 255, 255, 0.5);
    }
    
    .lazy-placeholder i {
      font-size: 2rem;
      opacity: 0.6;
    }
    
    .lazy-placeholder span {
      font-size: 0.75rem;
    }
    
    /* Model Info */
    .mobile-model-info {
      padding: 10px;
      background: rgba(204, 0, 0, 0.08);
    }
    
    .mobile-model-name {
      font-size: 0.9rem;
      font-weight: 600;
      color: #fff;
      margin: 0 0 4px 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .mobile-model-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.6);
    }
    
    .mobile-model-size {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    /* Loading/Error States */
    .mobile-loading,
    .mobile-error {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
      padding: 60px 20px;
      text-align: center;
      color: rgba(255, 255, 255, 0.7);
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(204, 0, 0, 0.2);
      border-top-color: #CC0000;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .mobile-error i {
      font-size: 3rem;
      color: rgba(255, 100, 100, 0.8);
    }
    
    .retry-btn {
      padding: 10px 24px;
      background: linear-gradient(135deg, #CC0000, #8B0000);
      border: 1px solid rgba(204, 0, 0, 0.4);
      border-radius: 8px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .retry-btn:active {
      transform: scale(0.95);
    }
    
    /* 3D Modal - Full Screen Viewer */
    .mobile-3d-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #000;
      z-index: 10000;
      flex-direction: column;
    }
    
    .mobile-3d-modal.active {
      display: flex;
    }
    
    .mobile-3d-header {
      height: 60px;
      background: rgba(40, 0, 0, 0.98);
      border-bottom: 2px solid rgba(204, 0, 0, 0.4);
      display: flex;
      align-items: center;
      padding: 0 12px;
      gap: 12px;
      backdrop-filter: blur(15px);
    }
    
    .mobile-3d-close,
    .mobile-3d-download {
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      color: #fff;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .mobile-3d-close:active,
    .mobile-3d-download:active {
      transform: scale(0.95);
      background: rgba(255, 255, 255, 0.15);
    }
    
    .mobile-3d-title {
      flex: 1;
      font-size: 1rem;
      font-weight: 600;
      color: #fff;
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .mobile-3d-viewer {
      flex: 1;
      position: relative;
      background: #000;
    }
    
    .mobile-3d-viewer model-viewer {
      width: 100%;
      height: 100%;
      --poster-color: #000;
    }
    
    .mobile-3d-nav {
      height: 70px;
      background: rgba(40, 0, 0, 0.98);
      border-top: 2px solid rgba(204, 0, 0, 0.4);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      gap: 12px;
    }
    
    .mobile-3d-nav-btn {
      padding: 12px 20px;
      background: linear-gradient(135deg, #CC0000, #8B0000);
      border: 1px solid rgba(204, 0, 0, 0.4);
      border-radius: 10px;
      color: #fff;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .mobile-3d-nav-btn:active {
      transform: scale(0.95);
      background: linear-gradient(135deg, #8B0000, #660000);
    }
    
    .mobile-3d-nav-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    .mobile-3d-counter {
      font-weight: 700;
      color: #fff;
      font-size: 0.95rem;
    }
  </style>
</head>
<body>

  <!-- Mobile Navbar Component -->
  <div id="mobileNavbarContainer"></div>
  <script>
    fetch('mobile-navbar.html')
      .then(r => r.text())
      .then(html => {
        document.getElementById('mobileNavbarContainer').innerHTML = html;
      })
      .catch(e => console.error('Failed to load mobile navbar:', e));
  </script>

  <!-- Backend Status Bar -->
  <div id="solidworks-backend-status" style="position: fixed; top: 56px; left: 0; right: 0; z-index: 998;"></div>

  <!-- Mobile Header -->
  <header class="mobile-header">
    <button class="mobile-back-btn" onclick="window.location.href='projects.html'" aria-label="Back to projects">
      <i class="fas fa-arrow-left"></i>
    </button>
    <div class="mobile-header-title">
      <span class="mobile-header-icon">ðŸ”§</span>
      <span>SOLIDWORKS Projects</span>
    </div>
  </header>

  <!-- Main Content -->
  <main class="mobile-content">
    
    <!-- Projects Container - Always Expanded -->
    <div id="projectsContainer" class="mobile-projects-container"></div>
    
    <!-- Loading State -->
    <div id="loadingState" class="mobile-loading">
      <div class="loading-spinner"></div>
      <p>Loading 3D Gallery...</p>
    </div>
    
    <!-- Error State -->
    <div id="errorState" class="mobile-error" style="display: none;">
      <i class="fas fa-exclamation-triangle"></i>
      <p>Failed to load projects</p>
      <button onclick="location.reload()" class="retry-btn">Retry</button>
    </div>
    
  </main>
  
  <!-- 3D Model Viewer Modal -->
  <div id="mobile3DModal" class="mobile-3d-modal">
    <div class="mobile-3d-header">
      <button class="mobile-3d-close" onclick="close3DModal()">
        <i class="fas fa-times"></i>
      </button>
      <h3 id="modal3DTitle" class="mobile-3d-title"></h3>
      <button class="mobile-3d-download" id="modalDownloadBtn">
        <i class="fas fa-download"></i>
      </button>
    </div>
    <div class="mobile-3d-viewer" id="modal3DViewer"></div>
    <div class="mobile-3d-nav">
      <button class="mobile-3d-nav-btn" id="prevModelBtn" onclick="navigateModel(-1)">
        <i class="fas fa-chevron-left"></i> Previous
      </button>
      <span class="mobile-3d-counter" id="modelCounter">1 / 10</span>
      <button class="mobile-3d-nav-btn" id="nextModelBtn" onclick="navigateModel(1)">
        Next <i class="fas fa-chevron-right"></i>
      </button>
    </div>
  </div>

  <!-- Backend Scripts (preserve all backend functionality) -->
  <script src="backend-connection-core.js"></script>
  <script src="backend-status-ui.js"></script>
  <script src="github-proxy-config.js" defer></script>
  <script src="github-fetch-patch.js" defer></script>
  <script src="github-sync.js" defer></script>
  <script src="realtime-github-sync.js" defer></script>
  <script src="auto-refresh.js" defer></script>
  
  <script>
    // Initialize backend connection
    const backendConnection = new BackendConnectionCore({
      backendUrl: 'http://localhost:5000',
      reconnectInterval: 5000,
      healthCheckInterval: 15000,
      maxRetry: Infinity,
      timeout: 10000
    });

    // Initialize status UI
    const backendUI = new BackendStatusUI(backendConnection, 'solidworks-backend-status');

    // Start connection
    backendConnection.start();

    console.log('ðŸ”§ SOLIDWORKS Mobile 3D Gallery Loaded');
    
    // ============================================
    // MOBILE 3D GALLERY - CORE FUNCTIONALITY
    // ============================================
    
    let allProjects = [];
    let currentModalIndex = 0;
    let currentProject = null;
    
    // GitHub Repository Configuration
    const GITHUB_CONFIG = {
      owner: 'Akhinoor14',
      repo: 'SOLIDWORKS-Projects',
      branch: 'main'
    };
    
    // Load all projects from GitHub
    async function loadAllProjects() {
      const container = document.getElementById('projectsContainer');
      const loading = document.getElementById('loadingState');
      const errorState = document.getElementById('errorState');
      
      try {
        // Show loading
        loading.style.display = 'flex';
        
        // Fetch repository tree
        const apiUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/git/trees/${GITHUB_CONFIG.branch}?recursive=1`;
        const response = await fetch(apiUrl);
        
        if (!response.ok) throw new Error('Failed to fetch repository');
        
        const data = await response.json();
        const tree = data.tree;
        
        // Group files by project folders
        const projects = {};
        
        tree.forEach(item => {
          if (item.type === 'blob' && item.path.endsWith('.glb')) {
            const parts = item.path.split('/');
            if (parts.length >= 2) {
              const projectName = parts[0];
              const fileName = parts[parts.length - 1];
              
              if (!projects[projectName]) {
                projects[projectName] = {
                  name: projectName,
                  models: []
                };
              }
              
              projects[projectName].models.push({
                name: fileName.replace('.glb', ''),
                path: item.path,
                size: item.size || 0,
                url: `https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${item.path}`
              });
            }
          }
        });
        
        // Convert to array and sort
        allProjects = Object.values(projects).sort((a, b) => 
          b.models.length - a.models.length
        );
        
        // Hide loading
        loading.style.display = 'none';
        
        if (allProjects.length === 0) {
          errorState.style.display = 'flex';
          errorState.querySelector('p').textContent = 'No projects found';
          return;
        }
        
        // Render projects
        renderProjects();
        
        // Setup lazy loading for 3D previews
        setTimeout(() => setupLazy3DMobile(), 500);
        
      } catch (error) {
        console.error('Error loading projects:', error);
        loading.style.display = 'none';
        errorState.style.display = 'flex';
      }
    }
    
    // Render all projects (always expanded)
    function renderProjects() {
      const container = document.getElementById('projectsContainer');
      container.innerHTML = '';
      
      allProjects.forEach((project, index) => {
        const card = createProjectCard(project, index);
        container.appendChild(card);
      });
    }
    
    // Create project card (always expanded)
    function createProjectCard(project, index) {
      const card = document.createElement('div');
      card.className = 'mobile-project-card';
      
      // Project header
      const header = document.createElement('div');
      header.className = 'mobile-project-header';
      
      const icon = document.createElement('div');
      icon.className = 'mobile-project-icon';
      icon.innerHTML = index === 0 ? 'ðŸŽ“' : index === 1 ? 'ðŸ“š' : 'ðŸ”§';
      
      const info = document.createElement('div');
      info.className = 'mobile-project-info';
      
      const name = document.createElement('h3');
      name.className = 'mobile-project-name';
      name.textContent = project.name.replace(/-/g, ' ');
      
      const count = document.createElement('p');
      count.className = 'mobile-project-count';
      count.textContent = `${project.models.length} Models`;
      
      info.appendChild(name);
      info.appendChild(count);
      header.appendChild(icon);
      header.appendChild(info);
      
      // Models grid (always visible)
      const grid = document.createElement('div');
      grid.className = 'mobile-models-grid';
      
      project.models.forEach((model, modelIndex) => {
        const modelCard = createModelCard(model, project, modelIndex);
        grid.appendChild(modelCard);
      });
      
      card.appendChild(header);
      card.appendChild(grid);
      
      return card;
    }
    
    // Create model card with 3D preview
    function createModelCard(model, project, modelIndex) {
      const card = document.createElement('div');
      card.className = 'mobile-model-card';
      card.onclick = () => open3DModal(model, project, modelIndex);
      
      // 3D Preview
      const preview = document.createElement('div');
      preview.className = 'mobile-model-preview';
      
      const lazy3D = document.createElement('div');
      lazy3D.className = 'lazy-3d-mobile';
      lazy3D.dataset.modelUrl = model.url;
      lazy3D.dataset.loaded = 'false';
      
      const placeholder = document.createElement('div');
      placeholder.className = 'lazy-placeholder';
      placeholder.innerHTML = `
        <i class="fas fa-cube"></i>
        <span>Tap to view</span>
      `;
      
      lazy3D.appendChild(placeholder);
      preview.appendChild(lazy3D);
      
      // Model info
      const info = document.createElement('div');
      info.className = 'mobile-model-info';
      
      const modelName = document.createElement('h4');
      modelName.className = 'mobile-model-name';
      modelName.textContent = model.name;
      
      const meta = document.createElement('div');
      meta.className = 'mobile-model-meta';
      
      const size = document.createElement('span');
      size.className = 'mobile-model-size';
      size.innerHTML = `<i class="fas fa-file"></i> ${formatFileSize(model.size)}`;
      
      meta.appendChild(size);
      info.appendChild(modelName);
      info.appendChild(meta);
      
      card.appendChild(preview);
      card.appendChild(info);
      
      return card;
    }
    
    // Lazy loading for mobile 3D previews
    function setupLazy3DMobile() {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting && entry.target.dataset.loaded === 'false') {
            setTimeout(() => loadLazy3DMobile(entry.target), 150);
          }
        });
      }, {
        rootMargin: '100px',
        threshold: 0.1
      });
      
      document.querySelectorAll('.lazy-3d-mobile').forEach(el => {
        observer.observe(el);
      });
    }
    
    // Load 3D model in preview
    function loadLazy3DMobile(container) {
      const modelUrl = container.dataset.modelUrl;
      container.dataset.loaded = 'true';
      
      const viewer = document.createElement('model-viewer');
      viewer.setAttribute('src', modelUrl);
      viewer.setAttribute('camera-controls', '');
      viewer.setAttribute('auto-rotate', '');
      viewer.setAttribute('auto-rotate-delay', '2000');
      viewer.setAttribute('rotation-per-second', '40deg');
      viewer.setAttribute('loading', 'eager');
      viewer.setAttribute('reveal', 'interaction');
      viewer.setAttribute('shadow-intensity', '0.2');
      viewer.style.width = '100%';
      viewer.style.height = '100%';
      
      container.innerHTML = '';
      container.appendChild(viewer);
    }
    
    // Open 3D modal viewer
    function open3DModal(model, project, modelIndex) {
      currentProject = project;
      currentModalIndex = modelIndex;
      
      const modal = document.getElementById('mobile3DModal');
      const title = document.getElementById('modal3DTitle');
      const viewer = document.getElementById('modal3DViewer');
      const downloadBtn = document.getElementById('modalDownloadBtn');
      
      // Set title
      title.textContent = model.name;
      
      // Create model viewer
      viewer.innerHTML = '';
      const modelViewer = document.createElement('model-viewer');
      modelViewer.setAttribute('src', model.url);
      modelViewer.setAttribute('camera-controls', '');
      modelViewer.setAttribute('auto-rotate', '');
      modelViewer.setAttribute('auto-rotate-delay', '1000');
      modelViewer.setAttribute('rotation-per-second', '30deg');
      modelViewer.setAttribute('touch-action', 'pan-y');
      modelViewer.setAttribute('ar', '');
      modelViewer.setAttribute('ar-modes', 'webxr scene-viewer quick-look');
      modelViewer.setAttribute('shadow-intensity', '1');
      modelViewer.setAttribute('environment-image', 'neutral');
      
      viewer.appendChild(modelViewer);
      
      // Setup download
      downloadBtn.onclick = () => {
        const link = document.createElement('a');
        link.href = model.url;
        link.download = `${model.name}.glb`;
        link.click();
      };
      
      // Update navigation
      updateModalNavigation();
      
      // Show modal
      modal.classList.add('active');
    }
    
    // Close 3D modal
    function close3DModal() {
      const modal = document.getElementById('mobile3DModal');
      const viewer = document.getElementById('modal3DViewer');
      
      // Clean up viewer
      viewer.innerHTML = '';
      
      // Hide modal
      modal.classList.remove('active');
    }
    
    // Navigate between models
    function navigateModel(direction) {
      if (!currentProject) return;
      
      currentModalIndex += direction;
      
      // Wrap around
      if (currentModalIndex < 0) {
        currentModalIndex = currentProject.models.length - 1;
      } else if (currentModalIndex >= currentProject.models.length) {
        currentModalIndex = 0;
      }
      
      const model = currentProject.models[currentModalIndex];
      open3DModal(model, currentProject, currentModalIndex);
    }
    
    // Update modal navigation state
    function updateModalNavigation() {
      const counter = document.getElementById('modelCounter');
      const prevBtn = document.getElementById('prevModelBtn');
      const nextBtn = document.getElementById('nextModelBtn');
      
      if (currentProject) {
        counter.textContent = `${currentModalIndex + 1} / ${currentProject.models.length}`;
        
        prevBtn.disabled = false;
        nextBtn.disabled = false;
      }
    }
    
    // Format file size
    function formatFileSize(bytes) {
      if (bytes === 0) return 'N/A';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
    }
    
    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
      loadAllProjects();
    });
  </script>

  <!-- Google Model Viewer -->
  <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>

</body>
</html>
