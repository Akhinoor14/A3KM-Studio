<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Home Work (HW) - SOLIDWORKS Mobile</title>
  <link rel="icon" href="favicon.svg" type="image/svg+xml" />
  
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="mobile-clean.css" />
  <link rel="stylesheet" href="homework-mobile.css" />
  <link rel="stylesheet" href="shared/model-viewer.css" />
  
  <style>
    body { 
      background: linear-gradient(135deg, #0a0a0a 0%, #1a0f0a 100%); 
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }
    
    .navbar { display: none !important; }
    
    .mobile-header {
      position: fixed; top: 0; left: 0; right: 0; height: 60px;
      background: rgba(60, 30, 0, 0.98); border-bottom: 2px solid rgba(255, 140, 0, 0.4);
      display: flex; align-items: center; padding: 0 12px; gap: 12px; z-index: 1000;
      backdrop-filter: blur(15px);
      will-change: transform;
      transform: translateZ(0);
    }
    
    .mobile-back-btn {
      width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;
      background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%; color: #fff; font-size: 1.2rem; cursor: pointer; transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    
    .mobile-back-btn:active { transform: scale(0.95); }
    
    .mobile-header-title { flex: 1; font-size: 1.1rem; font-weight: 700; color: #fff; }
    
    .mobile-content { 
      margin-top: 60px; 
      padding: 16px; 
      min-height: calc(100vh - 60px);
      contain: layout style paint;
    }
    
    .hw-3d-preview-container,
    .lazy-3d {
      will-change: transform;
      transform: translateZ(0);
      contain: layout style paint;
    }
    
    .hw-file-item {
      contain: layout style;
    }
  </style>
</head>
<body>

  <header class="mobile-header">
    <button class="mobile-back-btn" onclick="window.location.href='solidworks-mobile.html'">
      <i class="fas fa-arrow-left"></i>
    </button>
    <div class="mobile-header-title">
      <span>üìù Home Work (HW)</span>
    </div>
  </header>

  <main class="mobile-content">
    
    <div class="hw-info-card">
      <div class="hw-info-icon">üìù</div>
      <h2 class="hw-info-title">Home Work Assignments</h2>
      <p class="hw-info-desc">Independent practice and projects</p>
    </div>
    
    <button class="hw-github-btn" onclick="window.open('https://github.com/Akhinoor14/SOLIDWORKS-Projects/tree/main/HW', '_blank')">
      <i class="fab fa-github"></i>
      <span>View on GitHub</span>
      <i class="fas fa-external-link-alt"></i>
    </button>
    
    <div id="hw-days-grid">
      <div class="hw-loading">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Loading Home Work days...</p>
      </div>
    </div>
    
  </main>

  <script src="shared/model-viewer.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="github-proxy-config.js"></script>
  <script src="github-fetch-patch.js"></script>
  <script src="github-sync.js"></script>
  <script src="realtime-github-sync.js"></script>
  <script src="auto-refresh.js"></script>
  
  <script>
    console.log('üìù Home Work Mobile Page Loaded');
    
    let expandedDays = new Set();
    let realtimeSync = null;
    
    // Initialize real-time sync system
    if (typeof RealTimeGitHubSync !== 'undefined') {
      realtimeSync = new RealTimeGitHubSync('Akhinoor14', 'SOLIDWORKS-Projects');
      realtimeSync.startRealTimeSync();
      console.log('üîÑ Real-time GitHub sync activated');
      
      window.addEventListener('github-sync-update', () => {
        console.log('üÜï GitHub update detected, reloading...');
        loadHWDays();
      });
    }
    
    async function loadHWDays() {
      const grid = document.getElementById('hw-days-grid');
      
      try {
        const url = 'https://api.github.com/repos/Akhinoor14/SOLIDWORKS-Projects/contents/HW';
        const response = await fetch(url);
        const data = await response.json();
        
        console.log(`‚úÖ Loaded ${data.length} items`);
        
        const days = data.filter(item => item.type === 'dir');
        
        let html = '<div class="hw-days-list">';
        
        // Lazy load - don't fetch summaries upfront
        for (const day of days) {
          html += `
            <div class="hw-day-wrapper" data-day="${day.name}">
              <div class="hw-day-header" data-day="${day.name}">
                <div class="hw-day-header-left">
                  <div class="hw-day-icon">üìù</div>
                  <div class="hw-day-info">
                    <h3 class="hw-day-title">${day.name}</h3>
                    <p class="hw-day-subtitle">Click to view sections</p>
                  </div>
                </div>
                <i class="fas fa-chevron-down hw-expand-icon"></i>
              </div>
              <div class="hw-day-content" data-day="${day.name}" style="display: none;">
                <div class="hw-loading-mini">
                  <i class="fas fa-spinner fa-spin"></i>
                  <span>Loading sections...</span>
                </div>
              </div>
            </div>
          `;
        }
        
        html += '</div>';
        grid.innerHTML = html;
        
        document.querySelectorAll('.hw-day-header').forEach(header => {
          header.addEventListener('click', () => {
            const dayName = header.dataset.day;
            toggleDayExpand(dayName);
          });
        });
        
      } catch (error) {
        console.error('‚ùå Error:', error);
        grid.innerHTML = `
          <div class="hw-error">
            <i class="fas fa-exclamation-triangle"></i>
            <p>Failed to load days</p>
            <button onclick="loadHWDays()">Retry</button>
          </div>
        `;
      }
    }
    
    async function toggleDayExpand(dayName) {
      const wrapper = document.querySelector(`.hw-day-wrapper[data-day="${dayName}"]`);
      if (!wrapper) {
        console.error('Wrapper not found for:', dayName);
        return;
      }
      
      const header = wrapper.querySelector('.hw-day-header');
      const content = wrapper.querySelector('.hw-day-content');
      const icon = header.querySelector('.hw-expand-icon');
      
      if (!content || !icon) {
        console.error('Content or icon not found');
        return;
      }
      
      if (expandedDays.has(dayName)) {
        expandedDays.delete(dayName);
        content.style.display = 'none';
        icon.classList.remove('expanded');
      } else {
        expandedDays.add(dayName);
        content.style.display = 'block';
        icon.classList.add('expanded');
        
        if (content.querySelector('.hw-loading-mini')) {
          await loadDayContent(dayName, content);
        }
      }
    }
    
    async function loadDayContent(dayName, contentDiv) {
      try {
        const url = `https://api.github.com/repos/Akhinoor14/SOLIDWORKS-Projects/contents/HW/${dayName}`;
        const response = await fetch(url);
        const data = await response.json();
        
        const sections = data.filter(item => item.type === 'dir');
        const rootFiles = data.filter(item => item.type === 'file');
        
        let html = '';
        
        // Add ZIP Download Button
        const dayNameEncoded = encodeURIComponent(dayName);
        html += `
          <div class="hw-day-actions" style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
            <button onclick="downloadDayZip('${dayName}', '${url}')" style="flex: 1; min-width: 150px; background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);">
              <i class="fas fa-download"></i>
              <span>Download All (ZIP)</span>
            </button>
            <a href="https://github.com/Akhinoor14/SOLIDWORKS-Projects/tree/main/HW/${dayNameEncoded}" target="_blank" style="flex: 1; min-width: 150px; background: #333; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none;">
              <i class="fab fa-github"></i>
              <span>Open on GitHub</span>
            </a>
          </div>
        `;
        
        // Check for Question/Problem files (PDF, MD, TXT, Images)
        const questionFiles = rootFiles.filter(f => 
          (/\.(pdf|png|jpg|jpeg|md|txt)$/i.test(f.name) && 
          /(question|problem|statement|assignment)/i.test(f.name)) ||
          f.name.toLowerCase().includes('question') ||
          f.name.toLowerCase().includes('problem')
        );
        
        if (questionFiles.length > 0) {
          html += `
            <div class="hw-question-card">
              <div class="hw-question-header">
                <span class="hw-question-icon">üìã</span>
                <div class="hw-question-info">
                  <h4 class="hw-question-title">Questions / Problems</h4>
                  <p class="hw-question-meta">${questionFiles.length} file${questionFiles.length !== 1 ? 's' : ''}</p>
                </div>
              </div>
              <div class="hw-question-files">
          `;
          
          questionFiles.forEach(file => {
            const fileType = getFileType(file.name);
            const fileSize = formatSize(file.size);
            const isPDF = /\.pdf$/i.test(file.name);
            const isImage = /\.(png|jpg|jpeg)$/i.test(file.name);
            const is3D = /\.(glb|gltf)$/i.test(file.name);
            const escapedName = file.name.replace(/'/g, "\\'");
            
            html += `
              <div class="hw-file-item ${is3D ? 'has-3d-preview' : ''}">
                ${is3D ? `
                <div class="hw-3d-preview-container lazy-3d" data-model-src="${file.download_url}" data-model-title="${escapedName}" style="cursor: pointer; position: relative; background: rgba(0,0,0,0.5); min-height: 180px; display: flex; align-items: center; justify-content: center;">
                  <div class="preview-placeholder" style="position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; color: rgba(255,255,255,0.5);">
                    <i class="fas fa-cube" style="font-size: 2rem; margin-bottom: 8px; opacity: 0.5;"></i>
                    <span style="font-size: 0.85rem;">Tap to preview</span>
                  </div>
                </div>
                ` : ''}
                <div class="hw-file-info">
                  <span class="hw-file-badge hw-badge-question">${fileType}</span>
                  <span class="hw-file-name">${file.name}</span>
                  <span class="hw-file-size">${fileSize}</span>
                </div>
                <div class="hw-file-actions">
                  ${is3D ? `<button class="hw-file-btn view" data-model-src="${file.download_url}" data-model-title="${escapedName}" title="View 3D Model">
                    <i class="fas fa-cube"></i>
                  </button>` : ''}
                  ${isPDF ? `<button class="hw-file-btn view" onclick="viewPDF('${file.download_url}', '${escapedName}')">
                    <i class="fas fa-eye"></i>
                  </button>` : ''}
                  ${isImage ? `<button class="hw-file-btn view" onclick="viewImage('${file.download_url}', '${escapedName}')">
                    <i class="fas fa-eye"></i>
                  </button>` : ''}
                  <a href="${file.download_url}" class="hw-file-btn download" download>
                    <i class="fas fa-download"></i>
                  </a>
                  <a href="${file.html_url}" class="hw-file-btn github" target="_blank">
                    <i class="fab fa-github"></i>
                  </a>
                </div>
              </div>
            `;
          });
          
          html += `
              </div>
            </div>
          `;
        }
        
        // Render sections (subfolders) - Parallel fetch for speed
        const sectionPromises = sections.map(section => 
          fetch(section.url).then(r => r.json()).then(data => ({ section, data }))
        );
        
        const sectionResults = await Promise.all(sectionPromises);
        
        for (const { section, data: sectionData } of sectionResults) {
          const files = sectionData.filter(item => item.type === 'file');
          
          html += `
            <div class="hw-section-card">
              <div class="hw-section-header">
                <span class="hw-section-icon">üü•</span>
                <div class="hw-section-info">
                  <h4 class="hw-section-title">${section.name}</h4>
                  <p class="hw-section-meta">${files.length} file${files.length !== 1 ? 's' : ''}</p>
                </div>
              </div>
              <div class="hw-section-files">
          `;
          
          files.forEach(file => {
            const fileType = getFileType(file.name);
            const fileSize = formatSize(file.size);
            const isPDF = /\.pdf$/i.test(file.name);
            const is3D = /\.(glb|gltf)$/i.test(file.name);
            const escapedName = file.name.replace(/'/g, "\\'");
            
            html += `
              <div class="hw-file-item ${is3D ? 'has-3d-preview' : ''}" data-file-type="${is3D ? '3d' : 'file'}">
                ${is3D ? `
                <div class="hw-3d-preview-container lazy-3d" data-model-src="${file.download_url}" data-model-title="${escapedName}" style="cursor: pointer; position: relative; background: rgba(0,0,0,0.5); min-height: 180px; display: flex; align-items: center; justify-content: center;">
                  <div class="preview-placeholder" style="position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; color: rgba(255,255,255,0.5);">
                    <i class="fas fa-cube" style="font-size: 2rem; margin-bottom: 8px; opacity: 0.5;"></i>
                    <span style="font-size: 0.85rem;">Tap to preview</span>
                  </div>
                </div>
                ` : ''}
                <div class="hw-file-info">
                  <span class="hw-file-badge">${fileType}</span>
                  <span class="hw-file-name">${file.name}</span>
                  <span class="hw-file-size">${fileSize}</span>
                </div>
                <div class="hw-file-actions">
                  ${is3D ? `<button class="hw-file-btn view" data-model-src="${file.download_url}" data-model-title="${escapedName}" title="View 3D Model">
                    <i class="fas fa-cube"></i>
                  </button>` : ''}
                  ${isPDF ? `<button class="hw-file-btn view" onclick="viewPDF('${file.download_url}', '${escapedName}')">
                    <i class="fas fa-eye"></i>
                  </button>` : ''}
                  <a href="${file.download_url}" class="hw-file-btn download" download>
                    <i class="fas fa-download"></i>
                  </a>
                  <a href="${file.html_url}" class="hw-file-btn github" target="_blank">
                    <i class="fab fa-github"></i>
                  </a>
                </div>
              </div>
            `;
          });
          
          html += `
              </div>
            </div>
          `;
        }
        
        contentDiv.innerHTML = html;
        
      } catch (error) {
        console.error(`‚ùå Error loading ${dayName}:`, error);
        contentDiv.innerHTML = `
          <div class="hw-error-mini">
            <i class="fas fa-exclamation-triangle"></i>
            <span>Failed to load sections</span>
          </div>
        `;
      }
    }
    
    function getFileType(filename) {
      const ext = filename.split('.').pop().toUpperCase();
      if (ext === 'SLDPRT') return 'SLDPRT';
      if (ext === 'SLDASM') return 'SLDASM';
      if (ext === 'SLDDRW') return 'SLDDRW';
      if (ext === 'GLB') return '3D-GLB';
      if (ext === 'GLTF') return '3D-GLTF';
      if (ext === 'PDF') return 'PDF';
      return ext;
    }
    
    function formatSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
    
    // ZIP Download for Homework Day
    async function downloadDayZip(dayName, dayUrl) {
      try {
        // Show loading
        const loadingDiv = document.createElement('div');
        loadingDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.9);color:#fff;padding:20px 40px;border-radius:10px;z-index:10000;';
        loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating ZIP...';
        document.body.appendChild(loadingDiv);
        
        const zip = new JSZip();
        const response = await fetch(dayUrl);
        const data = await response.json();
        
        // Add all files to zip
        for (const file of data) {
          if (file.type === 'file') {
            const fileResponse = await fetch(file.download_url);
            const blob = await fileResponse.blob();
            zip.file(file.name, blob);
          }
        }
        
        // Generate and download
        const content = await zip.generateAsync({ type: 'blob' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(content);
        link.download = `${dayName}.zip`;
        link.click();
        
        document.body.removeChild(loadingDiv);
      } catch (error) {
        alert('Download failed: ' + error.message);
      }
    }
    
    // PDF Viewer function
    function viewPDF(url, filename) {
      const modal = document.createElement('div');
      modal.className = 'hw-pdf-modal';
      modal.innerHTML = `
        <div class="hw-pdf-overlay" onclick="this.parentElement.remove()"></div>
        <div class="hw-pdf-container">
          <div class="hw-pdf-header">
            <h3>${filename}</h3>
            <button onclick="this.closest('.hw-pdf-modal').remove()">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <iframe src="${url}" class="hw-pdf-viewer"></iframe>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    // Image Viewer function
    function viewImage(url, filename) {
      const modal = document.createElement('div');
      modal.className = 'hw-image-modal';
      modal.innerHTML = `
        <div class="hw-image-overlay" onclick="this.parentElement.remove()"></div>
        <div class="hw-image-container">
          <div class="hw-image-header">
            <h3>${filename}</h3>
            <button onclick="this.closest('.hw-image-modal').remove()">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="hw-image-content">
            <img src="${url}" alt="${filename}">
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    // Lazy load 3D previews using Intersection Observer (OPTIMIZED)
    let lazy3DObserver = null;
    
    function initLazy3DPreviews() {
      // Disconnect previous observer if exists
      if (lazy3DObserver) {
        lazy3DObserver.disconnect();
      }
      
      const lazy3DContainers = document.querySelectorAll('.lazy-3d:not(.loaded)');
      
      if (!lazy3DContainers.length) {
        console.log('üì¶ No 3D previews to load');
        return;
      }
      
      console.log(`üéØ Initializing lazy load for ${lazy3DContainers.length} 3D previews`);
      
      lazy3DObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const container = entry.target;
            
            // Skip if already loaded
            if (container.classList.contains('loaded')) {
              return;
            }
            
            const modelSrc = container.getAttribute('data-model-src');
            if (!modelSrc) return;
            
            console.log('üì¶ Loading 3D preview:', modelSrc);
            
            // Mark as loaded immediately
            container.classList.add('loaded');
            
            // Create minimal model-viewer for preview
            const modelViewer = document.createElement('model-viewer');
            modelViewer.setAttribute('src', modelSrc);
            modelViewer.setAttribute('alt', '3D Model Preview');
            modelViewer.setAttribute('camera-controls', '');
            modelViewer.setAttribute('disable-zoom', '');
            modelViewer.setAttribute('interaction-prompt', 'none');
            modelViewer.setAttribute('loading', 'lazy');
            modelViewer.setAttribute('reveal', 'manual');
            modelViewer.className = 'hw-3d-preview';
            modelViewer.style.cssText = 'width: 100%; height: 100%; position: absolute; top: 0; left: 0;';
            
            // Remove placeholder on load
            modelViewer.addEventListener('load', () => {
              const placeholder = container.querySelector('.preview-placeholder');
              if (placeholder) {
                placeholder.style.transition = 'opacity 0.3s ease';
                placeholder.style.opacity = '0';
                setTimeout(() => placeholder.remove(), 300);
              }
              console.log('‚úÖ 3D preview loaded');
            });
            
            // Handle errors
            modelViewer.addEventListener('error', (e) => {
              console.error('‚ùå 3D preview load error:', e);
              const placeholder = container.querySelector('.preview-placeholder');
              if (placeholder) {
                placeholder.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Load failed</span>';
                placeholder.style.color = '#ff6b6b';
              }
            });
            
            container.appendChild(modelViewer);
            
            // Reveal the model
            setTimeout(() => {
              if (modelViewer.dismissPoster) {
                modelViewer.dismissPoster();
              }
            }, 500);
            
            // Unobserve after loading
            lazy3DObserver.unobserve(container);
          }
        });
      }, {
        root: null,
        rootMargin: '150px',
        threshold: 0.1
      });
      
      // Observe all lazy 3D containers
      lazy3DContainers.forEach(container => {
        lazy3DObserver.observe(container);
      });
    }
    
    // Handle 3D model viewer clicks (delegated event handling)
    function setup3DViewerHandlers() {
      // Remove old listener if exists
      if (window._hw3DClickHandler) {
        document.removeEventListener('click', window._hw3DClickHandler);
      }
      
      // Create new handler
      window._hw3DClickHandler = function(e) {
        // Check for view button click
        const btn = e.target.closest('.hw-file-btn.view[data-model-src]');
        if (btn) {
          e.preventDefault();
          e.stopPropagation();
          
          // Find parent day content to collect all 3D models
          const dayContent = btn.closest('.hw-day-content');
          if (dayContent) {
            const all3DElements = dayContent.querySelectorAll('[data-model-src]');
            const models = Array.from(all3DElements).map(el => ({
              src: el.getAttribute('data-model-src'),
              title: el.getAttribute('data-model-title') || 'Home Work 3D Model'
            }));
            
            const clickedSrc = btn.getAttribute('data-model-src');
            const currentIndex = models.findIndex(m => m.src === clickedSrc);
            
            if (typeof openModelViewer === 'function') {
              openModelViewer({
                src: clickedSrc,
                title: btn.getAttribute('data-model-title') || 'Home Work 3D Model',
                ar: true,
                models: models,
                currentIndex: currentIndex
              });
            }
          }
          return;
        }
        
        // Check for preview container click
        const container = e.target.closest('.hw-3d-preview-container[data-model-src]');
        if (container) {
          e.preventDefault();
          e.stopPropagation();
          
          // Find parent day content to collect all 3D models
          const dayContent = container.closest('.hw-day-content');
          if (dayContent) {
            const all3DElements = dayContent.querySelectorAll('[data-model-src]');
            const models = Array.from(all3DElements).map(el => ({
              src: el.getAttribute('data-model-src'),
              title: el.getAttribute('data-model-title') || 'Home Work 3D Model'
            }));
            
            const clickedSrc = container.getAttribute('data-model-src');
            const currentIndex = models.findIndex(m => m.src === clickedSrc);
            
            if (typeof openModelViewer === 'function') {
              openModelViewer({
                src: clickedSrc,
                title: container.getAttribute('data-model-title') || 'Home Work 3D Model',
                ar: true,
                models: models,
                currentIndex: currentIndex
              });
            }
          }
          return;
        }
      };
      
      document.addEventListener('click', window._hw3DClickHandler);
      console.log('‚úÖ 3D viewer click handlers set up');
    }
    
    const originalLoadHWDays = loadHWDays;
    loadHWDays = async function() {
      await originalLoadHWDays();
      setTimeout(() => {
        initLazy3DPreviews();
        setup3DViewerHandlers();
        console.log('üöÄ HW 3D system initialized');
      }, 200);
    };
    
    document.addEventListener('DOMContentLoaded', loadHWDays);
  </script>

</body>
</html>
