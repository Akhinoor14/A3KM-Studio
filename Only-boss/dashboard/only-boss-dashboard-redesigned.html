<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Only Boss Dashboard - Administrator Control Panel</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Dashboard Specific Styles -->
    <link rel="stylesheet" href="only-boss-dashboard-new.css">
</head>
<body>
    <!-- Single Line Only Boss Header -->
    <div class="only-boss-unified-header">
        <div class="header-container">
            <!-- Left: Portal Logo -->
            <div class="portal-logo">
                <i class="fas fa-crown"></i>
                <span>Only Boss Portal</span>
            </div>
            
            <!-- Center: Dashboard Title + Session Info -->
            <div class="dashboard-info">
                <div class="crown-badge">
                    <i class="fas fa-crown"></i>
                </div>
                <div class="dashboard-text">
                    <h1 class="dashboard-title">Administrator Control Panel</h1>
                    <p class="dashboard-session">Session Active ‚Ä¢ Last Login: <span id="lastLogin">--</span></p>
                </div>
            </div>
            
            <!-- Right: Navigation + Logout -->
            <div class="header-actions">
                <a href="../dashboard/only-boss-dashboard-redesigned.html" class="nav-btn active">
                    <i class="fas fa-th-large"></i>
                    <span>Dashboard</span>
                </a>
                <a href="../../Home/index.html" class="nav-btn home-btn" id="homeLink">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </a>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Dashboard Container -->
    <div class="dashboard-container">
        <!-- Section Header -->
        <div class="section-header">
            <h2><i class="fas fa-tools"></i> Management Tools</h2>
            <p>Centralized control panel for website content and configuration</p>
        </div>

        <!-- Admin Cards Grid -->
        <div class="admin-grid">
            <div class="admin-card" onclick="window.location.href='../managers/Content-studio/upload-interface.html'">
                <i class="fas fa-upload card-icon"></i>
                <h3 class="card-title">Content Upload</h3>
                <p class="card-description">Upload books, videos, papers & posts with auto cover generation</p>
            </div>

            <div class="admin-card" onclick="window.location.href='../managers/certificates/certificates-manager.html'">
                <i class="fas fa-certificate card-icon"></i>
                <h3 class="card-title">Certificates</h3>
                <p class="card-description">Manage academic and professional certifications</p>
            </div>

            <div class="admin-card" onclick="window.location.href='../managers/security/generate-password-hash.html'">
                <i class="fas fa-key card-icon"></i>
                <h3 class="card-title">Password Hash</h3>
                <p class="card-description">Generate secure SHA-256 password hashes</p>
            </div>

            <div class="admin-card matlab-card" onclick="window.location.href='../managers/matlab/matlab-manager.html'">
                <i class="fas fa-chart-line card-icon"></i>
                <h3 class="card-title">MATLAB Projects</h3>
                <p class="card-description">Manage MATLAB code, plots, and video demos</p>
            </div>

            <div class="admin-card youtube-card" onclick="window.location.href='../../Content Studio/video-content/update-durations.html'">
                <i class="fas fa-video card-icon"></i>
                <h3 class="card-title">YouTube Duration</h3>
                <p class="card-description">Auto-fetch video durations from YouTube API</p>
            </div>

            <div class="admin-card" onclick="window.location.href='../managers/content-editing/content-editor.html'">
                <i class="fas fa-edit card-icon"></i>
                <h3 class="card-title">Content Editor</h3>
                <p class="card-description">Edit website text and descriptions</p>
            </div>

            <div class="admin-card" onclick="window.location.href='../managers/projects/project-creator/project-manager.html'">
                <i class="fas fa-magic card-icon"></i>
                <h3 class="card-title">AI Project Creator</h3>
                <p class="card-description">Generate complete web projects with AI planning</p>
            </div>
        </div>
    </div>

    <!-- Dashboard JavaScript -->
    <script>
        // Clear session when clicking Home link
        document.addEventListener('DOMContentLoaded', () => {
            const homeLink = document.getElementById('homeLink');
            if (homeLink) {
                homeLink.addEventListener('click', function(e) {
                    sessionStorage.removeItem('onlyBossAuthenticated');
                    sessionStorage.removeItem('authTime');
                });
            }
        });

        // Authentication Check with Enhanced Security
        async function checkAuthentication() {
            try {
                const sessionData = sessionStorage.getItem('onlyBossAuthenticated');
                const authTime = sessionStorage.getItem('authTime');
                const verificationKey = sessionStorage.getItem('_vk');
                const sessionIdHash = sessionStorage.getItem('_sid');
                
                // Basic existence check
                if (!sessionData || !authTime || !verificationKey || !sessionIdHash) {
                    redirectToLogin();
                    return false;
                }
                
                // Decode and validate session structure
                let session;
                try {
                    session = JSON.parse(atob(sessionData));
                } catch (e) {
                    redirectToLogin();
                    return false;
                }
                
                // Verify required fields including new security fields
                if (!session.id || !session.timestamp || !session.sig || 
                    !session.validated || !session.fp || !session._k) {
                    redirectToLogin();
                    return false;
                }
                
                // Verify timestamp consistency
                if (session.timestamp.toString() !== authTime) {
                    redirectToLogin();
                    return false;
                }
                
                // Critical: Verify browser fingerprint matches login fingerprint
                const currentFingerprint = await getBrowserFingerprint();
                if (session.fp !== currentFingerprint) {
                    console.error('üö® Session hijacking detected - browser mismatch');
                    alert('Security Alert: Session validation failed. This incident will be logged.');
                    redirectToLogin();
                    return false;
                }
                
                // Verify verification key with fingerprint
                const expectedVK = await hashPassword('verify:' + authTime + ':' + currentFingerprint);
                if (verificationKey !== expectedVK) {
                    redirectToLogin();
                    return false;
                }
                
                // Verify session ID hash
                const expectedSidHash = await hashPassword(session.id + currentFingerprint);
                if (sessionIdHash !== expectedSidHash) {
                    redirectToLogin();
                    return false;
                }
                
                // Verify internal key
                const _verify_key = 'a3km_studio_2026';
                const expectedK = await hashPassword(_verify_key + authTime);
                if (session._k !== expectedK) {
                    redirectToLogin();
                    return false;
                }
                
                // Check session expiry (30 minutes)
                const currentTime = Date.now();
                const sessionAge = currentTime - parseInt(authTime);
                if (sessionAge > 30 * 60 * 1000) {
                    alert('Session expired. Please login again.');
                    redirectToLogin();
                    return false;
                }
                
                // Display last login time
                const loginDate = new Date(parseInt(authTime));
                document.getElementById('lastLogin').textContent = loginDate.toLocaleString();
                
                return true;
            } catch (error) {
                console.error('Authentication check failed:', error);
                redirectToLogin();
                return false;
            }
        }
        
        function redirectToLogin() {
            sessionStorage.clear();
            window.location.href = '../auth/only-boss.html';
        }
        
        // Hash function for verification
        async function hashPassword(text) {
            const msgBuffer = new TextEncoder().encode(text);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        // Browser fingerprint (must match login fingerprint)
        async function getBrowserFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('A3KM', 2, 2);
            const canvasData = canvas.toDataURL();
            
            const fingerprint = {
                canvas: canvasData,
                userAgent: navigator.userAgent,
                language: navigator.language,
                platform: navigator.platform,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                screen: `${screen.width}x${screen.height}x${screen.colorDepth}`
            };
            
            const fpString = JSON.stringify(fingerprint);
            const msgBuffer = new TextEncoder().encode(fpString);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Logout Function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                sessionStorage.clear();
                window.location.href = '../auth/only-boss.html';
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuthentication();
            
            // Logout button
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
            }
            
            // Periodic session validation (every 2 minutes)
            setInterval(async () => {
                const isValid = await checkAuthentication();
                if (!isValid) {
                    alert('Session validation failed. Redirecting to login.');
                    redirectToLogin();
                }
            }, 2 * 60 * 1000);
            
            // Continuous fingerprint validation (every 30 seconds)
            setInterval(async () => {
                const sessionData = sessionStorage.getItem('onlyBossAuthenticated');
                if (sessionData) {
                    try {
                        const session = JSON.parse(atob(sessionData));
                        const currentFP = await getBrowserFingerprint();
                        if (session.fp !== currentFP) {
                            console.error('üö® Browser fingerprint changed - possible tampering');
                            alert('Security Alert: Browser environment changed. Re-authentication required.');
                            redirectToLogin();
                        }
                    } catch (e) {
                        redirectToLogin();
                    }
                }
            }, 30 * 1000);
        });

        // Prevent going back after logout
        window.history.pushState(null, "", window.location.href);
        window.onpopstate = function() {
            if (!sessionStorage.getItem('onlyBossAuthenticated')) {
                window.location.href = '../auth/only-boss.html';
            }
        };
        
        // Clear session when navigating away from Only Boss
        window.addEventListener('beforeunload', function(e) {
            const nextUrl = e.target.activeElement?.href || '';
            if (nextUrl && !nextUrl.includes('/Only-boss/') && !nextUrl.includes('/Only boss/')) {
                sessionStorage.clear();
            }
        });
        
        // Anti-tampering: Detect DevTools and sessionStorage manipulation
        let devtoolsOpen = false;
        const devtoolsCheck = () => {
            const threshold = 160;
            if (window.outerWidth - window.innerWidth > threshold || 
                window.outerHeight - window.innerHeight > threshold) {
                if (!devtoolsOpen) {
                    devtoolsOpen = true;
                    console.warn('‚ö†Ô∏è Security Notice: Developer tools detected');
                }
            } else {
                devtoolsOpen = false;
            }
        };
        
        // Monitor sessionStorage changes
        const originalSetItem = sessionStorage.setItem;
        sessionStorage.setItem = function(key, value) {
            if (key.startsWith('onlyBoss') || key === '_vk' || key === 'authTime' || key === '_sid') {
                // Check if this is being called from our authorized code
                const stack = new Error().stack;
                if (!stack.includes('checkAuthentication') && 
                    !stack.includes('createSession') &&
                    !stack.includes('only-boss-auth.js') &&
                    !stack.includes('only-boss-dashboard')) {
                    console.error('üö® Unauthorized sessionStorage modification detected');
                    sessionStorage.clear();
                    window.location.href = '../auth/only-boss.html';
                    return;
                }
            }
            originalSetItem.apply(this, arguments);
        };
        
        // Prevent console tampering
        const _log = console.log;
        const _warn = console.warn;
        const _error = console.error;
        
        // Check for tampering every 5 seconds
        setInterval(() => {
            if (console.log !== _log || console.warn !== _warn || console.error !== _error) {
                sessionStorage.clear();
                window.location.href = '../auth/only-boss.html';
            }
            devtoolsCheck();
        }, 5000);
        
        // Detect if running in iframe (clickjacking protection)
        if (window.self !== window.top) {
            window.top.location = window.self.location;
        }
        
        // Prevent copying session data
        document.addEventListener('copy', (e) => {
            const selection = window.getSelection().toString();
            if (selection.includes('onlyBoss') || selection.includes('session')) {
                e.preventDefault();
                console.warn('‚ö†Ô∏è Security: Sensitive data cannot be copied');
            }
        });
    </script>
</body>
</html>
