<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="../../../images/favicon.svg">
    
    <title>Token System Verification Test</title>
    
    <!-- Mobile Optimization Styles -->
    <link rel="stylesheet" href="../../mobile/only-boss-global-mobile.css">
    <link rel="stylesheet" href="../../mobile/manager-mobile.css">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #0f0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #1a1a1a;
            border: 2px solid #0f0;
            padding: 30px;
            border-radius: 10px;
        }
        h1 {
            color: #0f0;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 0 0 10px #0f0;
        }
        .test-section {
            background: #000;
            border: 1px solid #0f0;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .test-section h2 {
            color: #ff0;
            margin-bottom: 15px;
        }
        .test-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: #1a1a1a;
            border-left: 3px solid #666;
        }
        .test-item.pass { border-color: #0f0; }
        .test-item.fail { border-color: #f00; color: #f00; }
        .test-item.warn { border-color: #ff0; color: #ff0; }
        .status {
            width: 60px;
            font-weight: bold;
            margin-right: 15px;
        }
        .button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 10px 5px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 5px;
            font-size: 14px;
        }
        .button:hover {
            background: #0ff;
        }
        .button.danger {
            background: #f00;
            color: #fff;
        }
        .button.danger:hover {
            background: #f55;
        }
        pre {
            background: #000;
            padding: 15px;
            border: 1px solid #333;
            border-radius: 5px;
            overflow-x: auto;
            color: #0ff;
            margin-top: 10px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #000;
            border: 2px solid #0f0;
            padding: 20px;
            text-align: center;
            border-radius: 5px;
        }
        .stat-value {
            font-size: 48px;
            font-weight: bold;
            color: #0f0;
            text-shadow: 0 0 10px #0f0;
        }
        .stat-label {
            color: #888;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê TOKEN SYSTEM VERIFICATION TEST üîê</h1>
        
        <div style="text-align: center; margin-bottom: 30px;">
            <button class="button" onclick="runAllTests()">‚ñ∂Ô∏è RUN ALL TESTS</button>
            <button class="button" onclick="saveTestToken()">üíæ SAVE TEST TOKEN</button>
            <button class="button danger" onclick="clearAllTokens()">üóëÔ∏è CLEAR ALL TOKENS</button>
            <button class="button" onclick="location.reload()">üîÑ REFRESH</button>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="passCount">0</div>
                <div class="stat-label">PASSED</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="failCount">0</div>
                <div class="stat-label">FAILED</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalCount">0</div>
                <div class="stat-label">TOTAL TESTS</div>
            </div>
        </div>

        <div class="test-section">
            <h2>1Ô∏è‚É£ LOCALSTORAGE TESTS</h2>
            <div id="storageTests"></div>
        </div>

        <div class="test-section">
            <h2>2Ô∏è‚É£ TOKEN KEY VERIFICATION</h2>
            <div id="keyTests"></div>
        </div>

        <div class="test-section">
            <h2>3Ô∏è‚É£ UNIFIED TOKEN MANAGER</h2>
            <div id="managerTests"></div>
        </div>

        <div class="test-section">
            <h2>4Ô∏è‚É£ TOKEN SUPPLY CHAIN</h2>
            <div id="supplyTests"></div>
        </div>

        <div class="test-section">
            <h2>üìä DETAILED RESULTS</h2>
            <pre id="detailsOutput">Click "RUN ALL TESTS" to start...</pre>
        </div>
    </div>

    <script>
        let passCount = 0;
        let failCount = 0;
        let totalCount = 0;
        let detailedLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            detailedLog.push(`[${timestamp}] [${type.toUpperCase()}] ${message}`);
            console.log(`[${type.toUpperCase()}]`, message);
        }

        function addTestResult(container, description, passed, details = '') {
            totalCount++;
            if (passed) passCount++;
            else failCount++;

            const div = document.createElement('div');
            div.className = `test-item ${passed ? 'pass' : 'fail'}`;
            div.innerHTML = `
                <span class="status">${passed ? '‚úÖ PASS' : '‚ùå FAIL'}</span>
                <span>${description}</span>
            `;
            
            if (details) {
                div.innerHTML += `<pre style="margin-left: auto; font-size: 11px; padding: 5px;">${details}</pre>`;
            }

            document.getElementById(container).appendChild(div);
            
            log(`${passed ? 'PASS' : 'FAIL'}: ${description}${details ? ' | ' + details : ''}`, passed ? 'pass' : 'fail');
        }

        function updateStats() {
            document.getElementById('passCount').textContent = passCount;
            document.getElementById('failCount').textContent = failCount;
            document.getElementById('totalCount').textContent = totalCount;
            
            document.getElementById('detailsOutput').textContent = detailedLog.join('\n');
        }

        function clearResults() {
            passCount = 0;
            failCount = 0;
            totalCount = 0;
            detailedLog = [];
            
            document.getElementById('storageTests').innerHTML = '';
            document.getElementById('keyTests').innerHTML = '';
            document.getElementById('managerTests').innerHTML = '';
            document.getElementById('supplyTests').innerHTML = '';
            document.getElementById('detailsOutput').textContent = 'Running tests...';
        }

        // TEST 1: LocalStorage Tests
        function testLocalStorage() {
            log('=== STARTING LOCALSTORAGE TESTS ===');
            
            // Test 1.1: localStorage available
            const hasLocalStorage = typeof localStorage !== 'undefined';
            addTestResult('storageTests', 'localStorage API available', hasLocalStorage);

            // Test 1.2: Can write to localStorage
            try {
                localStorage.setItem('_test_key', 'test_value');
                const canWrite = localStorage.getItem('_test_key') === 'test_value';
                localStorage.removeItem('_test_key');
                addTestResult('storageTests', 'Can write to localStorage', canWrite);
            } catch (error) {
                addTestResult('storageTests', 'Can write to localStorage', false, error.message);
            }

            // Test 1.3: github_token key exists
            const hasToken = localStorage.getItem('github_token') !== null;
            const tokenValue = localStorage.getItem('github_token');
            addTestResult('storageTests', 'github_token key exists', hasToken, 
                hasToken ? `Length: ${tokenValue.length} chars` : 'No token found');

            // Test 1.4: Token is not empty
            if (hasToken) {
                const notEmpty = tokenValue && tokenValue.trim().length > 0;
                addTestResult('storageTests', 'Token is not empty', notEmpty, 
                    notEmpty ? `${tokenValue.substring(0, 20)}...` : 'Empty string');
            }
        }

        // TEST 2: Token Key Verification
        function testTokenKeys() {
            log('=== STARTING TOKEN KEY TESTS ===');

            const allKeys = Object.keys(localStorage);
            const tokenKeys = allKeys.filter(key => 
                key.includes('token') || key.includes('github') || key.includes('pat')
            );

            log(`Found ${tokenKeys.length} token-related keys: ${tokenKeys.join(', ')}`);

            // Test 2.1: Only github_token exists (no old keys)
            const oldKeys = [
                'github_pat',
                'a3km_github_token',
                'a3km_github_token_v2',
                'dashboard_github_token'
            ];

            oldKeys.forEach(oldKey => {
                const exists = localStorage.getItem(oldKey) !== null;
                addTestResult('keyTests', `No old key: ${oldKey}`, !exists, 
                    exists ? '‚ö†Ô∏è Old key still exists!' : '‚úÖ Clean');
            });

            // Test 2.2: github_token format validation
            const token = localStorage.getItem('github_token');
            if (token) {
                const validFormat = token.startsWith('ghp_') || token.startsWith('github_pat_');
                addTestResult('keyTests', 'Token format valid (ghp_ or github_pat_)', validFormat,
                    token.substring(0, 15) + '...');
            }
        }

        // TEST 3: Unified Token Manager Tests
        function testUnifiedManager() {
            log('=== STARTING UNIFIED TOKEN MANAGER TESTS ===');

            // Test 3.1: Script loaded
            const managerLoaded = typeof window.UnifiedTokenManager !== 'undefined';
            addTestResult('managerTests', 'UnifiedTokenManager class loaded', managerLoaded);

            if (!managerLoaded) return;

            // Test 3.2: Can instantiate
            try {
                const manager = new window.UnifiedTokenManager();
                addTestResult('managerTests', 'Can create manager instance', true);

                // Test 3.3: Manager has loadToken method
                const hasLoadToken = typeof manager.loadToken === 'function';
                addTestResult('managerTests', 'loadToken() method exists', hasLoadToken);

                // Test 3.4: Manager loads token
                const loadedToken = manager.loadToken();
                const tokenLoaded = loadedToken !== null && loadedToken !== undefined;
                addTestResult('managerTests', 'Manager can load token', tokenLoaded,
                    tokenLoaded ? `Loaded ${loadedToken.length} chars` : 'No token');

                // Test 3.5: Token matches localStorage
                const storageToken = localStorage.getItem('github_token');
                const matches = loadedToken === storageToken;
                addTestResult('managerTests', 'Manager token matches localStorage', matches);

            } catch (error) {
                addTestResult('managerTests', 'Can create manager instance', false, error.message);
            }
        }

        // TEST 4: Token Supply Chain
        async function testSupplyChain() {
            log('=== STARTING SUPPLY CHAIN TESTS ===');

            const systems = [
                'Content Studio Managers',
                'Project Managers',
                'Settings Managers',
                'Certificate Manager',
                'Content Editor',
                'Project Creator'
            ];

            // Test 4.1: Token available via localStorage
            const token = localStorage.getItem('github_token');
            addTestResult('supplyTests', 'Token available in localStorage', !!token,
                token ? `${token.length} chars` : 'Missing');

            // Test 4.2: Simulate manager token retrieval
            const simulatedRetrieval = () => {
                const GITHUB_TOKEN = localStorage.getItem('github_token') || '';
                return GITHUB_TOKEN;
            };

            const retrieved = simulatedRetrieval();
            addTestResult('supplyTests', 'Managers can retrieve token', !!retrieved,
                retrieved ? 'Success' : 'Failed');

            // Test 4.3: Token persistence test
            const beforeToken = localStorage.getItem('github_token');
            localStorage.setItem('github_token', beforeToken || 'test'); // Re-save
            const afterToken = localStorage.getItem('github_token');
            const persists = beforeToken === afterToken;
            addTestResult('supplyTests', 'Token persists across saves', persists);

            // Test 4.4: Multiple retrieval consistency
            const retrieval1 = localStorage.getItem('github_token');
            const retrieval2 = localStorage.getItem('github_token');
            const retrieval3 = localStorage.getItem('github_token');
            const consistent = retrieval1 === retrieval2 && retrieval2 === retrieval3;
            addTestResult('supplyTests', 'Multiple retrievals consistent', consistent);

            // Test 4.5: Cross-page simulation (same domain)
            try {
                const testKey = '_cross_page_test';
                localStorage.setItem(testKey, 'test_value');
                const canAccross = localStorage.getItem(testKey) === 'test_value';
                localStorage.removeItem(testKey);
                addTestResult('supplyTests', 'Cross-page token access works', canAccross);
            } catch (error) {
                addTestResult('supplyTests', 'Cross-page token access works', false, error.message);
            }
        }

        // RUN ALL TESTS
        async function runAllTests() {
            clearResults();
            log('üöÄ STARTING COMPREHENSIVE TOKEN SYSTEM TEST');
            log('============================================');

            testLocalStorage();
            await new Promise(resolve => setTimeout(resolve, 100));

            testTokenKeys();
            await new Promise(resolve => setTimeout(resolve, 100));

            testUnifiedManager();
            await new Promise(resolve => setTimeout(resolve, 100));

            await testSupplyChain();
            
            updateStats();
            
            log('============================================');
            log(`‚úÖ TESTS COMPLETE: ${passCount}/${totalCount} passed`);
            
            if (failCount === 0) {
                alert(`üéâ ALL TESTS PASSED! (${passCount}/${totalCount})\n\nToken system is working correctly!`);
            } else {
                alert(`‚ö†Ô∏è SOME TESTS FAILED: ${failCount} failed, ${passCount} passed\n\nCheck the detailed results below.`);
            }
        }

        // Save test token
        function saveTestToken() {
            const testToken = 'github_pat_TEST_TOKEN_FOR_VERIFICATION_ONLY_' + Date.now();
            localStorage.setItem('github_token', testToken);
            alert('‚úÖ Test token saved!\n\n' + testToken.substring(0, 50) + '...\n\nClick "RUN ALL TESTS" to verify.');
            log('Test token saved: ' + testToken);
        }

        // Clear all tokens
        function clearAllTokens() {
            if (!confirm('‚ö†Ô∏è This will clear ALL tokens and related data. Continue?')) return;

            const keysToRemove = [
                'github_token',
                'github_token_expiry',
                'github_token_timestamp',
                'github_token_valid',
                'github_rate_limit',
                'github_last_check',
                'github_pat',
                'a3km_github_token',
                'a3km_github_token_v2',
                'dashboard_github_token'
            ];

            keysToRemove.forEach(key => localStorage.removeItem(key));
            
            alert('üóëÔ∏è All tokens cleared!\n\nPage will reload.');
            location.reload();
        }

        // Auto-run on load
        window.addEventListener('DOMContentLoaded', () => {
            log('Token System Verification Test loaded');
            
            // Load unified token manager if available
            if (typeof window.UnifiedTokenManager === 'undefined') {
                const script = document.createElement('script');
                script.src = 'unified-token-manager.js';
                script.onload = () => log('Unified Token Manager loaded');
                script.onerror = () => log('Failed to load Unified Token Manager', 'error');
                document.head.appendChild(script);
            }
        });
    </script>
</body>
</html>
