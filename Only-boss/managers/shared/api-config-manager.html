<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="../../../images/favicon.svg">
    
    <title>API Configuration Manager - A3KM Studio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Load Unified Token Manager -->
    <script src="unified-token-manager.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0505 50%, #0a0a0a 100%);
            min-height: 100vh;
            padding: 40px 20px;
            color: #fff;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(26, 26, 26, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            border: 2px solid rgba(139, 0, 0, 0.3);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(139, 0, 0, 0.3);
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-title i {
            font-size: 36px;
            color: #8B0000;
        }

        h1 {
            color: #fff;
            font-size: 32px;
            margin-bottom: 5px;
        }

        .subtitle {
            color: #999;
            font-size: 14px;
        }

        .back-btn {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.2), rgba(90, 0, 0, 0.15));
            border: 2px solid rgba(139, 0, 0, 0.5);
            padding: 12px 24px;
            border-radius: 12px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .back-btn:hover {
            background: linear-gradient(135deg, #8B0000, #5a0000);
            transform: translateX(-3px);
        }

        .info-banner {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.15), rgba(90, 0, 0, 0.1));
            border-left: 4px solid #8B0000;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .info-banner i {
            color: #C80000;
            margin-right: 10px;
        }

        .api-grid {
            display: grid;
            gap: 25px;
        }

        .api-card {
            background: rgba(20, 20, 20, 0.6);
            border: 2px solid rgba(139, 0, 0, 0.3);
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s;
        }

        .api-card:hover {
            border-color: #8B0000;
            box-shadow: 0 5px 20px rgba(139, 0, 0, 0.3);
        }

        .api-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .api-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #8B0000, #C80000);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .api-info h3 {
            color: #fff;
            font-size: 20px;
            margin-bottom: 5px;
        }

        .api-info p {
            color: #999;
            font-size: 13px;
        }

        .api-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
        }

        .status-active {
            background: rgba(0, 200, 81, 0.2);
            color: #00C851;
            border: 1px solid rgba(0, 200, 81, 0.4);
        }

        .status-inactive {
            background: rgba(255, 82, 82, 0.2);
            color: #FF5252;
            border: 1px solid rgba(255, 82, 82, 0.4);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            color: #ccc;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .input-wrapper {
            position: relative;
        }

        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 12px 45px 12px 15px;
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(139, 0, 0, 0.3);
            border-radius: 10px;
            color: #fff;
            font-size: 14px;
            transition: all 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #8B0000;
            background: rgba(0, 0, 0, 0.6);
        }

        .toggle-visibility {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 16px;
            transition: color 0.3s;
        }

        .toggle-visibility:hover {
            color: #8B0000;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-save {
            background: linear-gradient(135deg, #8B0000, #C80000);
            color: #fff;
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 0, 0, 0.4);
        }

        .btn-test {
            background: rgba(139, 0, 0, 0.2);
            color: #fff;
            border: 2px solid rgba(139, 0, 0, 0.5);
        }

        .btn-test:hover {
            background: rgba(139, 0, 0, 0.3);
        }

        .btn-clear {
            background: rgba(255, 82, 82, 0.2);
            color: #FF5252;
            border: 2px solid rgba(255, 82, 82, 0.4);
        }

        .btn-clear:hover {
            background: rgba(255, 82, 82, 0.3);
        }

        .helper-text {
            font-size: 12px;
            color: #777;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .helper-text i {
            color: #8B0000;
        }

        .success-message, .error-message {
            padding: 12px 15px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s;
        }

        .success-message {
            background: rgba(0, 200, 81, 0.2);
            border: 1px solid rgba(0, 200, 81, 0.4);
            color: #00C851;
        }

        .error-message {
            background: rgba(255, 82, 82, 0.2);
            border: 1px solid rgba(255, 82, 82, 0.4);
            color: #FF5252;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .usage-info {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .usage-info h4 {
            color: #fff;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .usage-info ul {
            list-style: none;
            padding: 0;
        }

        .usage-info li {
            color: #999;
            font-size: 12px;
            padding: 5px 0;
            padding-left: 20px;
            position: relative;
        }

        .usage-info li:before {
            content: "‚Üí";
            position: absolute;
            left: 0;
            color: #8B0000;
        }

        /* Help Panel */
        .help-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8B0000, #C80000);
            color: #fff;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(139, 0, 0, 0.5);
            z-index: 999;
            transition: all 0.3s;
        }

        .help-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 30px rgba(139, 0, 0, 0.7);
        }

        .help-panel {
            position: fixed;
            top: 0;
            right: -500px;
            width: 500px;
            height: 100vh;
            background: rgba(26, 26, 26, 0.98);
            box-shadow: -5px 0 30px rgba(0, 0, 0, 0.8);
            z-index: 1000;
            transition: right 0.3s;
            overflow-y: auto;
            padding: 30px;
            border-left: 3px solid #8B0000;
        }

        .help-panel.active {
            right: 0;
        }

        .help-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            transition: color 0.3s;
        }

        .help-close:hover {
            color: #8B0000;
        }

        .help-section {
            margin: 25px 0;
            padding: 20px;
            border-left: 4px solid #8B0000;
            background: rgba(139, 0, 0, 0.1);
            border-radius: 8px;
        }

        .help-section h3 {
            color: #C80000;
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .help-section ul {
            list-style: none;
            padding: 0;
        }

        .help-section li {
            margin: 12px 0;
            padding-left: 25px;
            position: relative;
            color: #ccc;
            line-height: 1.6;
        }

        .help-section li:before {
            content: "‚úì";
            position: absolute;
            left: 0;
            color: #8B0000;
            font-weight: bold;
        }

        .help-section code {
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 8px;
            border-radius: 4px;
            color: #C80000;
            font-family: 'Courier New', monospace;
        }

        .pro-tips {
            background: rgba(0, 200, 81, 0.1);
            border: 2px solid rgba(0, 200, 81, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-top: 25px;
        }

        .pro-tips h4 {
            color: #00C851;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: auto;
        }

        .connected {
            background: rgba(0, 200, 81, 0.2);
            color: #00C851;
            border: 1px solid rgba(0, 200, 81, 0.4);
        }

        .disconnected {
            background: rgba(255, 82, 82, 0.2);
            color: #FF5252;
            border: 1px solid rgba(255, 82, 82, 0.4);
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ===================================
           MOBILE OPTIMIZATION
           =================================== */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            .container {
                padding: 25px 20px;
                border-radius: 15px;
            }

            .header {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }

            .header-title {
                flex-direction: column;
            }

            .header-title i {
                font-size: 28px;
            }

            h1 {
                font-size: 24px;
            }

            .subtitle {
                font-size: 12px;
            }

            .back-btn {
                width: 100%;
                justify-content: center;
            }

            .info-banner {
                padding: 15px;
                font-size: 13px;
            }

            .api-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .api-card {
                padding: 20px;
            }

            .api-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .api-icon {
                width: 45px;
                height: 45px;
                font-size: 22px;
            }

            .api-info h3 {
                font-size: 18px;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            input[type="text"],
            input[type="password"] {
                font-size: 16px;
                padding: 12px 40px 12px 12px;
            }

            .usage-info h4 {
                font-size: 13px;
            }

            .usage-info li {
                font-size: 11px;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 20px;
            }

            .api-info p {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-title">
                <i class="fas fa-plug"></i>
                <div>
                    <h1>API Configuration Manager</h1>
                    <p class="subtitle">Centralized API keys management for all systems</p>
                </div>
            </div>
            <a href="../../dashboard/only-boss-dashboard-redesigned.html" class="back-btn">
                <i class="fas fa-arrow-left"></i>
                Back to Dashboard
            </a>
        </div>

        <div class="info-banner">
            <i class="fas fa-info-circle"></i>
            <strong>Secure Storage:</strong> All API keys are stored locally in your browser (localStorage). They are never sent to any external server except when making authorized API calls.
        </div>

        <div class="api-grid">
            <!-- GitHub API -->
            <div class="api-card">
                <div class="api-header">
                    <div class="api-icon">
                        <i class="fab fa-github"></i>
                    </div>
                    <div class="api-info">
                        <h3>
                            GitHub Personal Access Token
                            <span class="api-status status-inactive" id="githubStatus">Inactive</span>
                        </h3>
                        <p>Required for content upload, file management, and GitHub integration</p>
                    </div>
                </div>

                <div class="form-group">
                    <label for="githubToken">GitHub Token</label>
                    <div class="input-wrapper">
                        <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                        <button class="toggle-visibility" onclick="toggleVisibility('githubToken')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <p class="helper-text">
                        <i class="fas fa-link"></i>
                        <a href="https://github.com/settings/tokens" target="_blank" style="color: #8B0000;">Generate token</a>
                        (requires: repo, workflow permissions)
                    </p>
                </div>

                <div class="btn-group">
                    <button class="btn btn-save" onclick="saveAPI('github')">
                        <i class="fas fa-save"></i>
                        Save Token
                    </button>
                    <button class="btn btn-test" onclick="testAPI('github')">
                        <i class="fas fa-check-circle"></i>
                        Test Connection
                    </button>
                    <button class="btn btn-secondary" onclick="checkTokenStatus()" style="background: rgba(100, 100, 100, 0.2); border-color: #666;">
                        <i class="fas fa-info-circle"></i>
                        Check Status
                    </button>
                    <button class="btn btn-clear" onclick="clearAPI('github')">
                        <i class="fas fa-trash"></i>
                        Clear
                    </button>
                </div>

                <div class="success-message" id="githubSuccess"></div>
                <div class="error-message" id="githubError"></div>

                <div class="usage-info">
                    <h4>Used by:</h4>
                    <ul>
                        <li>Content Upload System (all 5 types)</li>
                        <li>Posts, Videos, Books, Papers Managers</li>
                        <li>File upload & deletion operations</li>
                    </ul>
                </div>
            </div>

            <!-- YouTube API -->
            <div class="api-card">
                <div class="api-header">
                    <div class="api-icon">
                        <i class="fab fa-youtube"></i>
                    </div>
                    <div class="api-info">
                        <h3>
                            YouTube Data API v3
                            <span class="api-status status-inactive" id="youtubeStatus">Inactive</span>
                        </h3>
                        <p>Auto-fetch video details, duration, and thumbnails</p>
                    </div>
                </div>

                <div class="form-group">
                    <label for="youtubeApiKey">YouTube API Key</label>
                    <div class="input-wrapper">
                        <input type="password" id="youtubeApiKey" placeholder="AIzaSyXxxxxxxxxxxxxxxxxxxx">
                        <button class="toggle-visibility" onclick="toggleVisibility('youtubeApiKey')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <p class="helper-text">
                        <i class="fas fa-link"></i>
                        <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color: #8B0000;">Get API key</a>
                        (enable YouTube Data API v3)
                    </p>
                </div>

                <div class="btn-group">
                    <button class="btn btn-save" onclick="saveAPI('youtube')">
                        <i class="fas fa-save"></i>
                        Save Key
                    </button>
                    <button class="btn btn-test" onclick="testAPI('youtube')">
                        <i class="fas fa-check-circle"></i>
                        Test API
                    </button>
                    <button class="btn btn-clear" onclick="clearAPI('youtube')">
                        <i class="fas fa-trash"></i>
                        Clear
                    </button>
                </div>

                <div class="success-message" id="youtubeSuccess"></div>
                <div class="error-message" id="youtubeError"></div>

                <div class="usage-info">
                    <h4>Used by:</h4>
                    <ul>
                        <li>Video Upload System (auto-fetch feature)</li>
                        <li>Educational Videos Upload</li>
                        <li>Video duration updater</li>
                    </ul>
                </div>
            </div>

            <!-- Future APIs Placeholder -->
            <div class="api-card" style="opacity: 0.6;">
                <div class="api-header">
                    <div class="api-icon">
                        <i class="fas fa-plus"></i>
                    </div>
                    <div class="api-info">
                        <h3>Additional APIs</h3>
                        <p>More API integrations coming soon (Cloudinary, Analytics, etc.)</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load existing API keys
        function loadAPIs() {
            console.log('üîç Loading API tokens from localStorage...');
            
            let githubToken = localStorage.getItem('github_token');
            const youtubeKey = localStorage.getItem('youtube_api_key');

            console.log('GitHub Token found:', githubToken ? '‚úÖ Yes (' + githubToken.length + ' chars)' : '‚ùå No');
            console.log('YouTube Key found:', youtubeKey ? '‚úÖ Yes' : '‚ùå No');

            if (githubToken) {
                document.getElementById('githubToken').value = githubToken;
                updateStatus('github', true);
                console.log('‚úÖ GitHub token loaded into input field');
            } else {
                console.warn('‚ö†Ô∏è No GitHub token in localStorage');
            }

            if (youtubeKey) {
                document.getElementById('youtubeApiKey').value = youtubeKey;
                updateStatus('youtube', true);
                console.log('‚úÖ YouTube key loaded into input field');
            }
        }

        // Toggle password visibility
        function toggleVisibility(inputId) {
            const input = document.getElementById(inputId);
            const icon = event.target.closest('button').querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        // Save API key
        function saveAPI(type) {
            let key, storageKey;
            
            if (type === 'github') {
                key = document.getElementById('githubToken').value.trim();
                storageKey = 'github_token';
            } else if (type === 'youtube') {
                key = document.getElementById('youtubeApiKey').value.trim();
                storageKey = 'youtube_api_key';
            }

            if (!key) {
                showMessage(type, 'error', 'Please enter a valid API key');
                console.error('‚ùå No key entered for ' + type);
                return;
            }

            try {
                // ALWAYS save to localStorage first (primary storage)
                localStorage.setItem(storageKey, key);
                console.log('‚úÖ Token saved to localStorage:', storageKey);
                console.log('üìä Token length:', key.length, 'characters');
                console.log('üîç Verification - Reading back:', localStorage.getItem(storageKey) ? 'SUCCESS ‚úÖ' : 'FAILED ‚ùå');
                
                // For GitHub tokens, also use Unified Token Manager if available
                if (type === 'github' && window.tokenManager) {
                    try {
                        window.tokenManager.saveToken(key);
                        console.log('‚úÖ Token also saved via Unified Token Manager');
                        
                        // Validate token health
                        setTimeout(() => {
                            window.tokenManager.getHealthStatus().then(health => {
                                console.log('üè• Token Health:', health.status, '-', health.message);
                                if (health.status === 'healthy') {
                                    showMessage(type, 'success', `‚úì GitHub token saved and validated! (${health.details.user})`);
                                } else if (health.status === 'warning') {
                                    showMessage(type, 'success', `‚úì Token saved but: ${health.message}`);
                                } else {
                                    showMessage(type, 'error', `‚ö†Ô∏è Token saved but validation failed: ${health.message}`);
                                }
                            });
                        }, 500);
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Unified Token Manager error:', error);
                        // Still continue - localStorage save succeeded
                        showMessage(type, 'success', `‚úì GitHub token saved to localStorage`);
                    }
                } else {
                    // Non-GitHub or no token manager
                    updateStatus(type, true);
                    showMessage(type, 'success', `‚úì ${type === 'github' ? 'GitHub token' : 'YouTube API key'} saved successfully!`);
                }
                
                // Show token distribution status
                if (type === 'github') {
                    console.log('üì¢ GitHub token is now available for ALL 16 systems');
                    console.log('üí° Systems using this token:');
                    console.log('   ‚úÖ Content Studio (5 managers)');
                    console.log('   ‚úÖ Certificate Manager');
                    console.log('   ‚úÖ Project Managers (3)');
                    console.log('   ‚úÖ Settings Managers (2)');
                    console.log('   ‚úÖ Content Editor');
                    console.log('   ‚úÖ Project Creator');
                    console.log('   ‚úÖ System Integration Hub');
                    console.log('   ‚úÖ API Config Manager');
                }
            } catch (error) {
                console.error('‚ùå Save failed:', error);
                showMessage(type, 'error', 'Failed to save: ' + error.message);
            }
        }

        // Test API connection
        async function testAPI(type) {
            if (type === 'github') {
                const token = document.getElementById('githubToken').value.trim();
                if (!token) {
                    showMessage('github', 'error', 'Please enter GitHub token first');
                    return;
                }

                // Use Unified Token Manager validation
                if (window.tokenManager) {
                    showMessage('github', 'success', '‚è≥ Validating token with GitHub API...');
                    
                    const validation = await window.tokenManager.validateToken(token);
                    
                    if (validation.valid) {
                        let message = `‚úì Connected as: ${validation.user}`;
                        if (validation.rateLimit) {
                            message += `<br>üìä Rate Limit: ${validation.rateLimit.remaining}/${validation.rateLimit.limit} (${validation.rateLimit.percentage}% available)`;
                        }
                        showMessage('github', 'success', message);
                    } else {
                        showMessage('github', 'error', `‚úó ${validation.error || 'Validation failed'}`);
                    }
                } else {
                    // Fallback to basic validation
                    try {
                        const response = await fetch('https://api.github.com/user', {
                            headers: {
                                'Authorization': `token ${token}`
                            }
                        });

                        if (response.ok) {
                            const data = await response.json();
                            showMessage('github', 'success', `‚úì Connected as: ${data.login}`);
                        } else {
                            showMessage('github', 'error', '‚úó Invalid token or no permissions');
                        }
                    } catch (error) {
                        showMessage('github', 'error', '‚úó Connection failed: ' + error.message);
                    }
                }
            } else if (type === 'youtube') {
                const key = document.getElementById('youtubeApiKey').value.trim();
                if (!key) {
                    showMessage('youtube', 'error', 'Please enter YouTube API key first');
                    return;
                }

                try {
                    const response = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet&id=dQw4w9WgXcQ&key=${key}`);
                    
                    if (response.ok) {
                        showMessage('youtube', 'success', '‚úì YouTube API working correctly!');
                    } else {
                        const error = await response.json();
                        showMessage('youtube', 'error', '‚úó ' + (error.error?.message || 'Invalid API key'));
                    }
                } catch (error) {
                    showMessage('youtube', 'error', '‚úó Connection failed: ' + error.message);
                }
            }
        }

        // Clear API key
        function clearAPI(type) {
            if (confirm('Are you sure you want to remove this API key?')) {
                if (type === 'github') {
                    localStorage.removeItem('github_token');
                    document.getElementById('githubToken').value = '';
                    updateStatus('github', false);
                    showMessage('github', 'success', 'GitHub token removed');
                    console.log('üóëÔ∏è GitHub token removed from localStorage');
                } else if (type === 'youtube') {
                    localStorage.removeItem('youtube_api_key');
                    document.getElementById('youtubeApiKey').value = '';
                    updateStatus('youtube', false);
                    showMessage('youtube', 'success', 'YouTube API key removed');
                }
            }
        }

        // Check token status (debugging tool)
        async function checkTokenStatus() {
            // Use Unified Token Manager if available
            if (window.tokenManager) {
                const health = await window.tokenManager.getHealthStatus();
                
                let message = 'üìä GitHub Token Status:\n\n';
                message += `Status: ${health.icon} ${health.message}\n\n`;
                
                if (health.details) {
                    if (health.details.user) {
                        message += `üë§ User: ${health.details.user}\n`;
                        message += `üìß Name: ${health.details.name || 'N/A'}\n\n`;
                    }
                    
                    if (health.details.rateLimit) {
                        message += `üìä Rate Limit:\n`;
                        message += `   ‚Ä¢ Remaining: ${health.details.rateLimit.remaining}/${health.details.rateLimit.limit}\n`;
                        message += `   ‚Ä¢ Available: ${health.details.rateLimit.percentage}%\n`;
                        message += `   ‚Ä¢ Reset: ${health.details.rateLimit.reset.toLocaleTimeString()}\n\n`;
                    }
                    
                    if (health.details.expiryInfo) {
                        message += `üìÖ Expiry:\n`;
                        message += `   ‚Ä¢ ${health.details.expiryInfo.message}\n\n`;
                    }
                }
                
                message += `üì¢ Token is unified across ALL 16 systems:\n\n`;
                message += `‚úÖ Content Studio (5 managers)\n`;
                message += `   ‚Ä¢ Posts Manager\n`;
                message += `   ‚Ä¢ Books Manager\n`;
                message += `   ‚Ä¢ Papers Manager\n`;
                message += `   ‚Ä¢ Educational Videos Manager\n`;
                message += `   ‚Ä¢ Vlogs Manager\n\n`;
                message += `‚úÖ Certificate Manager\n\n`;
                message += `‚úÖ Project Managers (3)\n`;
                message += `   ‚Ä¢ Arduino Manager\n`;
                message += `   ‚Ä¢ MATLAB Manager\n`;
                message += `   ‚Ä¢ SolidWorks Manager\n\n`;
                message += `‚úÖ Settings Managers (2)\n`;
                message += `   ‚Ä¢ Navigation Editor\n`;
                message += `   ‚Ä¢ SEO Manager\n\n`;
                message += `‚úÖ Content Editor\n`;
                message += `‚úÖ Project Creator\n`;
                message += `‚úÖ System Integration Hub\n`;
                message += `‚úÖ API Config Manager\n\n`;
                message += `üí° One token for everything!`;
                
                alert(message);
            } else {
                // Fallback to basic status check
                const token = localStorage.getItem('github_token');
                const inputValue = document.getElementById('githubToken').value;
                
                let message = 'üìä GitHub Token Status:\n\n';
                message += `‚úÖ Token in localStorage: ${token ? 'YES (' + token.length + ' chars)' : 'NO'}\n`;
                message += `‚úÖ Token in input field: ${inputValue ? 'YES (' + inputValue.length + ' chars)' : 'NO'}\n`;
                message += `‚úÖ Tokens match: ${token === inputValue ? 'YES' : 'NO'}\n\n`;
                
                if (token) {
                    message += `üîç Token preview: ${token.substring(0, 20)}...\n\n`;
                    message += `üì¢ This token is available to all managers`;
                } else {
                    message += `‚ö†Ô∏è No token found! Managers will show setup prompt.`;
                }
                
                alert(message);
            }
            
            console.log('=== TOKEN STATUS CHECK ===');
            console.log('Unified Token Manager:', window.tokenManager ? 'LOADED ‚úÖ' : 'NOT LOADED ‚ö†Ô∏è');
            console.log('localStorage token:', localStorage.getItem('github_token'));
            console.log('Input field token:', document.getElementById('githubToken').value);
            console.log('==========================');
        }

        // Update status badge
        function updateStatus(type, isActive) {
            const statusEl = document.getElementById(`${type}Status`);
            if (isActive) {
                statusEl.textContent = 'Active';
                statusEl.className = 'api-status status-active';
            } else {
                statusEl.textContent = 'Inactive';
                statusEl.className = 'api-status status-inactive';
            }
        }

        // Show message
        function showMessage(type, messageType, text) {
            const successEl = document.getElementById(`${type}Success`);
            const errorEl = document.getElementById(`${type}Error`);
            
            successEl.style.display = 'none';
            errorEl.style.display = 'none';

            if (messageType === 'success') {
                successEl.innerHTML = `<i class="fas fa-check-circle"></i> ${text}`;
                successEl.style.display = 'flex';
                setTimeout(() => successEl.style.display = 'none', 5000);
            } else {
                errorEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${text}`;
                errorEl.style.display = 'flex';
                setTimeout(() => errorEl.style.display = 'none', 5000);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadAPIs();
            
            // Initialize Unified Token Manager
            if (window.UnifiedTokenManager) {
                window.tokenManager = new window.UnifiedTokenManager();
                console.log('‚úÖ Unified Token Manager initialized');
                
                // Perform initial health check
                window.tokenManager.getHealthStatus().then(health => {
                    console.log('üè• Initial Token Health:', health.message);
                    
                    // Update UI based on health
                    if (health.status === 'healthy') {
                        document.getElementById('githubStatus').textContent = 'Healthy';
                        document.getElementById('githubStatus').className = 'api-status status-active';
                    } else if (health.status === 'warning') {
                        document.getElementById('githubStatus').textContent = 'Warning';
                        document.getElementById('githubStatus').className = 'api-status status-active';
                    }
                });
            } else {
                console.warn('‚ö†Ô∏è Unified Token Manager not loaded');
            }
            
            // Log activity
            if (typeof ActivityLogger !== 'undefined') {
                ActivityLogger.log('system', 'API Configuration Manager opened', 'Admin', 'success', 'API management interface accessed');
            }
        });

        // Toggle help panel
        function toggleHelp() {
            document.getElementById('helpPanel').classList.toggle('active');
        }

        // Check connection status for all APIs
        async function checkAllConnections() {
            const githubToken = localStorage.getItem('github_token');
            const youtubeKey = localStorage.getItem('youtube_api_key');
            
            // Update connection indicators
            if (githubToken) {
                document.getElementById('githubConnection').className = 'connection-status connected';
                document.getElementById('githubConnection').innerHTML = '<i class="fas fa-check-circle"></i> Connected';
            } else {
                document.getElementById('githubConnection').className = 'connection-status disconnected pulse';
                document.getElementById('githubConnection').innerHTML = '<i class="fas fa-exclamation-circle"></i> Not Connected';
            }
            
            if (youtubeKey) {
                document.getElementById('youtubeConnection').className = 'connection-status connected';
                document.getElementById('youtubeConnection').innerHTML = '<i class="fas fa-check-circle"></i> Connected';
            } else {
                document.getElementById('youtubeConnection').className = 'connection-status disconnected pulse';
                document.getElementById('youtubeConnection').innerHTML = '<i class="fas fa-exclamation-circle"></i> Not Connected';
            }
        }

        // Update save functions to log activity
        const originalSaveAPI = saveAPI;
        saveAPI = function(type) {
            originalSaveAPI(type);
            
            // Log activity
            if (typeof ActivityLogger !== 'undefined') {
                ActivityLogger.log('edit', `${type === 'github' ? 'GitHub' : 'YouTube'} API key saved`, 'Admin', 'success', `API key configured for ${type}`);
            }
            
            checkAllConnections();
        };

        const originalClearAPI = clearAPI;
        clearAPI = function(type) {
            if (confirm('Are you sure you want to remove this API key?')) {
                if (type === 'github') {
                    localStorage.removeItem('github_token');
                    document.getElementById('githubToken').value = '';
                    updateStatus('github', false);
                    showMessage('github', 'success', 'GitHub token removed');
                    
                    // Log activity
                    if (typeof ActivityLogger !== 'undefined') {
                        ActivityLogger.log('edit', 'GitHub token removed', 'Admin', 'success', 'GitHub API disconnected');
                    }
                } else if (type === 'youtube') {
                    localStorage.removeItem('youtube_api_key');
                    document.getElementById('youtubeApiKey').value = '';
                    updateStatus('youtube', false);
                    showMessage('youtube', 'success', 'YouTube API key removed');
                    
                    // Log activity
                    if (typeof ActivityLogger !== 'undefined') {
                        ActivityLogger.log('edit', 'YouTube API key removed', 'Admin', 'success', 'YouTube API disconnected');
                    }
                }
                
                checkAllConnections();
            }
        };

        // Check connections on load
        setTimeout(checkAllConnections, 500);
    </script>

    <!-- Help Button -->
    <button class="help-btn" onclick="toggleHelp()" title="Help & Usage Guide">
        <i class="fas fa-question"></i>
    </button>

    <!-- Help Panel -->
    <div class="help-panel" id="helpPanel">
        <button class="help-close" onclick="toggleHelp()">
            <i class="fas fa-times"></i>
        </button>

        <h2 style="color: #C80000; margin-bottom: 25px; font-size: 24px;">
            <i class="fas fa-book"></i> API Configuration Guide
        </h2>

        <div class="help-section">
            <h3><i class="fas fa-rocket"></i> Quick Start</h3>
            <ul>
                <li>Choose GitHub or YouTube API section</li>
                <li>Enter your API key/token</li>
                <li>Click <code>Save</code> to store securely</li>
                <li>Click <code>Test Connection</code> to verify</li>
                <li>API is now available to all managers!</li>
            </ul>
        </div>

        <div class="help-section">
            <h3><i class="fab fa-github"></i> GitHub Token Setup</h3>
            <ul>
                <li><strong>Step 1:</strong> Go to github.com/settings/tokens</li>
                <li><strong>Step 2:</strong> Click "Generate new token (classic)"</li>
                <li><strong>Step 3:</strong> Select scopes: <code>repo</code>, <code>workflow</code></li>
                <li><strong>Step 4:</strong> Copy token and paste here</li>
                <li><strong>Expires:</strong> Recommended 90 days</li>
            </ul>
        </div>

        <div class="help-section">
            <h3><i class="fab fa-youtube"></i> YouTube API Setup</h3>
            <ul>
                <li><strong>Step 1:</strong> Go to console.cloud.google.com</li>
                <li><strong>Step 2:</strong> Create project or select existing</li>
                <li><strong>Step 3:</strong> Enable "YouTube Data API v3"</li>
                <li><strong>Step 4:</strong> Create credentials ‚Üí API key</li>
                <li><strong>Step 5:</strong> Copy API key and paste here</li>
            </ul>
        </div>

        <div class="help-section">
            <h3><i class="fas fa-plug"></i> Where These Are Used</h3>
            <ul>
                <li><strong>GitHub Token:</strong></li>
                <li>‚Ä¢ Content Studio (Upload books, papers, videos)</li>
                <li>‚Ä¢ Certificate Manager (Upload certificates)</li>
                <li>‚Ä¢ Site Settings (Deploy configurations)</li>
                <li>‚Ä¢ Navigation Editor (Deploy navbar)</li>
                <li>‚Ä¢ SEO Manager (Deploy meta tags)</li>
                <li><strong>YouTube API:</strong></li>
                <li>‚Ä¢ Video Gallery (Fetch video details)</li>
                <li>‚Ä¢ Educational Videos (Channel data)</li>
                <li>‚Ä¢ Video Content Hub (Playlists)</li>
            </ul>
        </div>

        <div class="help-section">
            <h3><i class="fas fa-shield-alt"></i> Security & Privacy</h3>
            <ul>
                <li>Keys stored locally in browser (localStorage)</li>
                <li>Never sent to external servers</li>
                <li>Basic encoding applied (not full encryption)</li>
                <li>Clear keys anytime with <code>Clear</code> button</li>
                <li>Recommended: Use fine-grained tokens with minimal scopes</li>
            </ul>
        </div>

        <div class="help-section">
            <h3><i class="fas fa-check-double"></i> Testing Your Keys</h3>
            <ul>
                <li><strong>GitHub:</strong> Tests by fetching your repo info</li>
                <li><strong>YouTube:</strong> Tests with sample video query</li>
                <li>‚úì Success = Key is valid and working</li>
                <li>‚úó Error = Invalid key or wrong permissions</li>
                <li>Test after saving to ensure connectivity</li>
            </ul>
        </div>

        <div class="help-section">
            <h3><i class="fas fa-sync-alt"></i> Troubleshooting</h3>
            <ul>
                <li><strong>Token Expired:</strong> Generate new token on GitHub</li>
                <li><strong>Permission Denied:</strong> Check token scopes</li>
                <li><strong>API Limit:</strong> GitHub: 5000/hour, YouTube: 10000/day</li>
                <li><strong>Connection Failed:</strong> Check internet connection</li>
                <li><strong>Keys Not Working:</strong> Clear and re-enter</li>
            </ul>
        </div>

        <div class="pro-tips">
            <h4><i class="fas fa-lightbulb"></i> Pro Tips</h4>
            <ul style="list-style: none; padding: 0;">
                <li style="padding-left: 0; margin: 10px 0; color: #ccc;">üí° <strong>Tip 1:</strong> Set token expiry to 90 days and renew before it expires</li>
                <li style="padding-left: 0; margin: 10px 0; color: #ccc;">üí° <strong>Tip 2:</strong> Use separate tokens for development and production</li>
                <li style="padding-left: 0; margin: 10px 0; color: #ccc;">üí° <strong>Tip 3:</strong> Test connection after every save to verify</li>
                <li style="padding-left: 0; margin: 10px 0; color: #ccc;">üí° <strong>Tip 4:</strong> Keep a backup copy of your tokens securely</li>
                <li style="padding-left: 0; margin: 10px 0; color: #ccc;">üí° <strong>Tip 5:</strong> Monitor API usage in GitHub/Google Cloud Console</li>
            </ul>
        </div>
    </div>

    <!-- Activity Logger Integration -->
    <script src="../../shared/activity-logger.js"></script>
</body>
</html>
