<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Video Blogs Manager - A3KM Studio</title>
  <link rel="stylesheet" href="../../../Optimization/mobile-universal.css">
  <script src="../../../Optimization/mobile-universal.js" defer></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background: #1a1a1a; background-image: linear-gradient(rgba(200, 0, 0, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(200, 0, 0, 0.05) 1px, transparent 1px); background-size: 100px 100px; min-height: 100vh; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.8); border-top: 4px solid #8B0000; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .back-btn { background: rgba(139, 0, 0, 0.1); border: 2px solid #8B0000; padding: 10px 20px; border-radius: 10px; color: #8B0000; font-weight: 600; text-decoration: none; }
    .back-btn:hover { background: #8B0000; color: white; }
    h1 { color: #8B0000; font-size: 32px; margin-bottom: 10px; }
    .tabs { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #e0e0e0; }
    .tab { padding: 12px 24px; background: transparent; border: none; color: #666; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; }
    .tab.active { color: #8B0000; border-bottom-color: #8B0000; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 14px; }
    input, select, textarea { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 14px; font-family: inherit; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #8B0000; }
    textarea { resize: vertical; min-height: 100px; }
    .btn-primary { padding: 15px 30px; background: linear-gradient(135deg, #8B0000, #C80000); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 20px; }
    .file-upload-label { display: flex; align-items: center; justify-content: center; padding: 40px; border: 2px dashed #8B0000; border-radius: 10px; cursor: pointer; background: #fff5f5; }
    .content-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
    .content-card { border: 2px solid #e0e0e0; border-radius: 12px; overflow: hidden; transition: all 0.3s; }
    .content-card:hover { border-color: #8B0000; box-shadow: 0 4px 12px rgba(139, 0, 0, 0.2); }
    .card-thumbnail { width: 100%; height: 150px; object-fit: cover; background: linear-gradient(135deg, #8B0000, #C80000); }
    .card-body { padding: 15px; }
    .card-title { font-weight: 600; color: #333; margin-bottom: 8px; }
    .card-meta { font-size: 11px; color: #999; margin-bottom: 10px; }
    .card-actions { display: flex; gap: 8px; }
    .card-actions button { flex: 1; padding: 8px; border: 1px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer; font-size: 12px; }
    .card-actions button:hover { background: #8B0000; color: white; border-color: #8B0000; }
    .search-bar { display: flex; gap: 10px; margin-bottom: 20px; }
    .search-bar input { flex: 1; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    .stat-card { background: linear-gradient(135deg, #8B0000, #C80000); color: white; padding: 20px; border-radius: 12px; text-align: center; }
    .stat-card h3 { font-size: 32px; margin-bottom: 5px; }
    .progress { margin-top: 20px; display: none; }
    .progress.active { display: block; }
    .progress-bar { width: 100%; height: 8px; background: #f0f0f0; border-radius: 4px; overflow: hidden; margin-bottom: 10px; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #8B0000, #C80000); width: 0%; transition: width 0.3s; }
    .progress-text { text-align: center; color: #8B0000; font-size: 14px; font-weight: 600; }
    .success-message { background: #4caf50; color: white; padding: 15px; border-radius: 10px; margin-top: 20px; display: none; text-align: center; }
    .success-message.active { display: block; }
    .youtube-toggle { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 10px; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; overflow-y: auto; }
    .modal.active { display: block; }
    .modal-content { max-width: 800px; margin: 40px auto; background: white; border-radius: 20px; padding: 40px; position: relative; }
    .modal-close { position: absolute; top: 20px; right: 20px; background: #f44336; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 20px; }
    .modal-close:hover { background: #d32f2f; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>üé¨ Video Blogs Manager</h1>
        <p style="color: #666;">Manage vlog content and video series</p>
      </div>
      <a href="content-hub.html" class="back-btn">‚Üê Back to Hub</a>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('upload')">üì§ Upload</button>
      <button class="tab" onclick="switchTab('manage')">üìã Manage</button>
      <button class="tab" onclick="switchTab('stats')">üìä Statistics</button>
    </div>

    <div id="uploadTab" class="tab-content active">
      <form id="uploadForm">
        <div class="form-group">
          <label>Category</label>
          <select id="category" required>
            <option value="">Loading categories...</option>
          </select>
        </div>
        <div class="form-group">
          <label>Vlog Title</label>
          <input type="text" id="title" placeholder="Enter vlog title..." required>
        </div>
        <div class="youtube-toggle">
          <input type="checkbox" id="isYoutube" checked>
          <label for="isYoutube" style="margin: 0;">YouTube Video (recommended)</label>
        </div>
        <div class="form-group" id="youtubeUrlGroup">
          <label>YouTube URL</label>
          <input type="url" id="youtubeUrl" placeholder="https://youtu.be/VIDEO_ID" required>
        </div>
        <div class="form-group">
          <label>Series Name (Optional)</label>
          <input type="text" id="series" placeholder="e.g., Daily Vlog, Tech Talk">
        </div>
        <div class="form-group">
          <label>Episode Number (Optional)</label>
          <input type="number" id="episode" placeholder="1" min="1">
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="description" placeholder="Vlog description..." rows="3"></textarea>
        </div>
        <div class="form-group">
          <label>Creator</label>
          <input type="text" id="author" placeholder="Your name..." value="Md Akhinoor Islam">
        </div>
        <div class="form-group">
          <label>Duration</label>
          <input type="text" id="duration" placeholder="18:45 or 1h 30m" required>
        </div>
        <div class="form-group">
          <label>Language</label>
          <select id="language">
            <option value="bn">Bengali (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ)</option>
            <option value="en">English</option>
            <option value="bn-en">Mixed (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ-English)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Tags (comma-separated)</label>
          <input type="text" id="tags" placeholder="vlog, lifestyle, travel">
        </div>
        <div class="form-group">
          <label>Thumbnail (Auto-fetched from YouTube)</label>
          <input type="file" id="thumbnail" accept="image/*" style="display: none;">
          <label for="thumbnail" class="file-upload-label">üñºÔ∏è Choose custom thumbnail (optional)</label>
          <div id="thumbnailInfo" style="margin-top: 10px; color: #666; font-size: 14px;"></div>
        </div>
        <button type="submit" class="btn-primary">üì§ Upload Vlog</button>
        <div class="progress" id="progress">
          <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
          <div class="progress-text" id="progressText">Processing...</div>
        </div>
        <div class="success-message" id="successMessage">‚úÖ Vlog uploaded successfully!</div>
      </form>
    </div>

    <div id="manageTab" class="tab-content">
      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="üîç Search vlogs..." onkeyup="filterContent()">
        <select id="sortBy" onchange="filterContent()">
          <option value="date">Newest First</option>
          <option value="title">Title A-Z</option>
          <option value="series">By Series</option>
        </select>
      </div>
      <div class="content-grid" id="contentGrid">
        <p style="text-align: center; padding: 40px; color: #999;">Loading vlogs...</p>
      </div>
    </div>

    <div id="statsTab" class="tab-content">
      <div class="stats-grid">
        <div class="stat-card"><h3 id="totalVlogs">0</h3><p>Total Vlogs</p></div>
        <div class="stat-card"><h3 id="totalCategories">0</h3><p>Categories</p></div>
        <div class="stat-card"><h3 id="totalSeries">0</h3><p>Series</p></div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeEditModal()">√ó</button>
      <h2 style="color: #8B0000; margin-bottom: 20px;">‚úèÔ∏è Edit Vlog</h2>
      <form id="editForm">
        <input type="hidden" id="editVlogId">
        <div class="form-group">
          <label>Category</label>
          <select id="editCategory" required></select>
        </div>
        <div class="form-group">
          <label>Title</label>
          <input type="text" id="editTitle" required>
        </div>
        <div class="form-group">
          <label>YouTube URL</label>
          <input type="url" id="editYoutubeUrl">
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="editDescription"></textarea>
        </div>
        <div class="form-group">
          <label>Tags</label>
          <input type="text" id="editTags">
        </div>
        <button type="submit" class="btn-primary">üíæ Update Vlog</button>
      </form>
    </div>
  </div>

  <script src="svg-generator.js"></script>
  <script src="github-content-uploader.js"></script>
  <script src="content-manager.js"></script>
  <script>
    const GITHUB_TOKEN = 'YOUR_GITHUB_TOKEN_HERE';
    const CONTENT_TYPE = 'video-content';
    const svgGenerator = new SVGCoverGenerator();
    const githubUploader = new GitHubContentUploader({ token: GITHUB_TOKEN, owner: 'Akhinoor14', repo: 'A3KM-Studio' });
    const contentManager = new ContentManager(githubUploader);
    let currentContent = [];

    async function loadCategories() {
      try {
        const data = await contentManager.loadContent(CONTENT_TYPE);
        const categorySelect = document.getElementById('category');
        categorySelect.innerHTML = '<option value="">Select category...</option>';
        
        // Vlogs structure: categories.video-blog[category-slug] = {name, videos[]}
        if (data.categories && data.categories['video-blog']) {
          const vlogCategories = data.categories['video-blog'];
          
          // Also get categoryGroups for organized display (if available)
          const categoryGroups = data.categoryGroups && data.categoryGroups['video-blog'];
          
          if (categoryGroups && Array.isArray(categoryGroups)) {
            // Group categories by their groups
            categoryGroups.forEach(group => {
              const optgroup = document.createElement('optgroup');
              optgroup.label = `${group.icon} ${group.name}`;
              
              if (group.categories && Array.isArray(group.categories)) {
                group.categories.forEach(catSlug => {
                  const catData = vlogCategories[catSlug];
                  if (catData) {
                    const option = document.createElement('option');
                    option.value = catData.name;
                    option.textContent = catData.name;
                    optgroup.appendChild(option);
                  }
                });
              }
              
              categorySelect.appendChild(optgroup);
            });
          } else {
            // Fallback: add all categories without groups
            Object.entries(vlogCategories).forEach(([slug, catData]) => {
              const option = document.createElement('option');
              option.value = catData.name;
              option.textContent = catData.name;
              categorySelect.appendChild(option);
            });
          }
        }
      } catch (error) {
        console.error('Failed to load categories:', error);
        alert('Failed to load categories. Check console for details.');
      }
    }

    document.getElementById('thumbnail').addEventListener('change', function() {
      if (this.files[0]) document.getElementById('thumbnailInfo').textContent = `üñºÔ∏è ${this.files[0].name}`;
    });

    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      // Validate GitHub token
      if (GITHUB_TOKEN === 'YOUR_GITHUB_TOKEN_HERE' || !GITHUB_TOKEN) {
        alert('‚ùå Please set your GitHub token first!');
        return;
      }
      
      const progress = document.getElementById('progress');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      const successMessage = document.getElementById('successMessage');
      progress.classList.add('active');
      successMessage.classList.remove('active');
      try {
        const title = document.getElementById('title').value;
        const category = document.getElementById('category').value;
        const youtubeUrl = document.getElementById('youtubeUrl').value;        
        // Duplicate check
        progressText.textContent = 'Checking for duplicates...';
        progressFill.style.width = '20%';
        const duplicateCheck = await contentManager.checkDuplicates(CONTENT_TYPE, title, category);
        if (duplicateCheck.isDuplicate) {
          const confirm = window.confirm(`‚ö†Ô∏è A vlog with title "${title}" already exists. Upload anyway?`);
          if (!confirm) {
            progress.classList.remove('active');
            return;
          }
        }
        progressText.textContent = 'Extracting YouTube ID...';
        progressFill.style.width = '40%';
        const match = youtubeUrl.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\s]+)/);
        const youtubeId = match ? match[1] : null;
        
        progressText.textContent = 'Generating cover...';
        progressFill.style.width = '60%';
        const coverSVG = await svgGenerator.generateCover(category, 0);
        
        progressText.textContent = 'Uploading to GitHub...';
        progressFill.style.width = '80%';
        const contentId = `vlog-${Date.now()}`;
        await githubUploader.uploadCompleteContent({
          contentType: CONTENT_TYPE,
          category: category,
          contentId: contentId,
          title: title,
          description: document.getElementById('description').value,
          tags: document.getElementById('tags').value.split(',').map(t => t.trim()),
          author: document.getElementById('author').value || 'Md Akhinoor Islam',
          thumbnailFile: document.getElementById('thumbnail').files[0],
          coverSVG: coverSVG,
          youtubeId: youtubeId,
          metadata: {
            youtubeUrl: youtubeUrl,
            duration: document.getElementById('duration').value || '0:00',
            language: document.getElementById('language').value || 'bn',
            views: 0,
            series: document.getElementById('series').value || null,
            episode: document.getElementById('episode').value || null
          }
        });
        
        progressFill.style.width = '100%';
        progressText.textContent = 'Complete!';
        progress.classList.remove('active');
        successMessage.classList.add('active');
        setTimeout(() => { this.reset(); successMessage.classList.remove('active'); }, 3000);
      } catch (error) {
        progress.classList.remove('active');
        alert(`‚ùå Upload failed: ${error.message}`);
      }
    });

    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tabName + 'Tab').classList.add('active');
      event.target.classList.add('active');
      if (tabName === 'manage') loadManageContent();
      if (tabName === 'stats') loadStatistics();
    }

    async function loadManageContent() {
      const grid = document.getElementById('contentGrid');
      grid.innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">Loading...</p>';
      try {
        const data = await contentManager.loadContent(CONTENT_TYPE);
        currentContent = contentManager.getItemsFromData(data, CONTENT_TYPE);
        renderContent(currentContent);
      } catch (error) {
        grid.innerHTML = '<p style="text-align: center; padding: 40px; color: #f44336;">Failed to load vlogs</p>';
        console.error('Load error:', error);
      }
    }

    function renderContent(items) {
      const grid = document.getElementById('contentGrid');
      if (items.length === 0) { grid.innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">No vlogs yet</p>'; return; }
      grid.innerHTML = '';
      items.forEach(item => {
        const card = document.createElement('div');
        card.className = 'content-card';
        card.innerHTML = `
          <img src="${item.thumbnail || item.coverImage || ''}" class="card-thumbnail" onerror="this.style.background='linear-gradient(135deg, #8B0000, #C80000)'">
          <div class="card-body">
            <div class="card-title">${item.title}</div>
            <div class="card-meta">üìÅ ${item.category}<br>üë§ ${item.author || 'Unknown'}<br>üïê ${contentManager.formatDate(item.date)}</div>
            <div class="card-actions">
              <button onclick="editVlog('${item.id}')">‚úèÔ∏è Edit</button>
              <button onclick="deleteVlog('${item.id}')">üóëÔ∏è Delete</button>
            </div>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    function filterContent() {
      const query = document.getElementById('searchInput').value;
      const sortBy = document.getElementById('sortBy').value;
      let filtered = contentManager.searchContent(currentContent, query);
      filtered = contentManager.sortItems(filtered, sortBy, 'desc');
      renderContent(filtered);
    }

    async function loadStatistics() {
      const data = await contentManager.loadContent(CONTENT_TYPE);
      const items = contentManager.getItemsFromData(data, CONTENT_TYPE);
      document.getElementById('totalVlogs').textContent = items.length;
      document.getElementById('totalCategories').textContent = new Set(items.map(item => item.category)).size;
      const series = new Set(items.filter(item => item.series).map(item => item.series));
      document.getElementById('totalSeries').textContent = series.size;
    }

    function deleteVlog(id) {
      if (confirm('Delete this vlog?')) {
        contentManager.deleteContent(CONTENT_TYPE, id).then(() => { alert('‚úÖ Deleted!'); loadManageContent(); }).catch(err => alert('‚ùå Failed: ' + err.message));
      }
    }

    function editVlog(id) {
      const vlog = currentContent.find(v => v.id === id);
      if (!vlog) return;
      document.getElementById('editVlogId').value = id;
      document.getElementById('editCategory').value = vlog.category;
      document.getElementById('editTitle').value = vlog.title;
      document.getElementById('editYoutubeUrl').value = vlog.youtubeUrl || vlog.url || '';
      document.getElementById('editDescription').value = vlog.description || '';
      document.getElementById('editTags').value = (vlog.tags || []).join(', ');
      loadCategories().then(() => { document.getElementById('editCategory').value = vlog.category; });
      document.getElementById('editModal').classList.add('active');
    }

    function closeEditModal() { document.getElementById('editModal').classList.remove('active'); }

    document.getElementById('editForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const updatedVlog = {
        id: document.getElementById('editVlogId').value,
        title: document.getElementById('editTitle').value,
        category: document.getElementById('editCategory').value,
        youtubeUrl: document.getElementById('editYoutubeUrl').value,
        description: document.getElementById('editDescription').value,
        tags: document.getElementById('editTags').value.split(',').map(t => t.trim()).filter(t => t),
        date: new Date().toISOString()
      };
      try {
        await contentManager.updateContent(CONTENT_TYPE, updatedVlog.id, updatedVlog);
        alert('‚úÖ Vlog updated!');
        closeEditModal();
        loadManageContent();
      } catch (error) { alert('‚ùå Update failed: ' + error.message); }
    });

    window.addEventListener('DOMContentLoaded', loadCategories);
  </script>
  <script src="../../Optimization/navbar-autohide.js"></script>
</body>
</html>
