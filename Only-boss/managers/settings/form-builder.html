<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- Universal Mobile Optimization System -->
    <link rel="stylesheet" href="../../../Optimization/mobile-universal.css">
    <script src="../../../Optimization/mobile-universal.js" defer></script>
    
    <title>Form Builder - A3KM Studio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: white; border-radius: 20px; padding: 30px; margin-bottom: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .header h1 { color: #333; font-size: 28px; display: flex; align-items: center; gap: 15px; margin-bottom: 10px; }
        .builder { display: grid; grid-template-columns: 300px 1fr 300px; gap: 20px; margin-bottom: 30px; }
        .panel { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); }
        .panel-title { font-size: 16px; font-weight: 600; color: #333; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #fa709a; display: flex; align-items: center; gap: 8px; }
        .section { background: white; border-radius: 15px; padding: 25px; margin-bottom: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); }
        .section-title { font-size: 18px; font-weight: 600; color: #333; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; padding-bottom: 15px; border-bottom: 2px solid #fa709a; }
        .btn { padding: 10px 15px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, #fa709a, #fee140); color: #333; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(250, 112, 154, 0.4); }
        .btn-secondary { background: #9e9e9e; color: white; }
        .btn-secondary:hover { background: #757575; }
        .btn-danger { background: #f44336; color: white; }
        .btn-danger:hover { background: #da190b; }
        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
        .field-buttons { display: grid; gap: 8px; }
        .field-btn { padding: 10px; text-align: left; background: #f5f5f5; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 13px; }
        .field-btn:hover { background: #fff9f0; border-color: #fa709a; }
        .field-btn i { margin-right: 8px; color: #fa709a; }
        .form-preview { min-height: 400px; border: 2px dashed #ddd; border-radius: 8px; padding: 20px; background: #f9f9f9; }
        .form-field { background: white; border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px; margin: 15px 0; position: relative; }
        .form-field:hover { border-color: #fa709a; box-shadow: 0 3px 10px rgba(250, 112, 154, 0.2); }
        .form-field-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .form-field-label { font-weight: 600; color: #333; }
        .form-field-actions { display: flex; gap: 5px; }
        .form-field-actions button { padding: 4px 8px; font-size: 12px; }
        .input-group { margin: 12px 0; }
        .input-group label { display: block; font-weight: 500; color: #333; margin-bottom: 6px; font-size: 13px; }
        .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 13px; font-family: inherit; }
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus { outline: none; border-color: #fa709a; background: #fffbf5; }
        .checkbox-group { display: flex; align-items: center; gap: 8px; margin: 10px 0; }
        .checkbox-group input[type="checkbox"], .checkbox-group input[type="radio"] { cursor: pointer; }
        .field-options { max-height: 200px; overflow-y: auto; }
        .option-item { display: flex; align-items: center; gap: 8px; padding: 8px; background: #f9f9f9; border-radius: 4px; margin: 5px 0; }
        .option-item button { padding: 2px 6px; font-size: 11px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; }
        .tab-btn { padding: 12px 20px; border: none; background: transparent; color: #666; font-weight: 500; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .tab-btn:hover { color: #fa709a; }
        .tab-btn.active { color: #fa709a; border-bottom-color: #fa709a; }
        .status-message { padding: 12px 15px; border-radius: 8px; margin: 15px 0; font-weight: 500; }
        .status-success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .status-error { background: #f8d7da; color: #721c24; border-left: 4px solid #f44336; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #f5f5f5; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        @media (max-width: 1024px) {
            .builder { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-wpforms"></i> Form Builder</h1>
            <p>Create custom forms without coding</p>
        </div>

        <!-- Builder Section -->
        <div class="builder">
            <!-- Field Palette -->
            <div class="panel">
                <div class="panel-title"><i class="fas fa-shapes"></i> Field Types</div>
                <div class="field-buttons">
                    <button class="field-btn" onclick="addField('text')"><i class="fas fa-font"></i> Text Input</button>
                    <button class="field-btn" onclick="addField('email')"><i class="fas fa-envelope"></i> Email</button>
                    <button class="field-btn" onclick="addField('phone')"><i class="fas fa-phone"></i> Phone</button>
                    <button class="field-btn" onclick="addField('number')"><i class="fas fa-calculator"></i> Number</button>
                    <button class="field-btn" onclick="addField('textarea')"><i class="fas fa-align-left"></i> Textarea</button>
                    <button class="field-btn" onclick="addField('select')"><i class="fas fa-list"></i> Dropdown</button>
                    <button class="field-btn" onclick="addField('checkbox')"><i class="fas fa-check-square"></i> Checkbox</button>
                    <button class="field-btn" onclick="addField('radio')"><i class="fas fa-dot-circle"></i> Radio</button>
                    <button class="field-btn" onclick="addField('file')"><i class="fas fa-file"></i> File Upload</button>
                    <button class="field-btn" onclick="addField('date')"><i class="fas fa-calendar"></i> Date</button>
                </div>
                
                <div class="panel-title" style="margin-top: 20px;"><i class="fas fa-cogs"></i> Settings</div>
                <div class="input-group">
                    <label for="formName">Form Name</label>
                    <input type="text" id="formName" placeholder="e.g., Contact Form" value="New Form">
                </div>
                <div class="input-group">
                    <label>
                        <input type="checkbox" id="formRequired" checked> Mark as required
                    </label>
                </div>
                <button class="btn btn-primary" onclick="saveForm()" style="width: 100%; margin-top: 15px;">
                    <i class="fas fa-save"></i> Save Form
                </button>
            </div>

            <!-- Form Preview -->
            <div class="panel">
                <div class="panel-title"><i class="fas fa-eye"></i> Form Preview</div>
                <div class="form-preview" id="formPreview">
                    <div style="text-align: center; color: #999; padding: 80px 20px;">
                        <i class="fas fa-plus-circle" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p>Add fields from the left panel</p>
                    </div>
                </div>
            </div>

            <!-- Field Editor -->
            <div class="panel">
                <div class="panel-title"><i class="fas fa-edit"></i> Field Editor</div>
                <div id="fieldEditor" style="color: #999; padding: 40px 20px; text-align: center;">
                    <i class="fas fa-hand-pointer" style="font-size: 40px; opacity: 0.5; margin-bottom: 15px;"></i>
                    <p>Click a field to edit</p>
                </div>
            </div>
        </div>

        <!-- Manage Forms Section -->
        <div class="section">
            <div class="section-title"><i class="fas fa-list"></i> My Forms</div>
            
            <table>
                <thead>
                    <tr>
                        <th>Form Name</th>
                        <th>Fields</th>
                        <th>Created</th>
                        <th>Submissions</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="formsTable">
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px;">
                            <i class="fas fa-inbox" style="font-size: 32px; color: #ccc; margin-bottom: 10px;"></i>
                            <p style="color: #999;">No forms yet. Create one to get started.</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Submissions Section -->
        <div class="section">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('submissions')"><i class="fas fa-inbox"></i> Submissions</button>
                <button class="tab-btn" onclick="switchTab('settings')"><i class="fas fa-cog"></i> Email Settings</button>
            </div>

            <!-- Submissions Tab -->
            <div id="submissions-tab">
                <div class="input-group">
                    <label for="formSelectSubmissions">Select Form</label>
                    <select id="formSelectSubmissions" onchange="loadSubmissions()">
                        <option value="">All Forms</option>
                    </select>
                </div>

                <table style="margin-top: 20px;">
                    <thead>
                        <tr>
                            <th>Submitted</th>
                            <th>Sender</th>
                            <th>Data</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="submissionsTable">
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 40px;">
                                <i class="fas fa-inbox" style="font-size: 32px; color: #ccc; margin-bottom: 10px;"></i>
                                <p style="color: #999;">No submissions yet</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Email Settings Tab -->
            <div id="settings-tab" style="display: none;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div class="input-group">
                        <label for="smtpServer">SMTP Server</label>
                        <input type="text" id="smtpServer" placeholder="smtp.gmail.com">
                    </div>
                    <div class="input-group">
                        <label for="smtpPort">SMTP Port</label>
                        <input type="text" id="smtpPort" placeholder="587">
                    </div>
                    <div class="input-group">
                        <label for="smtpEmail">Email Address</label>
                        <input type="email" id="smtpEmail" placeholder="your-email@gmail.com">
                    </div>
                    <div class="input-group">
                        <label for="smtpPassword">Password</label>
                        <input type="password" id="smtpPassword" placeholder="App password">
                    </div>
                </div>
                <div class="input-group" style="margin-top: 20px;">
                    <label for="notifyEmail">Notification Email</label>
                    <input type="email" id="notifyEmail" placeholder="admin@example.com">
                </div>
                <button class="btn btn-primary" onclick="saveEmailSettings()" style="width: 100%; margin-top: 20px;">
                    <i class="fas fa-save"></i> Save Email Settings
                </button>
                <div id="settingsStatus"></div>
            </div>
        </div>

        <!-- CSV Export Section -->
        <div class="section">
            <div class="section-title"><i class="fas fa-download"></i> Export Data</div>
            <div class="input-group">
                <label for="exportForm">Select Form</label>
                <select id="exportForm"></select>
            </div>
            <button class="btn btn-primary" onclick="exportSubmissionsCSV()" style="width: 100%; margin-top: 15px;">
                <i class="fas fa-file-csv"></i> Export as CSV
            </button>
        </div>
    </div>

    <script src="../../shared/github-token-manager.js"></script>
    <script>
        const FORMS_KEY = 'a3km_forms';
        const SUBMISSIONS_KEY = 'a3km_form_submissions';
        const EMAIL_SETTINGS_KEY = 'a3km_email_settings';
        let tokenManager = null;
        
        let forms = {};
        let currentFormId = null;
        let currentFieldId = null;
        let fieldCounter = 0;

        document.addEventListener('DOMContentLoaded', () => {
            tokenManager = typeof GitHubTokenManager !== 'undefined' ? new GitHubTokenManager() : null;
            loadForms();
            loadFormsList();
            
            // Live update every 4 seconds
            setInterval(() => {
                loadForms();
                loadFormsList();
            }, 4000);
        });

        function loadForms() {
            forms = JSON.parse(localStorage.getItem(FORMS_KEY) || '{}');
            if (Object.keys(forms).length === 0) {
                currentFormId = 'form-' + Date.now();
                forms[currentFormId] = {
                    id: currentFormId,
                    name: 'New Form',
                    fields: [],
                    created: new Date().toISOString(),
                    settings: {}
                };
            } else {
                currentFormId = Object.keys(forms)[0];
            }
        }

        function addField(type) {
            if (!currentFormId) return;
            
            const fieldId = 'field-' + (++fieldCounter);
            const field = {
                id: fieldId,
                type: type,
                label: type.charAt(0).toUpperCase() + type.slice(1),
                required: document.getElementById('formRequired').checked,
                placeholder: '',
                options: type === 'select' || type === 'radio' || type === 'checkbox' ? ['Option 1'] : []
            };

            forms[currentFormId].fields.push(field);
            renderFormPreview();
        }

        function renderFormPreview() {
            const form = forms[currentFormId];
            const preview = document.getElementById('formPreview');

            if (!form || form.fields.length === 0) {
                preview.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 80px 20px;">
                        <i class="fas fa-plus-circle" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p>Add fields from the left panel</p>
                    </div>
                `;
                return;
            }

            preview.innerHTML = form.fields.map((field, idx) => `
                <div class="form-field" onclick="editField('${field.id}')">
                    <div class="form-field-header">
                        <div class="form-field-label">
                            <i class="fas fa-${getFieldIcon(field.type)}"></i> ${field.label}
                            ${field.required ? '<span style="color: #f44336;">*</span>' : ''}
                        </div>
                        <div class="form-field-actions">
                            <button class="btn btn-secondary" onclick="editField('${field.id}'); event.stopPropagation();" style="padding: 4px 8px; font-size: 12px;">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-danger" onclick="deleteField('${field.id}'); event.stopPropagation();" style="padding: 4px 8px; font-size: 12px;">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                    ${renderFieldPreview(field)}
                </div>
            `).join('');
        }

        function renderFieldPreview(field) {
            switch (field.type) {
                case 'text':
                case 'email':
                case 'phone':
                case 'number':
                    return `<input type="${field.type}" placeholder="${field.placeholder || 'Enter ' + field.label.toLowerCase()}" disabled style="opacity: 0.6; cursor: not-allowed;">`;
                case 'textarea':
                    return `<textarea placeholder="${field.placeholder || 'Enter ' + field.label.toLowerCase()}" disabled style="opacity: 0.6; cursor: not-allowed;"></textarea>`;
                case 'select':
                    return `<select disabled style="opacity: 0.6; cursor: not-allowed;">${field.options.map(o => `<option>${o}</option>`).join('')}</select>`;
                case 'checkbox':
                case 'radio':
                    return field.options.map(o => `<label style="display: flex; align-items: center; gap: 8px; margin: 8px 0;"><input type="${field.type}" disabled style="cursor: not-allowed;"> ${o}</label>`).join('');
                case 'file':
                    return `<input type="file" disabled style="opacity: 0.6; cursor: not-allowed;">`;
                case 'date':
                    return `<input type="date" disabled style="opacity: 0.6; cursor: not-allowed;">`;
                default:
                    return '';
            }
        }

        function editField(fieldId) {
            const form = forms[currentFormId];
            const field = form.fields.find(f => f.id === fieldId);
            if (!field) return;

            currentFieldId = fieldId;
            const editor = document.getElementById('fieldEditor');

            editor.innerHTML = `
                <div style="text-align: left;">
                    <div class="input-group">
                        <label>Field Label</label>
                        <input type="text" value="${field.label}" oninput="updateField('label', this.value)">
                    </div>
                    <div class="input-group">
                        <label>Field Type</label>
                        <select disabled style="opacity: 0.6;">
                            <option>${field.type}</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Placeholder</label>
                        <input type="text" value="${field.placeholder || ''}" oninput="updateField('placeholder', this.value)">
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="fieldRequired" ${field.required ? 'checked' : ''} onchange="updateField('required', this.checked)">
                        <label for="fieldRequired" style="margin: 0;">Required Field</label>
                    </div>
                    ${field.options ? `
                        <div class="input-group">
                            <label>Options</label>
                            <div class="field-options">
                                ${field.options.map((opt, idx) => `
                                    <div class="option-item">
                                        <input type="text" value="${opt}" oninput="updateFieldOption(${idx}, this.value)" style="flex: 1;">
                                        <button class="btn btn-danger" onclick="deleteFieldOption(${idx})" style="padding: 2px 6px; font-size: 11px;">Remove</button>
                                    </div>
                                `).join('')}
                            </div>
                            <button class="btn btn-primary" onclick="addFieldOption()" style="width: 100%; margin-top: 8px;">
                                <i class="fas fa-plus"></i> Add Option
                            </button>
                        </div>
                    ` : ''}
                    <button class="btn btn-danger" onclick="deleteField('${fieldId}')" style="width: 100%; margin-top: 15px;">
                        <i class="fas fa-trash"></i> Delete Field
                    </button>
                </div>
            `;
        }

        function updateField(property, value) {
            const form = forms[currentFormId];
            const field = form.fields.find(f => f.id === currentFieldId);
            if (field) {
                field[property] = value;
                renderFormPreview();
            }
        }

        function updateFieldOption(idx, value) {
            const form = forms[currentFormId];
            const field = form.fields.find(f => f.id === currentFieldId);
            if (field) {
                field.options[idx] = value;
            }
        }

        function addFieldOption() {
            const form = forms[currentFormId];
            const field = form.fields.find(f => f.id === currentFieldId);
            if (field && field.options) {
                field.options.push('New Option');
                editField(currentFieldId);
            }
        }

        function deleteFieldOption(idx) {
            const form = forms[currentFormId];
            const field = form.fields.find(f => f.id === currentFieldId);
            if (field && field.options) {
                field.options.splice(idx, 1);
                editField(currentFieldId);
            }
        }

        function deleteField(fieldId) {
            const form = forms[currentFormId];
            form.fields = form.fields.filter(f => f.id !== fieldId);
            document.getElementById('fieldEditor').innerHTML = `
                <div style="color: #999; padding: 40px 20px; text-align: center;">
                    <i class="fas fa-hand-pointer" style="font-size: 40px; opacity: 0.5; margin-bottom: 15px;"></i>
                    <p>Click a field to edit</p>
                </div>
            `;
            renderFormPreview();
        }

        function saveForm() {
            const form = forms[currentFormId];
            form.name = document.getElementById('formName').value;
            localStorage.setItem(FORMS_KEY, JSON.stringify(forms));
            loadFormsList();
            document.querySelector('.status-message') ? null : 
                document.querySelector('.section').insertAdjacentHTML('afterend', 
                '<div class="status-message status-success"><i class="fas fa-check-circle"></i> Form saved successfully!</div>');
        }

        function loadFormsList() {
            const tbody = document.getElementById('formsTable');
            
            if (Object.keys(forms).length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 40px;"><i class="fas fa-inbox" style="font-size: 32px; color: #ccc; margin-bottom: 10px;"></i><p style="color: #999;">No forms yet. Create one to get started.</p></td></tr>`;
                return;
            }

            tbody.innerHTML = Object.values(forms).map(form => {
                const created = new Date(form.created).toLocaleDateString();
                const subs = JSON.parse(localStorage.getItem(SUBMISSIONS_KEY) || '{}')[form.id] || [];
                
                return `
                    <tr>
                        <td>${form.name}</td>
                        <td>${form.fields.length}</td>
                        <td>${created}</td>
                        <td>${subs.length}</td>
                        <td>
                            <button class="btn btn-primary" onclick="editForm('${form.id}')" style="padding: 6px 12px; font-size: 12px;">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-danger" onclick="deleteForm('${form.id}')" style="padding: 6px 12px; font-size: 12px;">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function editForm(formId) {
            currentFormId = formId;
            document.getElementById('formName').value = forms[formId].name;
            renderFormPreview();
        }

        function deleteForm(formId) {
            if (!confirm('Delete this form?')) return;
            delete forms[formId];
            localStorage.setItem(FORMS_KEY, JSON.stringify(forms));
            loadFormsList();
            if (currentFormId === formId) {
                currentFormId = Object.keys(forms)[0] || null;
            }
        }

        function getFieldIcon(type) {
            const icons = {
                text: 'font',
                email: 'envelope',
                phone: 'phone',
                number: 'calculator',
                textarea: 'align-left',
                select: 'list',
                checkbox: 'check-square',
                radio: 'dot-circle',
                file: 'file',
                date: 'calendar'
            };
            return icons[type] || 'question';
        }

        function switchTab(tabName) {
            document.querySelectorAll('[id*="-tab"]').forEach(el => el.style.display = 'none');
            document.getElementById(tabName + '-tab').style.display = 'block';
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function loadSubmissions() {
            // Placeholder
        }

        function saveEmailSettings() {
            const settings = {
                smtpServer: document.getElementById('smtpServer').value,
                smtpPort: document.getElementById('smtpPort').value,
                smtpEmail: document.getElementById('smtpEmail').value,
                notifyEmail: document.getElementById('notifyEmail').value
            };
            localStorage.setItem(EMAIL_SETTINGS_KEY, JSON.stringify(settings));
            document.getElementById('settingsStatus').innerHTML = '<div class="status-message status-success"><i class="fas fa-check-circle"></i> Email settings saved!</div>';
        }

        function exportSubmissionsCSV() {
            // Placeholder
        }
    </script>
</body>
</html>
