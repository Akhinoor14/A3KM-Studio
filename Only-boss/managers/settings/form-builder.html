<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- Universal Mobile Optimization System -->
    <link rel="stylesheet" href="../../../Optimization/mobile-universal.css">
    <script src="../../../Optimization/mobile-universal.js" defer></script>
    
    <title>Form Builder - A3KM Studio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: white; border-radius: 20px; padding: 30px; margin-bottom: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .header h1 { color: #333; font-size: 28px; display: flex; align-items: center; gap: 15px; margin-bottom: 10px; }
        .builder { display: grid; grid-template-columns: 300px 1fr 300px; gap: 20px; margin-bottom: 30px; }
        .panel { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); }
        .panel-title { font-size: 16px; font-weight: 600; color: #333; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #fa709a; display: flex; align-items: center; gap: 8px; }
        .section { background: white; border-radius: 15px; padding: 25px; margin-bottom: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); }
        .section-title { font-size: 18px; font-weight: 600; color: #333; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; padding-bottom: 15px; border-bottom: 2px solid #fa709a; }
        .btn { padding: 10px 15px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, #fa709a, #fee140); color: #333; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(250, 112, 154, 0.4); }
        .btn-secondary { background: #9e9e9e; color: white; }
        .btn-secondary:hover { background: #757575; }
        .btn-danger { background: #f44336; color: white; }
        .btn-danger:hover { background: #da190b; }
        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
        .field-buttons { display: grid; gap: 8px; }
        .field-btn { padding: 10px; text-align: left; background: #f5f5f5; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 13px; }
        .field-btn:hover { background: #fff9f0; border-color: #fa709a; }
        .field-btn i { margin-right: 8px; color: #fa709a; }
        .form-preview { min-height: 400px; border: 2px dashed #ddd; border-radius: 8px; padding: 20px; background: #f9f9f9; }
        .form-field { background: white; border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px; margin: 15px 0; position: relative; }
        .form-field:hover { border-color: #fa709a; box-shadow: 0 3px 10px rgba(250, 112, 154, 0.2); }
        .form-field-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .form-field-label { font-weight: 600; color: #333; }
        .form-field-actions { display: flex; gap: 5px; }
        .form-field-actions button { padding: 4px 8px; font-size: 12px; }
        .input-group { margin: 12px 0; }
        .input-group label { display: block; font-weight: 500; color: #333; margin-bottom: 6px; font-size: 13px; }
        .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 13px; font-family: inherit; }
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus { outline: none; border-color: #fa709a; background: #fffbf5; }
        .checkbox-group { display: flex; align-items: center; gap: 8px; margin: 10px 0; }
        .checkbox-group input[type="checkbox"], .checkbox-group input[type="radio"] { cursor: pointer; }
        .field-options { max-height: 200px; overflow-y: auto; }
        .option-item { display: flex; align-items: center; gap: 8px; padding: 8px; background: #f9f9f9; border-radius: 4px; margin: 5px 0; }
        .option-item button { padding: 2px 6px; font-size: 11px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; }
        .tab-btn { padding: 12px 20px; border: none; background: transparent; color: #666; font-weight: 500; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .tab-btn:hover { color: #fa709a; }
        .tab-btn.active { color: #fa709a; border-bottom-color: #fa709a; }
        .status-message { padding: 12px 15px; border-radius: 8px; margin: 15px 0; font-weight: 500; }
        .status-success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .status-error { background: #f8d7da; color: #721c24; border-left: 4px solid #f44336; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #f5f5f5; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        /* Help Panel */
        .help-btn { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #fa709a, #fee140); color: #333; border: none; font-size: 24px; cursor: pointer; box-shadow: 0 5px 20px rgba(0,0,0,0.3); z-index: 999; transition: all 0.3s; }
        .help-btn:hover { transform: scale(1.1); }
        .help-panel { position: fixed; top: 0; right: -400px; width: 400px; height: 100vh; background: white; box-shadow: -5px 0 20px rgba(0,0,0,0.3); z-index: 1000; transition: right 0.3s; overflow-y: auto; padding: 20px; }
        .help-panel.active { right: 0; }
        .help-close { position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
        .help-section { margin: 20px 0; padding: 15px; border-left: 4px solid #fa709a; background: #fffbf5; border-radius: 5px; }
        .help-section h3 { color: #fa709a; margin-bottom: 10px; font-size: 16px; }
        .help-section ul { margin-left: 20px; }
        .help-section li { margin: 8px 0; line-height: 1.6; }
        /* Templates */
        .template-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .template-card { background: white; border: 2px solid #e0e0e0; border-radius: 10px; padding: 15px; cursor: pointer; transition: all 0.3s; text-align: center; }
        .template-card:hover { border-color: #fa709a; transform: translateY(-3px); box-shadow: 0 5px 15px rgba(250,112,154,0.3); }
        .template-icon { font-size: 32px; color: #fa709a; margin-bottom: 10px; }
        .template-title { font-weight: 600; color: #333; margin-bottom: 5px; }
        .template-desc { font-size: 12px; color: #666; }
        /* Drag and Drop */
        .form-field.dragging { opacity: 0.5; }
        .form-field.drag-over { border-top: 3px solid #fa709a; }
        /* Form Themes */
        .theme-selector { display: flex; gap: 10px; margin: 15px 0; }
        .theme-option { width: 40px; height: 40px; border-radius: 8px; cursor: pointer; border: 3px solid transparent; transition: all 0.3s; }
        .theme-option:hover, .theme-option.active { border-color: #333; transform: scale(1.1); }
        /* Analytics */
        .analytics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .analytics-card { background: linear-gradient(135deg, #fa709a, #fee140); color: #333; padding: 20px; border-radius: 12px; text-align: center; }
        .analytics-card h3 { font-size: 32px; margin-bottom: 5px; }
        .analytics-card p { font-size: 12px; opacity: 0.8; }
        /* Code Display */
        .code-block { background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 13px; overflow-x: auto; margin: 15px 0; }
        .copy-btn { position: absolute; top: 10px; right: 10px; }
        @media (max-width: 1024px) {
            .builder { grid-template-columns: 1fr; }
            .help-panel { width: 100%; right: -100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-wpforms"></i> Form Builder</h1>
            <p>Create custom forms without coding</p>
        </div>

        <!-- Builder Section -->
        <div class="builder">
            <!-- Field Palette -->
            <div class="panel">
                <div class="panel-title"><i class="fas fa-layer-group"></i> Quick Start Templates</div>
                <div class="template-grid">
                    <div class="template-card" onclick="loadTemplate('contact')">
                        <div class="template-icon"><i class="fas fa-envelope"></i></div>
                        <div class="template-title">Contact Form</div>
                        <div class="template-desc">Name, Email, Message</div>
                    </div>
                    <div class="template-card" onclick="loadTemplate('registration')">
                        <div class="template-icon"><i class="fas fa-user-plus"></i></div>
                        <div class="template-title">Registration</div>
                        <div class="template-desc">Full signup form</div>
                    </div>
                    <div class="template-card" onclick="loadTemplate('survey')">
                        <div class="template-icon"><i class="fas fa-poll"></i></div>
                        <div class="template-title">Survey</div>
                        <div class="template-desc">Multiple choice</div>
                    </div>
                    <div class="template-card" onclick="loadTemplate('feedback')">
                        <div class="template-icon"><i class="fas fa-star"></i></div>
                        <div class="template-title">Feedback</div>
                        <div class="template-desc">Rating & comments</div>
                    </div>
                </div>
                
                <div class="panel-title"><i class="fas fa-shapes"></i> Field Types</div>
                <div class="field-buttons">
                    <button class="field-btn" onclick="addField('text')"><i class="fas fa-font"></i> Text Input</button>
                    <button class="field-btn" onclick="addField('email')"><i class="fas fa-envelope"></i> Email</button>
                    <button class="field-btn" onclick="addField('phone')"><i class="fas fa-phone"></i> Phone</button>
                    <button class="field-btn" onclick="addField('number')"><i class="fas fa-calculator"></i> Number</button>
                    <button class="field-btn" onclick="addField('textarea')"><i class="fas fa-align-left"></i> Textarea</button>
                    <button class="field-btn" onclick="addField('select')"><i class="fas fa-list"></i> Dropdown</button>
                    <button class="field-btn" onclick="addField('checkbox')"><i class="fas fa-check-square"></i> Checkbox</button>
                    <button class="field-btn" onclick="addField('radio')"><i class="fas fa-dot-circle"></i> Radio</button>
                    <button class="field-btn" onclick="addField('file')"><i class="fas fa-file"></i> File Upload</button>
                    <button class="field-btn" onclick="addField('date')"><i class="fas fa-calendar"></i> Date</button>
                </div>
                
                <div class="panel-title" style="margin-top: 20px;"><i class="fas fa-cogs"></i> Settings</div>
                <div class="input-group">
                    <label for="formName">Form Name</label>
                    <input type="text" id="formName" placeholder="e.g., Contact Form" value="New Form">
                </div>
                <div class="input-group">
                    <label>Form Theme</label>
                    <div class="theme-selector">
                        <div class="theme-option active" onclick="setTheme('default')" style="background: linear-gradient(135deg, #fa709a, #fee140);" title="Default"></div>
                        <div class="theme-option" onclick="setTheme('blue')" style="background: linear-gradient(135deg, #667eea, #764ba2);" title="Blue"></div>
                        <div class="theme-option" onclick="setTheme('green')" style="background: linear-gradient(135deg, #11998e, #38ef7d);" title="Green"></div>
                        <div class="theme-option" onclick="setTheme('dark')" style="background: linear-gradient(135deg, #2c3e50, #34495e);" title="Dark"></div>
                    </div>
                </div>
                <div class="input-group">
                    <label>
                        <input type="checkbox" id="formRequired" checked> Mark new fields as required
                    </label>
                </div>
                <div class="btn-group" style="display: grid; gap: 8px; margin-top: 15px;">
                    <button class="btn btn-primary" onclick="saveForm()" style="width: 100%;">
                        <i class="fas fa-save"></i> Save Form
                    </button>
                    <button class="btn btn-secondary" onclick="exportFormHTML()" style="width: 100%;">
                        <i class="fas fa-code"></i> Get HTML Code
                    </button>
                    <button class="btn btn-secondary" onclick="deployForm()" style="width: 100%;">
                        <i class="fas fa-cloud-upload-alt"></i> Deploy to GitHub
                    </button>
                </div>
            </div>

            <!-- Form Preview -->
            <div class="panel">
                <div class="panel-title"><i class="fas fa-eye"></i> Form Preview</div>
                <div class="form-preview" id="formPreview">
                    <div style="text-align: center; color: #999; padding: 80px 20px;">
                        <i class="fas fa-plus-circle" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p>Add fields from the left panel</p>
                    </div>
                </div>
            </div>

            <!-- Field Editor -->
            <div class="panel">
                <div class="panel-title"><i class="fas fa-edit"></i> Field Editor</div>
                <div id="fieldEditor" style="color: #999; padding: 40px 20px; text-align: center;">
                    <i class="fas fa-hand-pointer" style="font-size: 40px; opacity: 0.5; margin-bottom: 15px;"></i>
                    <p>Click a field to edit</p>
                </div>
            </div>
        </div>

        <!-- Analytics Dashboard -->
        <div class="section">
            <div class="section-title"><i class="fas fa-chart-line"></i> Form Analytics</div>
            <div class="analytics-grid" id="analyticsGrid">
                <div class="analytics-card">
                    <h3 id="statTotalForms">0</h3>
                    <p>üìù Total Forms</p>
                </div>
                <div class="analytics-card">
                    <h3 id="statTotalFields">0</h3>
                    <p>üî§ Total Fields</p>
                </div>
                <div class="analytics-card">
                    <h3 id="statSubmissions">0</h3>
                    <p>üì¨ Submissions</p>
                </div>
                <div class="analytics-card">
                    <h3 id="statThisWeek">0</h3>
                    <p>üìä This Week</p>
                </div>
            </div>
        </div>

        <!-- Manage Forms Section -->
        <div class="section">
            <div class="section-title"><i class="fas fa-list"></i> My Forms</div>
            
            <table>
                <thead>
                    <tr>
                        <th>Form Name</th>
                        <th>Fields</th>
                        <th>Created</th>
                        <th>Submissions</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="formsTable">
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px;">
                            <i class="fas fa-inbox" style="font-size: 32px; color: #ccc; margin-bottom: 10px;"></i>
                            <p style="color: #999;">No forms yet. Create one to get started.</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Submissions Section -->
        <div class="section">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('submissions')"><i class="fas fa-inbox"></i> Submissions</button>
                <button class="tab-btn" onclick="switchTab('settings')"><i class="fas fa-cog"></i> Email Settings</button>
            </div>

            <!-- Submissions Tab -->
            <div id="submissions-tab">
                <div class="input-group">
                    <label for="formSelectSubmissions">Select Form</label>
                    <select id="formSelectSubmissions" onchange="loadSubmissions()">
                        <option value="">All Forms</option>
                    </select>
                </div>

                <table style="margin-top: 20px;">
                    <thead>
                        <tr>
                            <th>Submitted</th>
                            <th>Sender</th>
                            <th>Data</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="submissionsTable">
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 40px;">
                                <i class="fas fa-inbox" style="font-size: 32px; color: #ccc; margin-bottom: 10px;"></i>
                                <p style="color: #999;">No submissions yet</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Email Settings Tab -->
            <div id="settings-tab" style="display: none;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div class="input-group">
                        <label for="smtpServer">SMTP Server</label>
                        <input type="text" id="smtpServer" placeholder="smtp.gmail.com">
                    </div>
                    <div class="input-group">
                        <label for="smtpPort">SMTP Port</label>
                        <input type="text" id="smtpPort" placeholder="587">
                    </div>
                    <div class="input-group">
                        <label for="smtpEmail">Email Address</label>
                        <input type="email" id="smtpEmail" placeholder="your-email@gmail.com">
                    </div>
                    <div class="input-group">
                        <label for="smtpPassword">Password</label>
                        <input type="password" id="smtpPassword" placeholder="App password">
                    </div>
                </div>
                <div class="input-group" style="margin-top: 20px;">
                    <label for="notifyEmail">Notification Email</label>
                    <input type="email" id="notifyEmail" placeholder="admin@example.com">
                </div>
                <button class="btn btn-primary" onclick="saveEmailSettings()" style="width: 100%; margin-top: 20px;">
                    <i class="fas fa-save"></i> Save Email Settings
                </button>
                <div id="settingsStatus"></div>
            </div>
        </div>

        <!-- CSV Export Section -->
        <div class="section">
            <div class="section-title"><i class="fas fa-download"></i> Export Data</div>
            <div class="input-group">
                <label for="exportForm">Select Form</label>
                <select id="exportForm"></select>
            </div>
            <button class="btn btn-primary" onclick="exportSubmissionsCSV()" style="width: 100%; margin-top: 15px;">
                <i class="fas fa-file-csv"></i> Export as CSV
            </button>
        </div>
    </div>

    <!-- Help Button -->
    <button class="help-btn" onclick="toggleHelp()" title="Help & Usage Guide">
        <i class="fas fa-question"></i>
    </button>

    <!-- Help Panel -->
    <div class="help-panel" id="helpPanel">
        <button class="help-close" onclick="toggleHelp()">
            <i class="fas fa-times"></i>
        </button>
        <h2 style="color: #fa709a; margin-bottom: 20px;">üìù Form Builder Guide</h2>
        
        <div class="help-section">
            <h3>üöÄ Quick Start</h3>
            <ol style="margin-left: 20px;">
                <li><strong>Choose a Template:</strong> Click on a quick start template (Contact, Registration, Survey, Feedback)</li>
                <li><strong>Or Build from Scratch:</strong> Click field types from the palette</li>
                <li><strong>Customize Fields:</strong> Click any field to edit its properties</li>
                <li><strong>Save:</strong> Click "Save Form" to store your form</li>
                <li><strong>Deploy:</strong> Get HTML code or deploy to GitHub</li>
            </ol>
        </div>

        <div class="help-section">
            <h3>üé® Form Templates</h3>
            <ul>
                <li><strong>Contact Form:</strong> Name, Email, Phone, Message</li>
                <li><strong>Registration:</strong> Full Name, Email, Password, Terms</li>
                <li><strong>Survey:</strong> Multiple choice questions</li>
                <li><strong>Feedback:</strong> Rating, comments, suggestions</li>
            </ul>
        </div>

        <div class="help-section">
            <h3>üîß Field Types</h3>
            <ul>
                <li><strong>Text Input:</strong> Single line text</li>
                <li><strong>Email:</strong> Email validation</li>
                <li><strong>Phone:</strong> Phone number</li>
                <li><strong>Number:</strong> Numeric input</li>
                <li><strong>Textarea:</strong> Multi-line text</li>
                <li><strong>Dropdown:</strong> Select from options</li>
                <li><strong>Checkbox:</strong> Multiple selections</li>
                <li><strong>Radio:</strong> Single selection</li>
                <li><strong>File Upload:</strong> Attach files</li>
                <li><strong>Date:</strong> Date picker</li>
            </ul>
        </div>

        <div class="help-section">
            <h3>‚úèÔ∏è Editing Fields</h3>
            <ul>
                <li>Click any field in the preview to edit</li>
                <li>Change label, placeholder text</li>
                <li>Toggle required/optional</li>
                <li>Add/remove/edit options (dropdown, radio, checkbox)</li>
                <li>Drag fields to reorder (upcoming)</li>
            </ul>
        </div>

        <div class="help-section">
            <h3>üé® Form Themes</h3>
            <ul>
                <li><strong>Default:</strong> Pink gradient (fa709a ‚Üí fee140)</li>
                <li><strong>Blue:</strong> Purple-blue gradient</li>
                <li><strong>Green:</strong> Teal gradient</li>
                <li><strong>Dark:</strong> Professional dark theme</li>
            </ul>
        </div>

        <div class="help-section">
            <h3>üöÄ Deployment Options</h3>
            <ul>
                <li><strong>Get HTML Code:</strong> Copy/paste to your website</li>
                <li><strong>Deploy to GitHub:</strong> Automatically push to repository</li>
                <li><strong>Export JSON:</strong> Form structure for developers</li>
                <li><strong>Embed Code:</strong> iframe embed code</li>
            </ul>
        </div>

        <div class="help-section">
            <h3>üìä Analytics & Submissions</h3>
            <ul>
                <li>View total forms, fields, submissions</li>
                <li>Track weekly submission trends</li>
                <li>Export submissions as CSV</li>
                <li>Email notifications for new submissions</li>
            </ul>
        </div>

        <div class="help-section">
            <h3>üìß Email Integration</h3>
            <ul>
                <li>Configure SMTP settings (Gmail, Outlook, etc.)</li>
                <li>Set notification email address</li>
                <li>Auto-send submission notifications</li>
                <li>Custom email templates</li>
            </ul>
        </div>

        <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-top: 20px;">
            <strong>üí° Pro Tips:</strong>
            <ul style="margin-top: 10px; margin-left: 20px; font-size: 13px;">
                <li>Use templates for quick setup</li>
                <li>Test form before deploying</li>
                <li>Keep forms simple and focused</li>
                <li>Use placeholders to guide users</li>
                <li>Enable validation for data quality</li>
            </ul>
        </div>
    </div>

    <script src="../../shared/github-token-manager.js"></script>
    <script src="../../shared/activity-logger.js"></script>
    <script>
        const FORMS_KEY = 'a3km_forms';
        const SUBMISSIONS_KEY = 'a3km_form_submissions';
        const EMAIL_SETTINGS_KEY = 'a3km_email_settings';
        let tokenManager = null;
        
        let forms = {};
        let currentFormId = null;
        let currentFieldId = null;
        let fieldCounter = 0;

        document.addEventListener('DOMContentLoaded', () => {
            tokenManager = typeof GitHubTokenManager !== 'undefined' ? new GitHubTokenManager() : null;
            loadForms();
            loadFormsList();
            updateAnalytics();
            
            // Activity logging
            if (typeof ActivityLogger !== 'undefined') {
                ActivityLogger.log('system', 'Form Builder opened', 'Admin', 'success', 'Form management interface accessed');
            }
            
            // Live update every 4 seconds
            setInterval(() => {
                loadForms();
                loadFormsList();
                updateAnalytics();
            }, 4000);
        });

        function loadForms() {
            forms = JSON.parse(localStorage.getItem(FORMS_KEY) || '{}');
            if (Object.keys(forms).length === 0) {
                currentFormId = 'form-' + Date.now();
                forms[currentFormId] = {
                    id: currentFormId,
                    name: 'New Form',
                    fields: [],
                    created: new Date().toISOString(),
                    settings: {}
                };
            } else {
                currentFormId = Object.keys(forms)[0];
            }
        }

        function addField(type) {
            if (!currentFormId) return;
            
            const fieldId = 'field-' + (++fieldCounter);
            const field = {
                id: fieldId,
                type: type,
                label: type.charAt(0).toUpperCase() + type.slice(1),
                required: document.getElementById('formRequired').checked,
                placeholder: '',
                options: type === 'select' || type === 'radio' || type === 'checkbox' ? ['Option 1'] : []
            };

            forms[currentFormId].fields.push(field);
            renderFormPreview();
        }

        function renderFormPreview() {
            const form = forms[currentFormId];
            const preview = document.getElementById('formPreview');

            if (!form || form.fields.length === 0) {
                preview.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 80px 20px;">
                        <i class="fas fa-plus-circle" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p>Add fields from the left panel</p>
                    </div>
                `;
                return;
            }

            preview.innerHTML = form.fields.map((field, idx) => `
                <div class="form-field" onclick="editField('${field.id}')">
                    <div class="form-field-header">
                        <div class="form-field-label">
                            <i class="fas fa-${getFieldIcon(field.type)}"></i> ${field.label}
                            ${field.required ? '<span style="color: #f44336;">*</span>' : ''}
                        </div>
                        <div class="form-field-actions">
                            <button class="btn btn-secondary" onclick="editField('${field.id}'); event.stopPropagation();" style="padding: 4px 8px; font-size: 12px;">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-danger" onclick="deleteField('${field.id}'); event.stopPropagation();" style="padding: 4px 8px; font-size: 12px;">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                    ${renderFieldPreview(field)}
                </div>
            `).join('');
        }

        function renderFieldPreview(field) {
            switch (field.type) {
                case 'text':
                case 'email':
                case 'phone':
                case 'number':
                    return `<input type="${field.type}" placeholder="${field.placeholder || 'Enter ' + field.label.toLowerCase()}" disabled style="opacity: 0.6; cursor: not-allowed;">`;
                case 'textarea':
                    return `<textarea placeholder="${field.placeholder || 'Enter ' + field.label.toLowerCase()}" disabled style="opacity: 0.6; cursor: not-allowed;"></textarea>`;
                case 'select':
                    return `<select disabled style="opacity: 0.6; cursor: not-allowed;">${field.options.map(o => `<option>${o}</option>`).join('')}</select>`;
                case 'checkbox':
                case 'radio':
                    return field.options.map(o => `<label style="display: flex; align-items: center; gap: 8px; margin: 8px 0;"><input type="${field.type}" disabled style="cursor: not-allowed;"> ${o}</label>`).join('');
                case 'file':
                    return `<input type="file" disabled style="opacity: 0.6; cursor: not-allowed;">`;
                case 'date':
                    return `<input type="date" disabled style="opacity: 0.6; cursor: not-allowed;">`;
                default:
                    return '';
            }
        }

        function editField(fieldId) {
            const form = forms[currentFormId];
            const field = form.fields.find(f => f.id === fieldId);
            if (!field) return;

            currentFieldId = fieldId;
            const editor = document.getElementById('fieldEditor');

            editor.innerHTML = `
                <div style="text-align: left;">
                    <div class="input-group">
                        <label>Field Label</label>
                        <input type="text" value="${field.label}" oninput="updateField('label', this.value)">
                    </div>
                    <div class="input-group">
                        <label>Field Type</label>
                        <select disabled style="opacity: 0.6;">
                            <option>${field.type}</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Placeholder</label>
                        <input type="text" value="${field.placeholder || ''}" oninput="updateField('placeholder', this.value)">
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="fieldRequired" ${field.required ? 'checked' : ''} onchange="updateField('required', this.checked)">
                        <label for="fieldRequired" style="margin: 0;">Required Field</label>
                    </div>
                    ${field.options ? `
                        <div class="input-group">
                            <label>Options</label>
                            <div class="field-options">
                                ${field.options.map((opt, idx) => `
                                    <div class="option-item">
                                        <input type="text" value="${opt}" oninput="updateFieldOption(${idx}, this.value)" style="flex: 1;">
                                        <button class="btn btn-danger" onclick="deleteFieldOption(${idx})" style="padding: 2px 6px; font-size: 11px;">Remove</button>
                                    </div>
                                `).join('')}
                            </div>
                            <button class="btn btn-primary" onclick="addFieldOption()" style="width: 100%; margin-top: 8px;">
                                <i class="fas fa-plus"></i> Add Option
                            </button>
                        </div>
                    ` : ''}
                    <button class="btn btn-danger" onclick="deleteField('${fieldId}')" style="width: 100%; margin-top: 15px;">
                        <i class="fas fa-trash"></i> Delete Field
                    </button>
                </div>
            `;
        }

        function updateField(property, value) {
            const form = forms[currentFormId];
            const field = form.fields.find(f => f.id === currentFieldId);
            if (field) {
                field[property] = value;
                renderFormPreview();
            }
        }

        function updateFieldOption(idx, value) {
            const form = forms[currentFormId];
            const field = form.fields.find(f => f.id === currentFieldId);
            if (field) {
                field.options[idx] = value;
            }
        }

        function addFieldOption() {
            const form = forms[currentFormId];
            const field = form.fields.find(f => f.id === currentFieldId);
            if (field && field.options) {
                field.options.push('New Option');
                editField(currentFieldId);
            }
        }

        function deleteFieldOption(idx) {
            const form = forms[currentFormId];
            const field = form.fields.find(f => f.id === currentFieldId);
            if (field && field.options) {
                field.options.splice(idx, 1);
                editField(currentFieldId);
            }
        }

        function deleteField(fieldId) {
            const form = forms[currentFormId];
            form.fields = form.fields.filter(f => f.id !== fieldId);
            document.getElementById('fieldEditor').innerHTML = `
                <div style="color: #999; padding: 40px 20px; text-align: center;">
                    <i class="fas fa-hand-pointer" style="font-size: 40px; opacity: 0.5; margin-bottom: 15px;"></i>
                    <p>Click a field to edit</p>
                </div>
            `;
            renderFormPreview();
        }

        function saveForm() {
            const form = forms[currentFormId];
            form.name = document.getElementById('formName').value;
            localStorage.setItem(FORMS_KEY, JSON.stringify(forms));
            loadFormsList();
            document.querySelector('.status-message') ? null : 
                document.querySelector('.section').insertAdjacentHTML('afterend', 
                '<div class="status-message status-success"><i class="fas fa-check-circle"></i> Form saved successfully!</div>');
        }

        function loadFormsList() {
            const tbody = document.getElementById('formsTable');
            
            if (Object.keys(forms).length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 40px;"><i class="fas fa-inbox" style="font-size: 32px; color: #ccc; margin-bottom: 10px;"></i><p style="color: #999;">No forms yet. Create one to get started.</p></td></tr>`;
                return;
            }

            tbody.innerHTML = Object.values(forms).map(form => {
                const created = new Date(form.created).toLocaleDateString();
                const subs = JSON.parse(localStorage.getItem(SUBMISSIONS_KEY) || '{}')[form.id] || [];
                
                return `
                    <tr>
                        <td>${form.name}</td>
                        <td>${form.fields.length}</td>
                        <td>${created}</td>
                        <td>${subs.length}</td>
                        <td>
                            <button class="btn btn-primary" onclick="editForm('${form.id}')" style="padding: 6px 12px; font-size: 12px;">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-danger" onclick="deleteForm('${form.id}')" style="padding: 6px 12px; font-size: 12px;">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function editForm(formId) {
            currentFormId = formId;
            document.getElementById('formName').value = forms[formId].name;
            renderFormPreview();
        }

        function deleteForm(formId) {
            if (!confirm('Delete this form?')) return;
            delete forms[formId];
            localStorage.setItem(FORMS_KEY, JSON.stringify(forms));
            loadFormsList();
            if (currentFormId === formId) {
                currentFormId = Object.keys(forms)[0] || null;
            }
        }

        function getFieldIcon(type) {
            const icons = {
                text: 'font',
                email: 'envelope',
                phone: 'phone',
                number: 'calculator',
                textarea: 'align-left',
                select: 'list',
                checkbox: 'check-square',
                radio: 'dot-circle',
                file: 'file',
                date: 'calendar'
            };
            return icons[type] || 'question';
        }

        function switchTab(tabName) {
            document.querySelectorAll('[id*="-tab"]').forEach(el => el.style.display = 'none');
            document.getElementById(tabName + '-tab').style.display = 'block';
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function loadSubmissions() {
            const formId = document.getElementById('formSelectSubmissions').value;
            if (!formId) {
                document.getElementById('submissionsTable').innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px; color: #999;"><i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>Select a form to view submissions</td></tr>';
                return;
            }

            const submissions = JSON.parse(localStorage.getItem(SUBMISSIONS_KEY) || '{}')[formId] || [];

            if (submissions.length === 0) {
                document.getElementById('submissionsTable').innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px; color: #999;"><i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>No submissions yet for this form</td></tr>';
                return;
            }

            document.getElementById('submissionsTable').innerHTML = submissions.map((sub, index) => {
                const date = new Date(sub.timestamp).toLocaleString();
                const sender = sub.data.email || sub.data.name || 'Anonymous';
                const dataPreview = JSON.stringify(sub.data).substring(0, 80) + '...';

                return `
                    <tr>
                        <td>${date}</td>
                        <td>${sender}</td>
                        <td><code style="font-size: 11px; color: #666;">${dataPreview}</code></td>
                        <td>
                            <button class="btn btn-primary" onclick='viewSubmissionDetails(${JSON.stringify(sub).replace(/'/g, "&apos;")})' style="padding: 5px 12px; font-size: 12px;">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function viewSubmissionDetails(submission) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; max-height: 80vh; overflow-y: auto; position: relative;">
                    <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 15px; right: 15px; background: #f44336; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">Close</button>
                    <h2 style="color: #fa709a; margin-bottom: 20px;">üì¨ Submission Details</h2>
                    <p style="color: #666; margin-bottom: 20px;"><strong>Submitted:</strong> ${new Date(submission.timestamp).toLocaleString()}</p>
                    <div style="background: #f5f5f5; padding: 20px; border-radius: 8px;">
                        ${Object.entries(submission.data).map(([key, value]) => `
                            <div style="margin-bottom: 15px;">
                                <strong style="color: #333;">${key}:</strong><br>
                                <span style="color: #666;">${Array.isArray(value) ? value.join(', ') : value}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveEmailSettings() {
            const settings = {
                smtpServer: document.getElementById('smtpServer').value,
                smtpPort: document.getElementById('smtpPort').value,
                smtpEmail: document.getElementById('smtpEmail').value,
                notifyEmail: document.getElementById('notifyEmail').value
            };
            localStorage.setItem(EMAIL_SETTINGS_KEY, JSON.stringify(settings));
            document.getElementById('settingsStatus').innerHTML = '<div class="status-message status-success"><i class="fas fa-check-circle"></i> Email settings saved!</div>';
        }

        function exportSubmissionsCSV() {
            // Placeholder
        }

        // NEW COMPREHENSIVE FUNCTIONS

        function loadTemplate(templateName) {
            const templates = {
                contact: {
                    name: 'Contact Form',
                    fields: [
                        { id: 'field-1', type: 'text', label: 'Full Name', required: true, placeholder: 'Enter your full name', options: [] },
                        { id: 'field-2', type: 'email', label: 'Email Address', required: true, placeholder: 'your@email.com', options: [] },
                        { id: 'field-3', type: 'phone', label: 'Phone Number', required: false, placeholder: '+1234567890', options: [] },
                        { id: 'field-4', type: 'textarea', label: 'Message', required: true, placeholder: 'Write your message here...', options: [] }
                    ]
                },
                registration: {
                    name: 'Registration Form',
                    fields: [
                        { id: 'field-1', type: 'text', label: 'Full Name', required: true, placeholder: 'John Doe', options: [] },
                        { id: 'field-2', type: 'email', label: 'Email', required: true, placeholder: 'john@example.com', options: [] },
                        { id: 'field-3', type: 'text', label: 'Password', required: true, placeholder: 'Create a strong password', options: [] },
                        { id: 'field-4', type: 'date', label: 'Date of Birth', required: true, placeholder: '', options: [] },
                        { id: 'field-5', type: 'checkbox', label: 'I agree to Terms & Conditions', required: true, placeholder: '', options: ['I agree'] }
                    ]
                },
                survey: {
                    name: 'Survey Form',
                    fields: [
                        { id: 'field-1', type: 'radio', label: 'How satisfied are you?', required: true, placeholder: '', options: ['Very Satisfied', 'Satisfied', 'Neutral', 'Unsatisfied', 'Very Unsatisfied'] },
                        { id: 'field-2', type: 'checkbox', label: 'Which features do you use?', required: false, placeholder: '', options: ['Feature A', 'Feature B', 'Feature C', 'Feature D'] },
                        { id: 'field-3', type: 'select', label: 'How often do you visit?', required: true, placeholder: '', options: ['Daily', 'Weekly', 'Monthly', 'Rarely'] },
                        { id: 'field-4', type: 'textarea', label: 'Additional Comments', required: false, placeholder: 'Share your thoughts...', options: [] }
                    ]
                },
                feedback: {
                    name: 'Feedback Form',
                    fields: [
                        { id: 'field-1', type: 'text', label: 'Your Name', required: true, placeholder: 'Name', options: [] },
                        { id: 'field-2', type: 'radio', label: 'Overall Rating', required: true, placeholder: '', options: ['‚≠ê 1 Star', '‚≠ê‚≠ê 2 Stars', '‚≠ê‚≠ê‚≠ê 3 Stars', '‚≠ê‚≠ê‚≠ê‚≠ê 4 Stars', '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5 Stars'] },
                        { id: 'field-3', type: 'textarea', label: 'What did you like?', required: false, placeholder: 'Tell us what you enjoyed...', options: [] },
                        { id: 'field-4', type: 'textarea', label: 'What can we improve?', required: false, placeholder: 'Suggestions for improvement...', options: [] }
                    ]
                }
            };

            const template = templates[templateName];
            if (!template) return;

            forms[currentFormId] = {
                id: currentFormId,
                name: template.name,
                fields: template.fields,
                created: new Date().toISOString(),
                settings: {}
            };

            document.getElementById('formName').value = template.name;
            fieldCounter = template.fields.length;
            renderFormPreview();

            // Log activity
            if (typeof ActivityLogger !== 'undefined') {
                ActivityLogger.log('edit', `Loaded ${template.name} template`, 'Admin', 'success', `${template.fields.length} fields added`);
            }
        }

        function setTheme(theme) {
            forms[currentFormId].theme = theme;
            document.querySelectorAll('.theme-option').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
        }

        function exportFormHTML() {
            const form = forms[currentFormId];
            if (!form || form.fields.length === 0) {
                alert('‚ùå No fields to export!');
                return;
            }

            const html = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${form.name}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #fa709a, #fee140); min-height: 100vh; padding: 20px; }
        .form-container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        h1 { color: #fa709a; margin-bottom: 20px; }
        .field-group { margin: 20px 0; }
        label { display: block; font-weight: 600; color: #333; margin-bottom: 8px; }
        input, textarea, select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #fa709a; }
        button { background: linear-gradient(135deg, #fa709a, #fee140); color: #333; padding: 12px 30px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(250,112,154,0.4); }
    </style>
</head>
<body>
    <div class="form-container">
        <h1>${form.name}</h1>
        <form id="myForm">
${form.fields.map(field => {
    let html = `            <div class="field-group">
                <label>${field.label}${field.required ? ' <span style="color: #f44336;">*</span>' : ''}</label>`;
    
    if (field.type === 'textarea') {
        html += `\n                <textarea name="${field.id}" ${field.required ? 'required' : ''} placeholder="${field.placeholder}"></textarea>`;
    } else if (field.type === 'select') {
        html += `\n                <select name="${field.id}" ${field.required ? 'required' : ''}>
                    ${field.options.map(opt => `<option>${opt}</option>`).join('\n                    ')}
                </select>`;
    } else if (field.type === 'checkbox' || field.type === 'radio') {
        html += field.options.map(opt => `\n                <label style="display: flex; align-items: center; gap: 8px; margin: 8px 0;"><input type="${field.type}" name="${field.id}" value="${opt}" ${field.required ? 'required' : ''}> ${opt}</label>`).join('');
    } else {
        html += `\n                <input type="${field.type}" name="${field.id}" ${field.required ? 'required' : ''} placeholder="${field.placeholder}">`;
    }
    
    html += `\n            </div>`;
    return html;
}).join('\n')}
            <button type="submit">Submit</button>
        </form>
    </div>
    <script>
        document.getElementById('myForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            console.log('Form submitted:', Object.fromEntries(formData));
            alert('‚úÖ Form submitted successfully!');
        });
    </script>
</body>
</html>`;

            // Show in modal
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 800px; max-height: 80vh; overflow-y: auto; position: relative;">
                    <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 15px; right: 15px; background: #f44336; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">Close</button>
                    <h2 style="color: #fa709a; margin-bottom: 20px;">üìù Generated HTML Code</h2>
                    <p style="color: #666; margin-bottom: 15px;">Copy this code and paste it into your website:</p>
                    <div style="position: relative;">
                        <pre style="background: #2d2d2d; color: #f8f8f2; padding: 20px; border-radius: 8px; overflow-x: auto; font-size: 12px; line-height: 1.5;">${html.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
                        <button onclick="navigator.clipboard.writeText(\`${html.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`).then(() => alert('‚úÖ Copied to clipboard!')).catch(() => alert('‚ùå Copy failed'))" style="position: absolute; top: 10px; right: 10px; background: #4caf50; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">Copy Code</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Log activity
            if (typeof ActivityLogger !== 'undefined') {
                ActivityLogger.log('system', `Exported HTML for ${form.name}`, 'Admin', 'success', `${form.fields.length} fields exported`);
            }
        }

        async function deployForm() {
            if (!tokenManager || !tokenManager.token) {
                alert('‚ùå GitHub token not configured! Please set up token first.');
                return;
            }

            const form = forms[currentFormId];
            if (!form || form.fields.length === 0) {
                alert('‚ùå No fields to deploy!');
                return;
            }

            if (!confirm(`Deploy "${form.name}" to GitHub?\n\nThis will create a new HTML file in your repository.`)) return;

            alert('üöÄ GitHub deployment feature coming soon! Use "Get HTML Code" for now.');

            // Log activity
            if (typeof ActivityLogger !== 'undefined') {
                ActivityLogger.log('system', `Attempted GitHub deployment for ${form.name}`, 'Admin', 'info', 'Feature in development');
            }
        }

        function updateAnalytics() {
            const totalForms = Object.keys(forms).length;
            const totalFields = Object.values(forms).reduce((sum, f) => sum + f.fields.length, 0);
            const submissions = JSON.parse(localStorage.getItem(SUBMISSIONS_KEY) || '{}');
            const totalSubmissions = Object.values(submissions).reduce((sum, arr) => sum + arr.length, 0);

            // Calculate this week's submissions
            const weekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
            const thisWeekSubmissions = Object.values(submissions).flat().filter(sub => new Date(sub.timestamp) > weekAgo).length;

            document.getElementById('statTotalForms').textContent = totalForms;
            document.getElementById('statTotalFields').textContent = totalFields;
            document.getElementById('statSubmissions').textContent = totalSubmissions;
            document.getElementById('statThisWeek').textContent = thisWeekSubmissions;
        }

        function toggleHelp() {
            document.getElementById('helpPanel').classList.toggle('active');
        }
    </script>
</body>
</html>
