<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- Universal Mobile Optimization System -->
    <link rel="stylesheet" href="../../../Optimization/mobile-universal.css">
    <script src="../../../Optimization/mobile-universal.js" defer></script>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="../../../images/favicon.svg">
    
    <title>Activity Log - A3KM Studio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Mobile Optimization Styles -->
    <link rel="stylesheet" href="../../mobile/only-boss-global-mobile.css">
    <link rel="stylesheet" href="../../mobile/manager-mobile.css">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: white; border-radius: 20px; padding: 30px; margin-bottom: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .header h1 { color: #333; font-size: 28px; display: flex; align-items: center; gap: 15px; margin-bottom: 10px; }
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .section { background: white; border-radius: 15px; padding: 25px; margin-bottom: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); }
        .section-title { font-size: 20px; font-weight: 600; color: #333; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; padding-bottom: 15px; border-bottom: 2px solid #667eea; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4); }
        .btn-secondary { background: #9e9e9e; color: white; }
        .btn-secondary:hover { background: #757575; }
        .btn-danger { background: #f44336; color: white; }
        .btn-danger:hover { background: #da190b; }
        .input-group { display: flex; flex-direction: column; }
        .input-group label { font-weight: 500; color: #333; margin-bottom: 8px; }
        .input-group input, .input-group select { padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
        .input-group input:focus, .input-group select:focus { outline: none; border-color: #667eea; background: #f5f5ff; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 12px; text-align: center; }
        .stat-card h3 { font-size: 28px; margin-bottom: 5px; }
        .stat-card p { font-size: 12px; opacity: 0.9; }
        .timeline { position: relative; padding: 20px 0; }
        .timeline-item { display: flex; gap: 20px; margin-bottom: 25px; padding-left: 40px; position: relative; }
        .timeline-item::before { content: ''; position: absolute; left: 0; width: 16px; height: 16px; background: #667eea; border-radius: 50%; top: 5px; border: 3px solid white; box-shadow: 0 0 0 3px #667eea; }
        .timeline-item::after { content: ''; position: absolute; left: 7px; top: 25px; width: 2px; height: 100%; background: #e0e0e0; }
        .timeline-item:last-child::after { display: none; }
        .timeline-item.upload::before { background: #4caf50; box-shadow: 0 0 0 3px #4caf50; }
        .timeline-item.edit::before { background: #2196f3; box-shadow: 0 0 0 3px #2196f3; }
        .timeline-item.delete::before { background: #f44336; box-shadow: 0 0 0 3px #f44336; }
        .timeline-item.login::before { background: #ff9800; box-shadow: 0 0 0 3px #ff9800; }
        .timeline-content { flex: 1; }
        .timeline-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px; }
        .timeline-title { font-weight: 600; color: #333; }
        .timeline-time { font-size: 12px; color: #999; }
        .timeline-description { color: #666; font-size: 14px; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; margin-top: 8px; }
        .badge-upload { background: #d4edda; color: #155724; }
        .badge-edit { background: #d1ecf1; color: #0c5460; }
        .badge-delete { background: #f8d7da; color: #721c24; }
        .badge-login { background: #fff3cd; color: #856404; }
        .badge-system { background: #e2e3e5; color: #383d41; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #f5f5f5; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        th { font-weight: 600; color: #333; }
        tr:hover { background: #f9f9f9; }
        .empty-state { text-align: center; padding: 40px 20px; color: #999; }
        .empty-state i { font-size: 48px; opacity: 0.5; margin-bottom: 15px; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .modal-header { font-size: 20px; font-weight: 600; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #666; }
        /* Help Panel */
        .help-btn { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; font-size: 24px; cursor: pointer; box-shadow: 0 5px 20px rgba(0,0,0,0.3); z-index: 999; transition: all 0.3s; }
        .help-btn:hover { transform: scale(1.1); }
        .help-panel { position: fixed; top: 0; right: -400px; width: 400px; height: 100vh; background: white; box-shadow: -5px 0 20px rgba(0,0,0,0.3); z-index: 1000; transition: right 0.3s; overflow-y: auto; padding: 20px; }
        .help-panel.active { right: 0; }
        .help-close { position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
        .help-section { margin: 20px 0; padding: 15px; border-left: 4px solid #667eea; background: #f9f9ff; border-radius: 5px; }
        .help-section h3 { color: #667eea; margin-bottom: 10px; font-size: 16px; }
        .help-section ul { margin-left: 20px; }
        .help-section li { margin: 8px 0; line-height: 1.6; }
        /* Charts */
        .chart-container { background: #f5f5f5; border-radius: 10px; padding: 20px; margin: 15px 0; min-height: 200px; }
        .chart-bar { display: flex; align-items: center; margin: 10px 0; gap: 10px; }
        .chart-label { min-width: 80px; font-size: 13px; font-weight: 500; }
        .chart-bar-fill { height: 30px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 5px; display: flex; align-items: center; padding: 0 10px; color: white; font-size: 12px; font-weight: 600; transition: width 0.5s; }
        /* Activity Heatmap */
        .heatmap { display: grid; grid-template-columns: repeat(24, 1fr); gap: 3px; margin: 15px 0; }
        .heatmap-cell { aspect-ratio: 1; background: #e0e0e0; border-radius: 3px; cursor: pointer; transition: all 0.3s; }
        .heatmap-cell:hover { transform: scale(1.2); }
        .heatmap-legend { display: flex; gap: 10px; align-items: center; font-size: 12px; margin-top: 10px; }
        .heatmap-legend-item { display: flex; align-items: center; gap: 5px; }
        .heatmap-legend-box { width: 15px; height: 15px; border-radius: 3px; }
        /* Export Options */
        .export-dropdown { position: relative; display: inline-block; }
        .export-menu { display: none; position: absolute; top: 100%; left: 0; background: white; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); min-width: 150px; z-index: 100; }
        .export-dropdown.active .export-menu { display: block; }
        .export-menu-item { padding: 10px 15px; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 8px; }
        .export-menu-item:hover { background: #f5f5f5; }
        /* Live Monitor Badge */
        .live-badge { position: fixed; top: 20px; right: 20px; background: #4caf50; color: white; padding: 8px 15px; border-radius: 20px; font-size: 12px; font-weight: 600; z-index: 998; display: flex; align-items: center; gap: 8px; }
        .live-pulse { width: 8px; height: 8px; background: white; border-radius: 50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        @media (max-width: 768px) {
            .controls { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .timeline-item { padding-left: 30px; }
            .help-panel { width: 100%; right: -100%; }
            .heatmap { grid-template-columns: repeat(12, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-history"></i> Activity Log</h1>
            <p>Track all system activities and user actions</p>
        </div>

        <!-- Controls Section -->
        <div class="section">
            <div class="section-title"><i class="fas fa-filter"></i> Filter & Search</div>
            
            <div class="controls">
                <div class="input-group">
                    <label for="searchInput">Search Activity</label>
                    <input type="text" id="searchInput" placeholder="Search by description or user..." oninput="filterLogs()">
                </div>
                <div class="input-group">
                    <label for="typeFilter">Activity Type</label>
                    <select id="typeFilter" onchange="filterLogs()">
                        <option value="">All Types</option>
                        <option value="upload">Upload</option>
                        <option value="edit">Edit</option>
                        <option value="delete">Delete</option>
                        <option value="login">Login</option>
                        <option value="system">System</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="dateFromFilter">From Date</label>
                    <input type="date" id="dateFromFilter" onchange="filterLogs()">
                </div>
                <div class="input-group">
                    <label for="dateToFilter">To Date</label>
                    <input type="date" id="dateToFilter" onchange="filterLogs()">
                </div>
            </div>

            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
                <button class="btn btn-primary" onclick="refreshLogs()">
                    <i class="fas fa-sync"></i> Refresh
                </button>
                <button class="btn btn-primary" onclick="toggleTimeline()">
                    <i class="fas fa-stream"></i> Timeline View
                </button>
                <div class="export-dropdown" id="exportDropdown">
                    <button class="btn btn-secondary" onclick="toggleExportMenu()">
                        <i class="fas fa-download"></i> Export <i class="fas fa-chevron-down" style="font-size: 10px;"></i>
                    </button>
                    <div class="export-menu">
                        <div class="export-menu-item" onclick="exportLogs('csv')">
                            <i class="fas fa-file-csv"></i> CSV Format
                        </div>
                        <div class="export-menu-item" onclick="exportLogs('json')">
                            <i class="fas fa-file-code"></i> JSON Format
                        </div>
                        <div class="export-menu-item" onclick="exportLogs('pdf')">
                            <i class="fas fa-file-pdf"></i> PDF Report
                        </div>
                    </div>
                </div>
                <button class="btn btn-danger" onclick="clearLogs()">
                    <i class="fas fa-trash"></i> Clear All Logs
                </button>
            </div>
        </div>

        <!-- Statistics -->
        <div class="section">
            <div class="section-title"><i class="fas fa-chart-bar"></i> Statistics</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalActivity">0</h3>
                    <p>Total Activities</p>
                </div>
                <div class="stat-card">
                    <h3 id="todayActivity">0</h3>
                    <p>Today's Activities</p>
                </div>
                <div class="stat-card">
                    <h3 id="thisWeekActivity">0</h3>
                    <p>This Week</p>
                </div>
                <div class="stat-card">
                    <h3 id="thisMonthActivity">0</h3>
                    <p>This Month</p>
                </div>
            </div>
        </div>

        <!-- Activity Type Breakdown Chart -->
        <div class="section">
            <div class="section-title"><i class="fas fa-chart-pie"></i> Activity Breakdown by Type</div>
            <div class="chart-container" id="typeChart"></div>
        </div>

        <!-- Hourly Activity Heatmap -->
        <div class="section">
            <div class="section-title"><i class="fas fa-fire"></i> Activity Heatmap (24 Hours)</div>
            <p style="color: #666; font-size: 13px; margin-bottom: 15px;">Track activity patterns throughout the day</p>
            <div class="heatmap" id="activityHeatmap"></div>
            <div class="heatmap-legend">
                <div class="heatmap-legend-item">
                    <div class="heatmap-legend-box" style="background: #e0e0e0;"></div>
                    <span>0</span>
                </div>
                <div class="heatmap-legend-item">
                    <div class="heatmap-legend-box" style="background: #a8d5ff;"></div>
                    <span>1-5</span>
                </div>
                <div class="heatmap-legend-item">
                    <div class="heatmap-legend-box" style="background: #667eea;"></div>
                    <span>6-10</span>
                </div>
                <div class="heatmap-legend-item">
                    <div class="heatmap-legend-box" style="background: #764ba2;"></div>
                    <span>10+</span>
                </div>
            </div>
        </div>

        <!-- Activity Timeline View -->
        <div class="section" id="timelineSection" style="display: none;">
            <div class="section-title"><i class="fas fa-stream"></i> Activity Timeline</div>
            <div class="timeline" id="timeline"></div>
        </div>

        <!-- Activity Table View -->
        <div class="section">
            <div class="section-title"><i class="fas fa-table"></i> Activity Details</div>
            
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Type</th>
                            <th>Activity</th>
                            <th>User/Source</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="logsTableBody">
                        <tr>
                            <td colspan="6">
                                <div class="empty-state">
                                    <i class="fas fa-inbox"></i>
                                    <p>No activities yet</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Failed Login Attempts -->
        <div class="section">
            <div class="section-title"><i class="fas fa-shield-alt"></i> Security Events</div>
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Event</th>
                        <th>IP Address</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="securityLogsBody">
                    <tr>
                        <td colspan="4">
                            <div class="empty-state">
                                <i class="fas fa-lock"></i>
                                <p>No security events</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Live Monitor Badge -->
    <div class="live-badge">
        <div class="live-pulse"></div>
        <span>Live Monitoring Active</span>
    </div>

    <!-- Help Button -->
    <button class="help-btn" onclick="toggleHelp()" title="Help & Usage Guide">
        <i class="fas fa-question"></i>
    </button>

    <!-- Help Panel -->
    <div class="help-panel" id="helpPanel">
        <button class="help-close" onclick="toggleHelp()">
            <i class="fas fa-times"></i>
        </button>
        <h2 style="color: #667eea; margin-bottom: 20px;">üìã Activity Log Guide</h2>
        
        <div class="help-section">
            <h3>üéØ What is Activity Log?</h3>
            <p>Activity Log automatically tracks all actions performed in your A3KM Studio dashboard including uploads, edits, deletions, and login activities.</p>
        </div>

        <div class="help-section">
            <h3>üîç Search & Filter</h3>
            <ul>
                <li><strong>Search:</strong> Type keywords to find specific activities</li>
                <li><strong>Type Filter:</strong> Filter by Upload, Edit, Delete, Login, System</li>
                <li><strong>Date Range:</strong> Select start and end dates to narrow results</li>
                <li><strong>Real-time:</strong> Auto-refreshes every 2 seconds</li>
            </ul>
        </div>

        <div class="help-section">
            <h3>üìä Statistics Dashboard</h3>
            <ul>
                <li><strong>Total Activities:</strong> All recorded actions</li>
                <li><strong>Today's Activities:</strong> Actions from today</li>
                <li><strong>This Week:</strong> Last 7 days of activity</li>
                <li><strong>This Month:</strong> Current month's activity</li>
            </ul>
        </div>

        <div class="help-section">
            <h3>üìà Analytics Features</h3>
            <ul>
                <li><strong>Type Breakdown:</strong> Bar chart showing activity distribution</li>
                <li><strong>Activity Heatmap:</strong> 24-hour activity pattern visualization</li>
                <li><strong>Color codes:</strong> Darker = more activity in that hour</li>
            </ul>
        </div>

        <div class="help-section">
            <h3>üïê Timeline View</h3>
            <ul>
                <li>Click "Timeline View" to see chronological timeline</li>
                <li>Visual indicators for different activity types</li>
                <li>Color-coded: Upload (green), Edit (blue), Delete (red), Login (orange)</li>
            </ul>
        </div>

        <div class="help-section">
            <h3>üíæ Export Options</h3>
            <ul>
                <li><strong>CSV:</strong> Spreadsheet format for Excel/Google Sheets</li>
                <li><strong>JSON:</strong> Developer-friendly structured data</li>
                <li><strong>PDF:</strong> Professional report with charts and summary</li>
            </ul>
        </div>

        <div class="help-section">
            <h3>üîí Security Monitoring</h3>
            <ul>
                <li>Tracks failed login attempts</li>
                <li>Records IP addresses and browser info</li>
                <li>Monitors suspicious activities</li>
                <li>Real-time security alerts</li>
            </ul>
        </div>

        <div class="help-section">
            <h3>‚öôÔ∏è Auto-Logging System</h3>
            <p style="font-size: 13px; color: #666; margin-top: 10px;">Activity Log automatically captures:</p>
            <ul>
                <li>‚úÖ File uploads (books, videos, papers, posts)</li>
                <li>‚úÖ Content edits and modifications</li>
                <li>‚úÖ Deletions and removals</li>
                <li>‚úÖ Settings changes</li>
                <li>‚úÖ Login/logout activities</li>
                <li>‚úÖ System operations (backups, deployments)</li>
            </ul>
        </div>

        <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-top: 20px;">
            <strong>üí° Pro Tips:</strong>
            <ul style="margin-top: 10px; margin-left: 20px; font-size: 13px;">
                <li>Use date filters to audit specific time periods</li>
                <li>Export logs regularly for backup</li>
                <li>Check heatmap to identify peak activity times</li>
                <li>Monitor security events for unauthorized access</li>
            </ul>
        </div>
    </div>

    <!-- Activity Detail Modal -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Activity Details</span>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script src="../../shared/github-token-manager.js"></script>
    <script src="../../shared/activity-logger.js"></script>
    <script>
        const LOGS_STORAGE_KEY = 'a3km_activity_logs';
        const SECURITY_LOGS_KEY = 'a3km_security_logs';
        let tokenManager = null;
        
        let allLogs = [];
        let filteredLogs = [];

        document.addEventListener('DOMContentLoaded', () => {
            tokenManager = typeof GitHubTokenManager !== 'undefined' ? new GitHubTokenManager() : null;
            loadLogs();
            displayLogs();
            updateStatistics();
            renderTypeChart();
            renderActivityHeatmap();
            detectIPAddress();
            
            // Live update every 2 seconds
            setInterval(() => {
                loadLogs();
                displayLogs();
                updateStatistics();
                renderTypeChart();
                renderActivityHeatmap();
            }, 2000);

            // Listen for real-time activity events
            window.addEventListener('activityLogged', () => {
                loadLogs();
                displayLogs();
                updateStatistics();
                renderTypeChart();
                renderActivityHeatmap();
            });

            // Auto-log system start (REAL activity tracking)
            if (typeof ActivityLogger !== 'undefined') {
                ActivityLogger.log('system', 'Activity Log viewer opened', 'Admin', 'success', `IP: ${ActivityLogger.getUserIP()}, Browser: ${ActivityLogger.getBrowserInfo()}`);
            }
        });

        function logActivity(type, activity, user = 'Admin', status = 'success', details = '') {
            // Use ActivityLogger if available, otherwise use legacy method
            if (typeof ActivityLogger !== 'undefined') {
                ActivityLogger.log(type, activity, user, status, details);
            } else {
                // Fallback to direct localStorage (legacy)
                const log = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    type,
                    activity,
                    user,
                    status,
                    details
                };
                
                allLogs.unshift(log);
                localStorage.setItem(LOGS_STORAGE_KEY, JSON.stringify(allLogs));
                displayLogs();
            }
        }

        function loadLogs() {
            allLogs = JSON.parse(localStorage.getItem(LOGS_STORAGE_KEY) || '[]');
            filteredLogs = [...allLogs];
        }

        function filterLogs() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const type = document.getElementById('typeFilter').value;
            const dateFrom = document.getElementById('dateFromFilter').value;
            const dateTo = document.getElementById('dateToFilter').value;

            filteredLogs = allLogs.filter(log => {
                const matchSearch = log.activity.toLowerCase().includes(search) || log.user.toLowerCase().includes(search);
                const matchType = !type || log.type === type;
                const logDate = new Date(log.timestamp).toISOString().split('T')[0];
                const matchDateFrom = !dateFrom || logDate >= dateFrom;
                const matchDateTo = !dateTo || logDate <= dateTo;

                return matchSearch && matchType && matchDateFrom && matchDateTo;
            });

            displayLogs();
        }

        function displayLogs() {
            const tbody = document.getElementById('logsTableBody');
            
            if (filteredLogs.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><i class="fas fa-inbox"></i><p>No activities found</p></div></td></tr>`;
                return;
            }

            tbody.innerHTML = filteredLogs.map(log => {
                const date = new Date(log.timestamp);
                const timeStr = date.toLocaleTimeString();
                const dateStr = date.toLocaleDateString();

                return `
                    <tr>
                        <td title="${dateStr}">${timeStr}</td>
                        <td><span class="badge badge-${log.type}"><i class="fas fa-circle" style="font-size: 8px; margin-right: 5px;"></i>${log.type.charAt(0).toUpperCase() + log.type.slice(1)}</span></td>
                        <td>${log.activity}</td>
                        <td>${log.user}</td>
                        <td><span style="color: #4caf50; font-weight: 600;"><i class="fas fa-check-circle"></i> ${log.status}</span></td>
                        <td><button class="btn" style="background: #667eea; color: white; padding: 4px 12px; font-size: 12px;" onclick="showDetails(${log.id})"><i class="fas fa-eye"></i> View</button></td>
                    </tr>
                `;
            }).join('');
        }

        function showDetails(logId) {
            const log = allLogs.find(l => l.id === logId);
            if (!log) return;

            const date = new Date(log.timestamp);
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div style="display: grid; gap: 15px;">
                    <div>
                        <strong>Activity:</strong>
                        <p style="margin-top: 5px; color: #666;">${log.activity}</p>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <strong>Type:</strong>
                            <p style="margin-top: 5px; color: #666;">${log.type.charAt(0).toUpperCase() + log.type.slice(1)}</p>
                        </div>
                        <div>
                            <strong>User:</strong>
                            <p style="margin-top: 5px; color: #666;">${log.user}</p>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <strong>Date & Time:</strong>
                            <p style="margin-top: 5px; color: #666;">${date.toLocaleString()}</p>
                        </div>
                        <div>
                            <strong>Status:</strong>
                            <p style="margin-top: 5px; color: #4caf50; font-weight: 600;"><i class="fas fa-check-circle"></i> ${log.status}</p>
                        </div>
                    </div>
                    <div>
                        <strong>Details:</strong>
                        <p style="margin-top: 5px; color: #666; background: #f5f5f5; padding: 10px; border-radius: 6px; font-family: monospace;">${log.details || 'No additional details'}</p>
                    </div>
                </div>
            `;

            document.getElementById('detailModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        function updateStatistics() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const monthAgo = new Date(now.getFullYear(), now.getMonth(), 1);

            const todayCount = allLogs.filter(l => new Date(l.timestamp) >= today).length;
            const weekCount = allLogs.filter(l => new Date(l.timestamp) >= weekAgo).length;
            const monthCount = allLogs.filter(l => new Date(l.timestamp) >= monthAgo).length;

            document.getElementById('totalActivity').textContent = allLogs.length;
            document.getElementById('todayActivity').textContent = todayCount;
            document.getElementById('thisWeekActivity').textContent = weekCount;
            document.getElementById('thisMonthActivity').textContent = monthCount;
        }

        function refreshLogs() {
            loadLogs();
            displayLogs();
            updateStatistics();
        }

        function exportLogs(format = 'csv') {
            document.getElementById('exportDropdown').classList.remove('active');
            
            const filename = `activity-log-${new Date().toISOString().split('T')[0]}`;
            
            if (format === 'csv') {
                const csv = [
                    ['Time', 'Type', 'Activity', 'User', 'Status', 'Details'],
                    ...filteredLogs.map(log => [
                        new Date(log.timestamp).toLocaleString(),
                        log.type,
                        log.activity,
                        log.user,
                        log.status,
                        log.details
                    ])
                ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');

                const blob = new Blob([csv], { type: 'text/csv' });
                downloadFile(blob, filename + '.csv');
            } 
            else if (format === 'json') {
                const json = JSON.stringify(filteredLogs, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                downloadFile(blob, filename + '.json');
            }
            else if (format === 'pdf') {
                // Generate PDF report
                generatePDFReport();
            }
        }

        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
            logActivity('system', `Exported activity log as ${filename}`, 'Admin', 'success', `${filteredLogs.length} records exported`);
        }

        function generatePDFReport() {
            // Create HTML for PDF
            const typeStats = {};
            filteredLogs.forEach(log => {
                typeStats[log.type] = (typeStats[log.type] || 0) + 1;
            });

            const reportHTML = `
                <html>
                <head>
                    <title>Activity Log Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 40px; }
                        h1 { color: #667eea; border-bottom: 3px solid #667eea; padding-bottom: 10px; }
                        .summary { background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                        th { background: #667eea; color: white; }
                        .stat { display: inline-block; margin: 10px 20px 10px 0; }
                        .stat strong { color: #667eea; }
                    </style>
                </head>
                <body>
                    <h1>üìã Activity Log Report</h1>
                    <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
                    <p><strong>Total Records:</strong> ${filteredLogs.length}</p>
                    
                    <div class="summary">
                        <h2>Summary Statistics</h2>
                        ${Object.entries(typeStats).map(([type, count]) => 
                            `<div class="stat"><strong>${type.charAt(0).toUpperCase() + type.slice(1)}:</strong> ${count}</div>`
                        ).join('')}
                    </div>

                    <h2>Activity Details</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Type</th>
                                <th>Activity</th>
                                <th>User</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredLogs.map(log => `
                                <tr>
                                    <td>${new Date(log.timestamp).toLocaleString()}</td>
                                    <td>${log.type}</td>
                                    <td>${log.activity}</td>
                                    <td>${log.user}</td>
                                    <td>${log.status}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `;

            const blob = new Blob([reportHTML], { type: 'text/html' });
            downloadFile(blob, `activity-report-${new Date().toISOString().split('T')[0]}.html`);
            alert('üìÑ PDF report generated! Open the HTML file and print to PDF (Ctrl+P) from your browser.');
        }

        function toggleExportMenu() {
            document.getElementById('exportDropdown').classList.toggle('active');
        }

        function toggleTimeline() {
            const timelineSection = document.getElementById('timelineSection');
            if (timelineSection.style.display === 'none') {
                timelineSection.style.display = 'block';
                renderTimeline();
            } else {
                timelineSection.style.display = 'none';
            }
        }

        function renderTimeline() {
            const timeline = document.getElementById('timeline');
            if (filteredLogs.length === 0) {
                timeline.innerHTML = '<div class="empty-state"><i class="fas fa-stream"></i><p>No activities to display</p></div>';
                return;
            }

            timeline.innerHTML = filteredLogs.map(log => {
                const date = new Date(log.timestamp);
                return `
                    <div class="timeline-item ${log.type}">
                        <div class="timeline-content">
                            <div class="timeline-header">
                                <div class="timeline-title">${log.activity}</div>
                                <div class="timeline-time">${date.toLocaleTimeString()}</div>
                            </div>
                            <div class="timeline-description">${log.details || 'No additional details'}</div>
                            <span class="badge badge-${log.type}">${log.type.toUpperCase()}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderTypeChart() {
            const typeStats = {};
            allLogs.forEach(log => {
                typeStats[log.type] = (typeStats[log.type] || 0) + 1;
            });

            const maxCount = Math.max(...Object.values(typeStats), 1);
            const chart = document.getElementById('typeChart');
            
            chart.innerHTML = Object.entries(typeStats).map(([type, count]) => {
                const percentage = (count / maxCount) * 100;
                const colors = {
                    upload: '#4caf50',
                    edit: '#2196f3',
                    delete: '#f44336',
                    login: '#ff9800',
                    system: '#9e9e9e'
                };
                
                return `
                    <div class="chart-bar">
                        <div class="chart-label">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                        <div class="chart-bar-fill" style="width: ${percentage}%; background: ${colors[type] || '#667eea'};">
                            ${count}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderActivityHeatmap() {
            const heatmap = document.getElementById('activityHeatmap');
            const hourCounts = new Array(24).fill(0);
            
            allLogs.forEach(log => {
                const hour = new Date(log.timestamp).getHours();
                hourCounts[hour]++;
            });

            const maxCount = Math.max(...hourCounts, 1);
            
            heatmap.innerHTML = hourCounts.map((count, hour) => {
                let color = '#e0e0e0';
                if (count > 0) color = '#a8d5ff';
                if (count > 5) color = '#667eea';
                if (count > 10) color = '#764ba2';
                
                return `<div class="heatmap-cell" style="background: ${color};" title="${hour}:00 - ${count} activities"></div>`;
            }).join('');
        }

        let userIP = 'Unknown';
        async function detectIPAddress() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                userIP = data.ip;
            } catch (e) {
                userIP = 'Unable to detect';
            }
        }

        function toggleHelp() {
            document.getElementById('helpPanel').classList.toggle('active');
        }

        // Close export menu when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('exportDropdown');
            if (!dropdown.contains(e.target)) {
                dropdown.classList.remove('active');
            }
        });

        function clearLogs() {
            if (!confirm('Clear all activity logs? This cannot be undone.')) return;
            
            if (typeof ActivityLogger !== 'undefined') {
                ActivityLogger.clearLogs();
            } else {
                localStorage.removeItem(LOGS_STORAGE_KEY);
            }
            
            allLogs = [];
            filteredLogs = [];
            displayLogs();
            updateStatistics();
            renderTypeChart();
            renderActivityHeatmap();
        }
    </script>
</body>
</html>
