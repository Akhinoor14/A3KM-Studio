<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- Universal Mobile Optimization System -->
    <link rel="stylesheet" href="../../../Optimization/mobile-universal.css">
    <script src="../../../Optimization/mobile-universal.js" defer></script>

    
    <title>Navigation Menu Editor - A3KM Studio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #1f93ff 0%, #0081cf 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: white; border-radius: 20px; padding: 30px; margin-bottom: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .header h1 { color: #333; font-size: 28px; display: flex; align-items: center; gap: 15px; margin-bottom: 10px; }
        .section { background: white; border-radius: 15px; padding: 25px; margin-bottom: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); }
        .section-title { font-size: 18px; font-weight: 600; color: #333; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; padding-bottom: 15px; border-bottom: 2px solid #1f93ff; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, #1f93ff, #0081cf); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(31, 147, 255, 0.4); }
        .btn-success { background: #4caf50; color: white; }
        .btn-success:hover { background: #45a049; }
        .btn-danger { background: #f44336; color: white; }
        .btn-danger:hover { background: #da190b; }
        .btn-secondary { background: #9e9e9e; color: white; }
        .btn-secondary:hover { background: #757575; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .input-group { margin: 15px 0; }
        .input-group label { display: block; font-weight: 500; color: #333; margin-bottom: 8px; }
        .input-group input, .input-group select { width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
        .input-group input:focus, .input-group select:focus { outline: none; border-color: #1f93ff; background: #f0f7ff; }
        .menu-builder { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .builder-panel { background: #f9f9f9; border-radius: 12px; padding: 20px; border: 2px dashed #1f93ff; }
        .builder-title { font-size: 16px; font-weight: 600; color: #333; margin-bottom: 15px; }
        .menu-item { background: white; border: 2px solid #ddd; border-radius: 8px; padding: 15px; margin: 10px 0; cursor: move; transition: all 0.3s; }
        .menu-item:hover { border-color: #1f93ff; box-shadow: 0 3px 10px rgba(31, 147, 255, 0.2); background: #f0f7ff; }
        .menu-item.selected { border-color: #1f93ff; background: #e3f2fd; }
        .menu-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .menu-item-title { font-weight: 600; color: #333; }
        .menu-item-actions { display: flex; gap: 5px; }
        .menu-item-actions button { padding: 4px 8px; font-size: 12px; }
        .menu-item-details { font-size: 12px; color: #999; }
        .indent { margin-left: 30px; }
        .menu-tree { max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; background: white; padding: 10px; }
        .tree-item { padding: 10px; border-left: 3px solid #e0e0e0; margin: 5px 0; cursor: pointer; border-radius: 4px; }
        .tree-item:hover { background: #f5f5f5; }
        .tree-item.active { background: #e3f2fd; border-left-color: #1f93ff; }
        .tree-item-label { font-weight: 500; color: #333; }
        .tree-item-url { font-size: 12px; color: #999; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .icon-picker { display: grid; grid-template-columns: repeat(auto-fit, minmax(40px, 1fr)); gap: 10px; max-height: 300px; overflow-y: auto; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
        .icon-option { padding: 8px; cursor: pointer; border: 2px solid #ddd; border-radius: 6px; text-align: center; transition: all 0.2s; }
        .icon-option:hover { border-color: #1f93ff; background: #f0f7ff; }
        .icon-option.selected { border-color: #1f93ff; background: #1f93ff; color: white; }
        .status-message { padding: 12px 15px; border-radius: 8px; margin: 15px 0; font-weight: 500; }
        .status-success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .status-error { background: #f8d7da; color: #721c24; border-left: 4px solid #f44336; }
        .status-info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
        .preview { background: linear-gradient(135deg, #1f93ff, #0081cf); color: white; border-radius: 8px; padding: 15px; margin-top: 15px; }
        .preview-nav { display: flex; gap: 20px; list-style: none; }
        .preview-nav li { cursor: pointer; padding: 8px 15px; border-radius: 4px; transition: all 0.3s; }
        .preview-nav li:hover { background: rgba(255,255,255,0.2); }
        @media (max-width: 1024px) {
            .menu-builder { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-bars"></i> Navigation Menu Editor</h1>
            <p>Create, edit, and manage website navigation menus</p>
        </div>

        <!-- Menu Builder -->
        <div class="section">
            <div class="section-title">
                <i class="fas fa-sitemap"></i> Menu Builder
            </div>

            <div class="menu-builder">
                <!-- Menu Tree -->
                <div class="builder-panel">
                    <div class="builder-title">
                        <i class="fas fa-list"></i> Menu Structure
                    </div>
                    <div class="menu-tree" id="menuTree"></div>
                    <button class="btn btn-primary" onclick="addMenuItem()" style="width: 100%; margin-top: 10px;">
                        <i class="fas fa-plus"></i> Add Menu Item
                    </button>
                </div>

                <!-- Item Editor -->
                <div class="builder-panel">
                    <div class="builder-title">
                        <i class="fas fa-edit"></i> Edit Item
                    </div>

                    <div id="editorPanel" style="color: #999; padding: 40px; text-align: center;">
                        <i class="fas fa-hand-pointer" style="font-size: 40px; opacity: 0.5; margin-bottom: 15px;"></i>
                        <p>Select a menu item to edit</p>
                    </div>

                    <div id="editorForm" style="display: none;">
                        <div class="form-grid">
                            <div class="input-group" style="grid-column: 1 / -1;">
                                <label for="itemLabel">Menu Label</label>
                                <input type="text" id="itemLabel" placeholder="Home, About, Services, etc." oninput="updateSelectedItem()">
                            </div>
                            <div class="input-group" style="grid-column: 1 / -1;">
                                <label for="itemUrl">URL</label>
                                <input type="text" id="itemUrl" placeholder="https://example.com/page" oninput="updateSelectedItem()">
                            </div>
                            <div class="input-group">
                                <label for="itemIcon">Icon</label>
                                <input type="text" id="itemIcon" placeholder="fa-home" oninput="updateSelectedItem()">
                            </div>
                            <div class="input-group">
                                <label for="itemTarget">Open In</label>
                                <select id="itemTarget" onchange="updateSelectedItem()">
                                    <option value="_self">Same Tab</option>
                                    <option value="_blank">New Tab</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>
                                    <input type="checkbox" id="itemBadge" onchange="updateSelectedItem()"> Show Badge
                                </label>
                            </div>
                            <div class="input-group">
                                <label for="itemBadgeText">Badge Text</label>
                                <input type="text" id="itemBadgeText" placeholder="e.g., New, Beta" oninput="updateSelectedItem()">
                            </div>
                        </div>

                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
                            <button class="btn btn-danger" onclick="deleteMenuItem()" style="width: 100%;">
                                <i class="fas fa-trash"></i> Delete Item
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Preview -->
            <div class="preview">
                <div style="margin-bottom: 10px; font-weight: 600;">
                    <i class="fas fa-eye"></i> Live Preview
                </div>
                <ul class="preview-nav" id="menuPreview">
                    <li><i class="fas fa-spinner fa-spin"></i> Loading menu...</li>
                </ul>
            </div>
        </div>

        <!-- Menu Management -->
        <div class="section">
            <div class="section-title">
                <i class="fas fa-sliders-h"></i> Menu Management
            </div>

            <div class="form-grid">
                <div class="input-group">
                    <label for="menuSelect">Select Menu</label>
                    <select id="menuSelect" onchange="loadMenuLayout()">
                        <option value="main">Main Navigation</option>
                        <option value="footer">Footer Menu</option>
                        <option value="mobile">Mobile Menu</option>
                        <option value="side">Sidebar Menu</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="menuName">Menu Name</label>
                    <input type="text" id="menuName" placeholder="e.g., Main Navigation">
                </div>
                <div class="input-group">
                    <label for="menuPosition">Display Position</label>
                    <select id="menuPosition">
                        <option value="top">Top Navigation Bar</option>
                        <option value="side">Sidebar</option>
                        <option value="footer">Footer</option>
                        <option value="mobile">Mobile Menu</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="menuAlignment">Alignment</label>
                    <select id="menuAlignment">
                        <option value="left">Left</option>
                        <option value="center">Center</option>
                        <option value="right">Right</option>
                    </select>
                </div>
            </div>

            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveMenu()">
                    <i class="fas fa-save"></i> Save Menu
                </button>
                <button class="btn btn-secondary" onclick="exportMenu()">
                    <i class="fas fa-download"></i> Export Menu
                </button>
                <button class="btn btn-secondary" onclick="importMenu()">
                    <i class="fas fa-upload"></i> Import Menu
                </button>
                <button class="btn btn-danger" onclick="resetMenu()">
                    <i class="fas fa-redo"></i> Reset to Default
                </button>
            </div>

            <div id="manageStatus"></div>
        </div>

        <!-- Icon Selector -->
        <div class="section">
            <div class="section-title">
                <i class="fas fa-icons"></i> Icon Library
            </div>
            <input type="text" id="iconSearch" placeholder="Search icons (e.g., home, menu, user)..." style="width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; margin-bottom: 15px;">
            <div class="icon-picker" id="iconPicker"></div>
        </div>

        <!-- Hidden file input -->
        <input type="file" id="importFile" accept=".json" style="display: none;">
    </div>

    <script src="../../shared/github-token-manager.js"></script>
    <script>
        const MENU_STORAGE_KEY = 'a3km_navigation_menus';
        const ICON_LIBRARY = ['fa-home', 'fa-user', 'fa-cog', 'fa-bell', 'fa-envelope', 'fa-chart-bar', 'fa-folder', 'fa-file', 'fa-image', 'fa-video', 'fa-book', 'fa-download', 'fa-upload', 'fa-share', 'fa-heart', 'fa-star', 'fa-calendar', 'fa-clock', 'fa-map-marker', 'fa-phone', 'fa-globe', 'fa-link', 'fa-code', 'fa-database', 'fa-server', 'fa-cloud', 'fa-lock', 'fa-key', 'fa-shield'];

        let tokenManager = null;
        let currentMenuId = 'main';
        let currentItemId = null;
        let menus = {};

        document.addEventListener('DOMContentLoaded', () => {
            tokenManager = typeof GitHubTokenManager !== 'undefined' ? new GitHubTokenManager() : null;
            loadMenus();
            initIconPicker();
            document.getElementById('importFile').addEventListener('change', e => {
                if (e.target.files[0]) importMenuFile(e.target.files[0]);
            });
            
            // Live update every 5 seconds
            setInterval(() => {
                loadMenus();
                renderMenuTree();
            }, 5000);
        });

        function loadMenus() {
            menus = JSON.parse(localStorage.getItem(MENU_STORAGE_KEY) || '{}');
            if (!menus.main) {
                menus.main = {
                    id: 'main',
                    name: 'Main Navigation',
                    position: 'top',
                    alignment: 'left',
                    items: [
                        { id: 1, label: 'Home', url: '/', icon: 'fa-home', target: '_self' },
                        { id: 2, label: 'About', url: '/about', icon: 'fa-user', target: '_self' },
                        { id: 3, label: 'Projects', url: '/projects', icon: 'fa-folder', target: '_self' }
                    ]
                };
                saveMenus();
            }
            loadMenuLayout();
        }

        function loadMenuLayout() {
            currentMenuId = document.getElementById('menuSelect').value;
            const menu = menus[currentMenuId];
            
            if (!menu) {
                menus[currentMenuId] = {
                    id: currentMenuId,
                    name: currentMenuId.charAt(0).toUpperCase() + currentMenuId.slice(1),
                    position: 'top',
                    alignment: 'left',
                    items: []
                };
            }

            document.getElementById('menuName').value = menus[currentMenuId].name;
            document.getElementById('menuPosition').value = menus[currentMenuId].position;
            document.getElementById('menuAlignment').value = menus[currentMenuId].alignment;

            renderMenuTree();
            renderPreview();
        }

        function renderMenuTree() {
            const menu = menus[currentMenuId];
            const tree = document.getElementById('menuTree');
            tree.innerHTML = '';

            if (!menu.items || menu.items.length === 0) {
                tree.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No items yet. Add one to get started.</div>';
                return;
            }

            menu.items.forEach(item => {
                const div = document.createElement('div');
                div.className = `tree-item ${currentItemId === item.id ? 'active' : ''}`;
                div.onclick = () => selectMenuItem(item.id);
                div.innerHTML = `
                    <div class="tree-item-label">
                        <i class="fas ${item.icon}"></i> ${item.label}
                        ${item.badge ? `<span style="background: #1f93ff; color: white; border-radius: 3px; padding: 2px 6px; font-size: 10px; margin-left: 5px;">${item.badgeText}</span>` : ''}
                    </div>
                    <div class="tree-item-url">${item.url}</div>
                `;
                tree.appendChild(div);
            });
        }

        function selectMenuItem(id) {
            currentItemId = id;
            const menu = menus[currentMenuId];
            const item = menu.items.find(i => i.id === id);

            if (item) {
                document.getElementById('itemLabel').value = item.label;
                document.getElementById('itemUrl').value = item.url;
                document.getElementById('itemIcon').value = item.icon;
                document.getElementById('itemTarget').value = item.target || '_self';
                document.getElementById('itemBadge').checked = item.badge || false;
                document.getElementById('itemBadgeText').value = item.badgeText || '';

                document.getElementById('editorPanel').style.display = 'none';
                document.getElementById('editorForm').style.display = 'block';
            }

            renderMenuTree();
        }

        function addMenuItem() {
            const menu = menus[currentMenuId];
            const newId = Math.max(0, ...menu.items.map(i => i.id)) + 1;
            
            menu.items.push({
                id: newId,
                label: 'New Item',
                url: '#',
                icon: 'fa-link',
                target: '_self',
                badge: false,
                badgeText: ''
            });

            currentItemId = newId;
            selectMenuItem(newId);
            saveMenus();
        }

        function updateSelectedItem() {
            const menu = menus[currentMenuId];
            const item = menu.items.find(i => i.id === currentItemId);

            if (item) {
                item.label = document.getElementById('itemLabel').value;
                item.url = document.getElementById('itemUrl').value;
                item.icon = document.getElementById('itemIcon').value;
                item.target = document.getElementById('itemTarget').value;
                item.badge = document.getElementById('itemBadge').checked;
                item.badgeText = document.getElementById('itemBadgeText').value;

                renderMenuTree();
                renderPreview();
            }
        }

        function deleteMenuItem() {
            if (!confirm('Delete this menu item?')) return;
            
            const menu = menus[currentMenuId];
            menu.items = menu.items.filter(i => i.id !== currentItemId);
            currentItemId = null;

            document.getElementById('editorPanel').style.display = 'block';
            document.getElementById('editorForm').style.display = 'none';

            renderMenuTree();
            renderPreview();
            saveMenus();
        }

        function renderPreview() {
            const menu = menus[currentMenuId];
            const preview = document.getElementById('menuPreview');
            
            if (!menu.items || menu.items.length === 0) {
                preview.innerHTML = '<li style="color: white;">No items in this menu</li>';
                return;
            }

            preview.innerHTML = menu.items.map(item => `
                <li style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas ${item.icon}"></i> 
                    ${item.label}
                    ${item.badge ? `<span style="background: rgba(255,255,255,0.3); padding: 2px 6px; border-radius: 3px; font-size: 11px;">${item.badgeText}</span>` : ''}
                </li>
            `).join('');
        }

        function saveMenu() {
            menus[currentMenuId].name = document.getElementById('menuName').value;
            menus[currentMenuId].position = document.getElementById('menuPosition').value;
            menus[currentMenuId].alignment = document.getElementById('menuAlignment').value;

            saveMenus();
            document.getElementById('manageStatus').innerHTML = '<div class="status-message status-success"><i class="fas fa-check-circle"></i> Menu saved successfully!</div>';
        }

        function saveMenus() {
            localStorage.setItem(MENU_STORAGE_KEY, JSON.stringify(menus));
        }

        function exportMenu() {
            const menu = menus[currentMenuId];
            const dataStr = JSON.stringify(menu, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `menu-${currentMenuId}-${Date.now()}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function importMenu() {
            document.getElementById('importFile').click();
        }

        function importMenuFile(file) {
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const menuData = JSON.parse(e.target.result);
                    menus[menuData.id] = menuData;
                    saveMenus();
                    loadMenuLayout();
                    document.getElementById('manageStatus').innerHTML = '<div class="status-message status-success"><i class="fas fa-check-circle"></i> Menu imported successfully!</div>';
                } catch (error) {
                    document.getElementById('manageStatus').innerHTML = `<div class="status-message status-error"><i class="fas fa-times-circle"></i> Error: ${error.message}</div>`;
                }
            };
            reader.readAsText(file);
        }

        function resetMenu() {
            if (!confirm('Reset menu to default? This cannot be undone.')) return;
            delete menus[currentMenuId];
            saveMenus();
            loadMenus();
            document.getElementById('manageStatus').innerHTML = '<div class="status-message status-success"><i class="fas fa-check-circle"></i> Menu reset to default!</div>';
        }

        function initIconPicker() {
            const picker = document.getElementById('iconPicker');
            renderIcons(ICON_LIBRARY);

            document.getElementById('iconSearch').addEventListener('input', e => {
                const filtered = ICON_LIBRARY.filter(icon => icon.includes(e.target.value.toLowerCase()));
                renderIcons(filtered);
            });
        }

        function renderIcons(icons) {
            const picker = document.getElementById('iconPicker');
            picker.innerHTML = icons.map(icon => `
                <div class="icon-option ${document.getElementById('itemIcon').value === icon ? 'selected' : ''}" onclick="selectIcon('${icon}')">
                    <i class="fas ${icon}" style="font-size: 20px;"></i>
                </div>
            `).join('');
        }

        function selectIcon(icon) {
            document.getElementById('itemIcon').value = icon;
            if (currentItemId) updateSelectedItem();
            renderIcons(ICON_LIBRARY);
        }
    </script>
</body>
</html>
