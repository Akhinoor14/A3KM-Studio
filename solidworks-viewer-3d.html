<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SOLIDWORKS 3D Viewer - A3KM Studio</title>
  <link rel="icon" href="favicon.svg" type="image/svg+xml" />
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="shared/model-viewer.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #0a0a0a 0%, #1a0505 100%);
      color: #ffffff;
      font-family: 'Inter', sans-serif;
      overflow-x: hidden;
    }

    .viewer-container {
      max-width: 100vw;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Top Navigation Bar */
    .top-nav {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(204, 0, 0, 0.2);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
    }

    .nav-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 0.9rem;
    }

    .back-btn:hover {
      background: rgba(204, 0, 0, 0.15);
      border-color: rgba(204, 0, 0, 0.4);
      color: #CC0000;
    }

    .model-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: #ffffff;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .model-badge {
      padding: 4px 12px;
      background: linear-gradient(135deg, #CC0000, #990000);
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      color: white;
      box-shadow: 0 2px 8px rgba(204, 0, 0, 0.4);
    }

    .nav-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .nav-btn {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      color: rgba(255, 255, 255, 0.8);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }

    .nav-btn:hover {
      background: rgba(204, 0, 0, 0.15);
      border-color: rgba(204, 0, 0, 0.4);
      color: #CC0000;
    }

    .nav-btn.primary {
      background: linear-gradient(135deg, #CC0000, #990000);
      border-color: rgba(204, 0, 0, 0.4);
      color: white;
    }

    .nav-btn.primary:hover {
      background: linear-gradient(135deg, #E60000, #CC0000);
      box-shadow: 0 4px 16px rgba(204, 0, 0, 0.4);
    }

    /* Main 3D Viewer Section */
    .viewer-main {
      flex: 1;
      display: flex;
      background: #0a0a0a;
      position: relative;
    }

    .viewer-3d-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      min-height: calc(100vh - 120px);
    }

    #main-model-viewer {
      width: 100%;
      height: 100%;
      min-height: 600px;
      background: radial-gradient(circle at center, rgba(204, 0, 0, 0.05), transparent);
      border-radius: 16px;
      box-shadow: 0 8px 40px rgba(0, 0, 0, 0.5);
    }

    /* Loading State */
    .viewer-loading {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(10, 10, 10, 0.9);
      backdrop-filter: blur(10px);
      z-index: 10;
    }

    .viewer-loading i {
      font-size: 3rem;
      color: #CC0000;
      animation: spin 1s linear infinite;
    }

    .viewer-loading p {
      margin-top: 16px;
      font-size: 1.1rem;
      color: rgba(255, 255, 255, 0.7);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Model Navigation Controls */
    .model-nav-controls {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 16px;
      background: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(20px);
      padding: 16px 24px;
      border-radius: 50px;
      border: 1px solid rgba(204, 0, 0, 0.3);
      box-shadow: 0 8px 40px rgba(0, 0, 0, 0.6);
      z-index: 100;
    }

    .nav-control-btn {
      width: 48px;
      height: 48px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      color: rgba(255, 255, 255, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1.2rem;
    }

    .nav-control-btn:hover:not(:disabled) {
      background: rgba(204, 0, 0, 0.2);
      border-color: rgba(204, 0, 0, 0.4);
      color: #CC0000;
      transform: scale(1.1);
    }

    .nav-control-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .model-counter {
      padding: 8px 20px;
      background: rgba(204, 0, 0, 0.15);
      border: 1px solid rgba(204, 0, 0, 0.3);
      border-radius: 30px;
      font-weight: 700;
      color: #CC0000;
      font-size: 0.95rem;
      min-width: 100px;
      text-align: center;
    }

    /* Model Info Sidebar (Optional Toggle) */
    .model-info-sidebar {
      position: fixed;
      right: 0;
      top: 76px;
      width: 320px;
      height: calc(100vh - 76px);
      background: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(20px);
      border-left: 1px solid rgba(204, 0, 0, 0.2);
      padding: 24px;
      overflow-y: auto;
      transform: translateX(100%);
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 50;
    }

    .model-info-sidebar.visible {
      transform: translateX(0);
    }

    .info-section {
      margin-bottom: 24px;
    }

    .info-section h3 {
      font-size: 1.1rem;
      font-weight: 700;
      color: #CC0000;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      font-size: 0.9rem;
    }

    .info-label {
      color: rgba(255, 255, 255, 0.6);
    }

    .info-value {
      color: rgba(255, 255, 255, 0.9);
      font-weight: 600;
    }

    .file-list {
      list-style: none;
    }

    .file-list li {
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
      margin-bottom: 6px;
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.8);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .file-list li i {
      color: #CC0000;
      font-size: 0.75rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .top-nav {
        padding: 12px 16px;
      }

      .model-title {
        font-size: 1rem;
      }

      .model-title .model-badge {
        display: none;
      }

      .nav-right .nav-btn span {
        display: none;
      }

      .viewer-3d-container {
        padding: 16px;
      }

      #main-model-viewer {
        min-height: 400px;
      }

      .model-nav-controls {
        bottom: 16px;
        padding: 12px 16px;
        gap: 12px;
      }

      .nav-control-btn {
        width: 40px;
        height: 40px;
        font-size: 1rem;
      }

      .model-counter {
        min-width: 80px;
        font-size: 0.85rem;
        padding: 6px 16px;
      }

      .model-info-sidebar {
        width: 100%;
        top: auto;
        bottom: 0;
        height: 70vh;
        transform: translateY(100%);
      }

      .model-info-sidebar.visible {
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>

  <div class="viewer-container">
    <!-- Top Navigation -->
    <nav class="top-nav">
      <div class="nav-left">
        <a href="solidworks-basic.html" class="back-btn">
          <i class="fas fa-arrow-left"></i>
          <span>Back to Gallery</span>
        </a>
        <div class="model-title">
          <i class="fas fa-cube" style="color: #CC0000;"></i>
          <span id="current-model-name">Loading Model...</span>
          <span class="model-badge">BASIC</span>
        </div>
      </div>
      <div class="nav-right">
        <button class="nav-btn" onclick="toggleInfo()" title="Model Information">
          <i class="fas fa-info-circle"></i>
          <span>Info</span>
        </button>
        <button class="nav-btn primary" onclick="downloadModel()" title="Download Model ZIP">
          <i class="fas fa-download"></i>
          <span>Download ZIP</span>
        </button>
      </div>
    </nav>

    <!-- Main 3D Viewer -->
    <div class="viewer-main">
      <div class="viewer-3d-container">
        <!-- Loading State -->
        <div class="viewer-loading" id="loading-state">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Loading 3D Model...</p>
        </div>

        <!-- Model Viewer (Google model-viewer) -->
        <model-viewer
          id="main-model-viewer"
          camera-controls
          auto-rotate
          auto-rotate-delay="2000"
          rotation-per-second="30deg"
          touch-action="pan-y"
          ar
          ar-modes="webxr scene-viewer quick-look"
          shadow-intensity="1"
          exposure="1"
          environment-image="neutral"
          loading="eager"
          reveal="auto"
        >
          <div slot="poster" style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(204, 0, 0, 0.05);">
            <div style="text-align: center;">
              <i class="fas fa-cube" style="font-size: 3rem; color: #CC0000; margin-bottom: 12px;"></i>
              <p style="color: rgba(255, 255, 255, 0.7);">Loading 3D Model...</p>
            </div>
          </div>
          
          <div slot="error" style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;">
            <div style="text-align: center;">
              <i class="fas fa-exclamation-triangle" style="font-size: 2.5rem; color: #ff4444; margin-bottom: 12px;"></i>
              <p style="color: rgba(255, 255, 255, 0.8); font-size: 1.1rem;">Failed to load 3D model</p>
              <p style="color: rgba(255, 255, 255, 0.5); font-size: 0.9rem; margin-top: 8px;">GLB file not found or invalid format</p>
            </div>
          </div>
        </model-viewer>
      </div>

      <!-- Model Info Sidebar -->
      <div class="model-info-sidebar" id="info-sidebar">
        <div class="info-section">
          <h3><i class="fas fa-info-circle"></i> Model Details</h3>
          <div class="info-item">
            <span class="info-label">Model Number:</span>
            <span class="info-value" id="info-model-num">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">Category:</span>
            <span class="info-value">Basic Practice</span>
          </div>
          <div class="info-item">
            <span class="info-label">Format:</span>
            <span class="info-value">GLB (3D Model)</span>
          </div>
        </div>

        <div class="info-section">
          <h3><i class="fas fa-folder-open"></i> Files Included</h3>
          <ul class="file-list" id="file-list">
            <li><i class="fas fa-file"></i> Loading files...</li>
          </ul>
        </div>

        <div class="info-section">
          <h3><i class="fas fa-lightbulb"></i> Viewer Controls</h3>
          <ul class="file-list">
            <li><i class="fas fa-mouse"></i> <strong>Click + Drag:</strong> Rotate model</li>
            <li><i class="fas fa-arrows-alt"></i> <strong>Scroll:</strong> Zoom in/out</li>
            <li><i class="fas fa-sync"></i> <strong>Auto-rotate:</strong> Enabled by default</li>
            <li><i class="fas fa-mobile"></i> <strong>AR Mode:</strong> Available on mobile</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Bottom Navigation Controls -->
    <div class="model-nav-controls">
      <button class="nav-control-btn" id="prev-btn" onclick="previousModel()" title="Previous Model">
        <i class="fas fa-chevron-left"></i>
      </button>
      
      <div class="model-counter">
        <span id="current-index">1</span> / <span id="total-models">35</span>
      </div>
      
      <button class="nav-control-btn" id="next-btn" onclick="nextModel()" title="Next Model">
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>
  </div>

  <script src="shared/model-viewer.js"></script>
  <script>
    // Category configuration
    const CATEGORIES = {
      basic: { name: 'Basic', path: 'Solidwork Projects/Basic (Practice) Models', color: '#CC0000' },
      intermediate: { name: 'Intermediate', path: 'Solidwork Projects/Intermediate (Practice) Models', color: '#CC0000' },
      pro: { name: 'Pro', path: 'Solidwork Projects/Pro (Practice) Models', color: '#FFD700' },
      paid: { name: 'Paid', path: 'Solidwork Projects/Paid (Selled) Models', color: '#00FF00' }
    };
    
    let currentCategory = 'basic';
    let models = [];
    
    // Load models dynamically based on category
    async function loadModelsForCategory(category) {
      const categoryConfig = CATEGORIES[category];
      if (!categoryConfig) return [];
      
      try {
        const response = await fetch(`https://api.github.com/repos/Akhinoor14/A3KM-Studio/contents/${encodeURIComponent(categoryConfig.path)}`, {
          headers: { 'Accept': 'application/vnd.github.v3+json' }
        });
        
        if (!response.ok) return [];
        
        const contents = await response.json();
        const modelFolders = contents.filter(item => item.type === 'dir' && item.name.match(/^Model \\d+$/)).sort((a, b) => {
          const numA = parseInt(a.name.match(/\\d+/)[0]);
          const numB = parseInt(b.name.match(/\\d+/)[0]);
          return numA - numB;
        });
        
        const loadedModels = [];
        for (const folder of modelFolders) {
          const num = parseInt(folder.name.match(/\\d+/)[0]);
          const filesResponse = await fetch(folder.url, { headers: { 'Accept': 'application/vnd.github.v3+json' } });
          const files = await filesResponse.json();
          loadedModels.push({
            num,
            name: folder.name,
            path: `${categoryConfig.path}/${folder.name}/`,
            files: files.map(f => f.name)
          });
        }
        return loadedModels;
      } catch (error) {
        console.error('Error loading models:', error);
        return [];
      }
    }
    
    // Static fallback for Basic (in case API fails)
    const basicModelsStatic = [
      { num: 1, name: 'Model 01', path: 'Solidwork Projects/Basic (Practice) Models/Model 01/', files: ['cw2.SLDPRT', 'README.md'] },
      { num: 2, name: 'Model 02', path: 'Solidwork Projects/Basic (Practice) Models/Model 02/', files: ['cWW1.SLDPRT', 'README.md'] },
      { num: 3, name: 'Model 03', path: 'Solidwork Projects/Basic (Practice) Models/Model 03/', files: ['cw 3 DAY 02, 01.SLDPRT', 'README.md'] },
      { num: 4, name: 'Model 04', path: 'Solidwork Projects/Basic (Practice) Models/Model 04/', files: ['cw 01, day 03.SLDPRT', 'README.md'] },
      { num: 5, name: 'Model 05', path: 'Solidwork Projects/Basic (Practice) Models/Model 05/', files: ['cw 01.SLDPRT', 'README.md'] },
      { num: 6, name: 'Model 06', path: 'Solidwork Projects/Basic (Practice) Models/Model 06/', files: ['cw  DAY 02, 02.SLDPRT', 'README.md'] },
      { num: 7, name: 'Model 07', path: 'Solidwork Projects/Basic (Practice) Models/Model 07/', files: ['cw 02, day 03.SLDPRT', 'README.md'] },
      { num: 8, name: 'Model 08', path: 'Solidwork Projects/Basic (Practice) Models/Model 08/', files: ['assembly.SLDASM', 'basket.SLDPRT', 'Multiple parts'] },
      { num: 9, name: 'Model 09', path: 'Solidwork Projects/Basic (Practice) Models/Model 09/', files: ['cw 02.SLDPRT', 'README.md'] },
      { num: 10, name: 'Model 10', path: 'Solidwork Projects/Basic (Practice) Models/Model 10/', files: ['day 6 assembly.SLDASM', '2 parts', 'README.md'] },
      { num: 11, name: 'Model 11', path: 'Solidwork Projects/Basic (Practice) Models/Model 11/', files: ['Assem1 day 7.SLDASM', '9 parts', 'README.md'] },
      { num: 12, name: 'Model 12', path: 'Solidwork Projects/Basic (Practice) Models/Model 12/', files: ['day 6 cw 2 assembly.SLDASM', '6 parts', 'README.md'] },
      { num: 13, name: 'Model 13', path: 'Solidwork Projects/Basic (Practice) Models/Model 13/', files: ['cw 2.SLDPRT', 'README.md'] },
      { num: 14, name: 'Model 14', path: 'Solidwork Projects/Basic (Practice) Models/Model 14/', files: ['day 6 hw Assem.SLDASM', '5 parts', 'README.md'] },
      { num: 15, name: 'Model 15', path: 'Solidwork Projects/Basic (Practice) Models/Model 15/', files: ['day 5 cw 1.SLDPRT', 'README.md'] },
      { num: 16, name: 'Model 16', path: 'Solidwork Projects/Basic (Practice) Models/Model 16/', files: ['day 7 hw 1.SLDPRT'] },
      { num: 17, name: 'Model 17', path: 'Solidwork Projects/Basic (Practice) Models/Model 17/', files: ['CW091accordingtolecture.SLDPRT'] },
      { num: 18, name: 'Model 18', path: 'Solidwork Projects/Basic (Practice) Models/Model 18/', files: ['day 8 hw 1.SLDPRT'] },
      { num: 19, name: 'Model 19', path: 'Solidwork Projects/Basic (Practice) Models/Model 19/', files: ['cw 2.SLDPRT'] },
      { num: 20, name: 'Model 20', path: 'Solidwork Projects/Basic (Practice) Models/Model 20/', files: ['SLDPRT file'] },
      { num: 21, name: 'Model 21', path: 'Solidwork Projects/Basic (Practice) Models/Model 21/', files: ['SLDPRT file'] },
      { num: 22, name: 'Model 22', path: 'Solidwork Projects/Basic (Practice) Models/Model 22/', files: ['SLDPRT file'] },
      { num: 23, name: 'Model 23', path: 'Solidwork Projects/Basic (Practice) Models/Model 23/', files: ['SLDPRT file'] },
      { num: 24, name: 'Model 24', path: 'Solidwork Projects/Basic (Practice) Models/Model 24/', files: ['SLDPRT file'] },
      { num: 25, name: 'Model 25', path: 'Solidwork Projects/Basic (Practice) Models/Model 25/', files: ['SLDPRT file'] },
      { num: 26, name: 'Model 26', path: 'Solidwork Projects/Basic (Practice) Models/Model 26/', files: ['SLDPRT file'] },
      { num: 27, name: 'Model 27', path: 'Solidwork Projects/Basic (Practice) Models/Model 27/', files: ['SLDPRT file'] },
      { num: 28, name: 'Model 28', path: 'Solidwork Projects/Basic (Practice) Models/Model 28/', files: ['SLDPRT file'] },
      { num: 29, name: 'Model 29', path: 'Solidwork Projects/Basic (Practice) Models/Model 29/', files: ['SLDPRT file'] },
      { num: 30, name: 'Model 30', path: 'Solidwork Projects/Basic (Practice) Models/Model 30/', files: ['SLDPRT file'] },
      { num: 31, name: 'Model 31', path: 'Solidwork Projects/Basic (Practice) Models/Model 31/', files: ['SLDPRT file'] },
      { num: 32, name: 'Model 32', path: 'Solidwork Projects/Basic (Practice) Models/Model 32/', files: ['SLDPRT file'] },
      { num: 33, name: 'Model 33', path: 'Solidwork Projects/Basic (Practice) Models/Model 33/', files: ['SLDPRT file'] },
      { num: 34, name: 'Model 34', path: 'Solidwork Projects/Basic (Practice) Models/Model 34/', files: ['SLDPRT file'] },
      { num: 35, name: 'Model 35', path: 'Solidwork Projects/Basic (Practice) Models/Model 35/', files: ['SLDPRT file'] }
    ];

    let currentModelIndex = 0;

    // Get category and model from URL
    function getParamsFromURL() {
      const params = new URLSearchParams(window.location.search);
      const category = params.get('category') || 'basic';
      const modelNum = parseInt(params.get('model')) || 1;
      return { category, modelNum };
    }
    
    function getModelIndexFromNumber(modelNum) {
      return models.findIndex(m => m.num === modelNum);
    }

    // Check if GLB file exists in model folder
    async function checkGLBExists(modelPath) {
      try {
        // Try common GLB names
        const possibleNames = [
          'model.glb', 'Model.glb', 'MODEL.glb',
          `Model ${String(modelPath.match(/Model (\d+)/)?.[1]).padStart(2, '0')} Basic.glb`,
          'main.glb', 'export.glb'
        ];
        
        for (const filename of possibleNames) {
          const testPath = `./${modelPath}${filename}`;
          const response = await fetch(testPath, { method: 'HEAD' });
          if (response.ok) {
            return testPath;
          }
        }
        return null;
      } catch {
        return null;
      }
    }
    
    // Load and display current model
    async function loadModel(index) {
      const model = models[index];
      const modelViewer = document.getElementById('main-model-viewer');
      const loading = document.getElementById('loading-state');
      
      // Update UI
      document.getElementById('current-model-name').textContent = model.name;
      document.getElementById('current-index').textContent = index + 1;
      document.getElementById('info-model-num').textContent = `Model ${model.num}`;
      
      // Check for GLB file
      loading.style.display = 'flex';
      loading.innerHTML = '<div style="text-align: center;"><i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: #CC0000; margin-bottom: 16px;"></i><p style="font-size: 1.1rem;">Checking for 3D model...</p></div>';
      
      const glbPath = await checkGLBExists(model.path);
      
      if (glbPath) {
        // GLB found - load it
        modelViewer.src = glbPath;
        loading.innerHTML = '<div style="text-align: center;"><i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: #CC0000; margin-bottom: 16px;"></i><p style="font-size: 1.1rem;">Loading 3D model...</p></div>';
      } else {
        // No GLB - show message
        loading.style.display = 'flex';
        loading.innerHTML = `
          <div style="text-align: center; max-width: 500px; padding: 40px;">
            <i class="fas fa-cube" style="font-size: 4rem; color: rgba(204, 0, 0, 0.3); margin-bottom: 24px;"></i>
            <h3 style="color: #CC0000; font-size: 1.5rem; margin-bottom: 16px;">3D Model Not Available</h3>
            <p style="color: rgba(255,255,255,0.7); font-size: 1rem; line-height: 1.8; margin-bottom: 24px;">
              This model doesn't have a GLB/GLTF file yet. The original SOLIDWORKS files (.SLDPRT, .SLDASM) are available in the Files section.
            </p>
            <a href="${model.path}" style="display: inline-flex; align-items: center; gap: 10px; padding: 14px 28px; background: linear-gradient(135deg, #CC0000, #990000); border-radius: 10px; color: #fff; text-decoration: none; font-weight: 600;">
              <i class="fas fa-folder-open"></i>
              View Files
            </a>
          </div>
        `;
        modelViewer.style.display = 'none';
        return;
      }
      
      modelViewer.style.display = 'block';
      
      // Update file list
      const fileList = document.getElementById('file-list');
      fileList.innerHTML = model.files.map(file => 
        `<li><i class="fas fa-file"></i> ${file}</li>`
      ).join('');
      
      // Update navigation buttons
      document.getElementById('prev-btn').disabled = (index === 0);
      document.getElementById('next-btn').disabled = (index === models.length - 1);
      
      // Show loading
      loading.style.display = 'flex';
      
      // Try to load GLB file (assuming GLB files are in same folder as SLDPRT)
      const glbPath = `${model.path}${model.name}.glb`;
      modelViewer.src = glbPath;
      
      // Update URL without reload
      const newUrl = `${window.location.pathname}?model=${model.num}`;
      window.history.pushState({ modelIndex: index }, '', newUrl);
      
      // Hide loading when model loads
      modelViewer.addEventListener('load', () => {
        loading.style.display = 'none';
      }, { once: true });
      
      // Handle error (GLB not found)
      modelViewer.addEventListener('error', () => {
        loading.style.display = 'none';
        console.warn(`GLB file not found: ${glbPath}`);
      }, { once: true });
    }

    // Navigation functions
    function previousModel() {
      if (currentModelIndex > 0) {
        currentModelIndex--;
        loadModel(currentModelIndex);
      }
    }

    function nextModel() {
      if (currentModelIndex < models.length - 1) {
        currentModelIndex++;
        loadModel(currentModelIndex);
      }
    }

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') previousModel();
      if (e.key === 'ArrowRight') nextModel();
    });

    // Download model files as ZIP
    async function downloadModel() {
      const model = models[currentModelIndex];
      const downloadBtn = event.target.closest('button');
      const originalHTML = downloadBtn.innerHTML;
      
      try {
        downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Creating ZIP...</span>';
        downloadBtn.disabled = true;
        
        const zip = new JSZip();
        const folder = zip.folder(model.name);
        
        // Fetch all files from model directory
        const response = await fetch(`https://api.github.com/repos/Akhinoor14/A3KM-Studio/contents/${encodeURIComponent(model.path)}`, {
          headers: { 'Accept': 'application/vnd.github.v3+json' }
        });
        
        if (!response.ok) throw new Error('Failed to fetch files');
        
        const files = await response.json();
        let downloadedFiles = 0;
        
        // Download each file
        for (const file of files) {
          if (file.type === 'file') {
            downloadBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> <span>Downloading ${file.name}...</span>`;
            
            const fileResponse = await fetch(file.download_url);
            const fileBlob = await fileResponse.blob();
            folder.file(file.name, fileBlob);
            downloadedFiles++;
          }
        }
        
        // Generate ZIP
        downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Generating ZIP...</span>';
        const zipBlob = await zip.generateAsync({ type: 'blob' });
        
        // Trigger download
        const url = URL.createObjectURL(zipBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${model.name}.zip`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        // Success
        downloadBtn.innerHTML = '<i class="fas fa-check"></i> <span>Downloaded!</span>';
        setTimeout(() => {
          downloadBtn.innerHTML = originalHTML;
          downloadBtn.disabled = false;
        }, 2000);
        
      } catch (error) {
        console.error('Download error:', error);
        alert('Failed to download files. Please try again or download directly from GitHub.');
        downloadBtn.innerHTML = originalHTML;
        downloadBtn.disabled = false;
      }
    }

    // Toggle info sidebar
    function toggleInfo() {
      const sidebar = document.getElementById('info-sidebar');
      sidebar.classList.toggle('visible');
    }

    // Initialize on load
    window.addEventListener('DOMContentLoaded', async () => {
      const params = getParamsFromURL();
      currentCategory = params.category;
      
      document.title = `SOLIDWORKS ${CATEGORIES[currentCategory].name} 3D Viewer`;
      
      models = await loadModelsForCategory(currentCategory);
      if (models.length === 0 && currentCategory === 'basic') models = basicModelsStatic;
      
      if (models.length === 0) {
        document.getElementById('loading-state').innerHTML = '<div style=\"text-align: center; padding: 40px;\"><i class=\"fas fa-exclamation-circle\" style=\"font-size: 3rem; color: #CC0000; margin-bottom: 16px;\"></i><p style=\"font-size: 1.2rem; color: #fff;\">No models in this category.</p><a href=\"solidworks-desktop.html\" style=\"color: #CC0000; text-decoration: underline;\">Back to Categories</a></div>';
        return;
      }
      
      currentModelIndex = getModelIndexFromNumber(params.modelNum);
      if (currentModelIndex === -1) currentModelIndex = 0;
      
      document.getElementById('total-models').textContent = models.length;
      await loadModel(currentModelIndex);
      
      window.addEventListener('popstate', async (event) => {
        if (event.state && typeof event.state.modelIndex === 'number') {
          currentModelIndex = event.state.modelIndex;
          await loadModel(currentModelIndex);
        }
      });
    });
  </script>

</body>
</html>
